"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[627],{5276:function(a,b,c){c.d(b,{N8:function(){return Bv},S1:function(){return vv},jM:function(){return uv},iH:function(){return Xu}});var d,e,f,g,h=c(2238),i=c(8463),j=c(4444),k=c(3333),l=c(4155);let m="";class n{constructor(o){this.domStorage_=o,this.prefix_="firebase:"}set(p,q){null==q?this.domStorage_.removeItem(this.prefixedName_(p)):this.domStorage_.setItem(this.prefixedName_(p),(0,j.Pz)(q))}get(r){const s=this.domStorage_.getItem(this.prefixedName_(r));return null==s?null:(0,j.cI)(s)}remove(t){this.domStorage_.removeItem(this.prefixedName_(t))}prefixedName_(u){return this.prefix_+u}toString(){return this.domStorage_.toString()}}class v{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(w,x){null==x?delete this.cache_[w]:this.cache_[w]=x}get(y){return(0,j.r3)(this.cache_,y)?this.cache_[y]:null}remove(z){delete this.cache_[z]}}const A=function(a){try{if("undefined"!=typeof window&& void 0!==window[a]){const b=window[a];return b.setItem("firebase:sentinel","cache"),b.removeItem("firebase:sentinel"),new n(b)}}catch(c){}return new v()},B=A("localStorage"),C=A("sessionStorage"),D=new k.Yd("@firebase/database");let E;const F=(E=1,function(){return E++}),G=function(a){const b=(0,j.dS)(a),c=new j.gQ();c.update(b);const d=c.digest();return j.US.encodeByteArray(d)},H=function(...a){let b="";for(let c=0;c<a.length;c++){const d=a[c];Array.isArray(d)||d&&"object"==typeof d&&"number"==typeof d.length?b+=H.apply(null,d):"object"==typeof d?b+=(0,j.Pz)(d):b+=d,b+=" "}return b};let I=null,J=!0;const K=function(a,b){(0,j.hu)(!b|| !0===a|| !1===a,"Can't turn on custom loggers persistently."),!0===a?(D.logLevel=k.in.VERBOSE,I=D.log.bind(D),b&&C.set("logging_enabled",!0)):"function"==typeof a?I=a:(I=null,C.remove("logging_enabled"))},L=function(...a){if(!0===J&&(J=!1,null===I&& !0===C.get("logging_enabled")&&K(!0)),I){const b=H.apply(null,a);I(b)}},M=function(a){return function(...b){L(a,...b)}},N=function(...a){const b="FIREBASE INTERNAL ERROR: "+H(...a);D.error(b)},O=function(...a){const b=`FIREBASE FATAL ERROR: ${H(...a)}`;throw D.error(b),new Error(b)},P=function(...a){const b="FIREBASE WARNING: "+H(...a);D.warn(b)},Q=function(){"undefined"!=typeof window&&window.location&&window.location.protocol&& -1!==window.location.protocol.indexOf("https:")&&P("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},R=function(a){return"number"==typeof a&&(a!=a||a===Number.POSITIVE_INFINITY||a===Number.NEGATIVE_INFINITY)},S=function(a){if((0,j.Yr)()||"complete"===document.readyState)a();else{let b=!1;const c=function(){if(!document.body){setTimeout(c,Math.floor(10));return}b||(b=!0,a())};document.addEventListener?(document.addEventListener("DOMContentLoaded",c,!1),window.addEventListener("load",c,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{"complete"===document.readyState&&c()}),window.attachEvent("onload",c))}},T=function(a,b){if(a===b)return 0;{if("[MIN_NAME]"===a||"[MAX_NAME]"===b)return -1;if("[MIN_NAME]"===b||"[MAX_NAME]"===a)return 1;const c=$(a),d=$(b);return null!==c?null!==d?c-d==0?a.length-b.length:c-d:-1:null!==d?1:a<b?-1:1}},U=function(a,b){if(b&&a in b)return b[a];throw new Error("Missing required key ("+a+") in object: "+(0,j.Pz)(b))},V=function(a){if("object"!=typeof a||null===a)return(0,j.Pz)(a);const b=[];for(const c in a)b.push(c);b.sort();let d="{";for(let e=0;e<b.length;e++)0!==e&&(d+=","),d+=(0,j.Pz)(b[e]),d+=":",d+=V(a[b[e]]);return d+="}"},W=function(a,b){const c=a.length;if(c<=b)return[a];const d=[];for(let e=0;e<c;e+=b)e+b>c?d.push(a.substring(e,c)):d.push(a.substring(e,e+b));return d};function X(a,b){for(const c in a)a.hasOwnProperty(c)&&b(c,a[c])}const Y=function(a){(0,j.hu)(!R(a),"Invalid JSON number");const b=1023;let c,d,e,f,g;0===a?(d=0,e=0,c=1/a== -1/0?1:0):(c=a<0,a=Math.abs(a),a>=Math.pow(2,1-b)?(d=(f=Math.min(Math.floor(Math.log(a)/Math.LN2),b))+b,e=Math.round(a*Math.pow(2,52-f)-4503599627370496)):(d=0,e=Math.round(a/Math.pow(2,1-b-52))));const h=[];for(g=52;g;g-=1)h.push(e%2?1:0),e=Math.floor(e/2);for(g=11;g;g-=1)h.push(d%2?1:0),d=Math.floor(d/2);h.push(c?1:0),h.reverse();const i=h.join("");let k="";for(g=0;g<64;g+=8){let l=parseInt(i.substr(g,8),2).toString(16);1===l.length&&(l="0"+l),k+=l}return k.toLowerCase()},Z=new RegExp("^-?(0*)\\d{1,10}$"),$=function(a){if(Z.test(a)){const b=Number(a);if(b>= -2147483648&&b<=2147483647)return b}return null},_=function(a){try{a()}catch(b){setTimeout(()=>{const a=b.stack||"";throw P("Exception was thrown by user callback.",a),b},Math.floor(0))}},aa=function(){const a="object"==typeof window&&window.navigator&&window.navigator.userAgent||"";return a.search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},ba=function(a,b){const c=setTimeout(a,b);return"object"==typeof c&&c.unref&&c.unref(),c};class ca{constructor(da,ea){this.appName_=da,this.appCheckProvider=ea,this.appCheck=null==ea?void 0:ea.getImmediate({optional:!0}),this.appCheck||null==ea||ea.get().then(a=>this.appCheck=a)}getToken(fa){return this.appCheck?this.appCheck.getToken(fa):new Promise((a,b)=>{setTimeout(()=>{this.appCheck?this.getToken(fa).then(a,b):a(null)},0)})}addTokenChangeListener(ga){var ha;null===(ha=this.appCheckProvider)|| void 0===ha||ha.get().then(a=>a.addTokenListener(ga))}notifyForInvalidToken(){P(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}}class ia{constructor(ja,ka,la){this.appName_=ja,this.firebaseOptions_=ka,this.authProvider_=la,this.auth_=null,this.auth_=la.getImmediate({optional:!0}),this.auth_||la.onInit(a=>this.auth_=a)}getToken(ma){return this.auth_?this.auth_.getToken(ma).catch(a=>a&&"auth/token-not-initialized"===a.code?(L("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(a)):new Promise((a,b)=>{setTimeout(()=>{this.auth_?this.getToken(ma).then(a,b):a(null)},0)})}addTokenChangeListener(na){this.auth_?this.auth_.addAuthTokenListener(na):this.authProvider_.get().then(a=>a.addAuthTokenListener(na))}removeTokenChangeListener(oa){this.authProvider_.get().then(a=>a.removeAuthTokenListener(oa))}notifyForInvalidToken(){let pa="Provided authentication credentials for the app named \""+this.appName_+"\" are invalid. This usually indicates your app was not initialized correctly. ";"credential"in this.firebaseOptions_?pa+="Make sure the \"credential\" property provided to initializeApp() is authorized to access the specified \"databaseURL\" and is from the correct project.":"serviceAccount"in this.firebaseOptions_?pa+="Make sure the \"serviceAccount\" property provided to initializeApp() is authorized to access the specified \"databaseURL\" and is from the correct project.":pa+="Make sure the \"apiKey\" and \"databaseURL\" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.",P(pa)}}class qa{constructor(ra){this.accessToken=ra}getToken(sa){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(ta){ta(this.accessToken)}removeTokenChangeListener(ua){}notifyForInvalidToken(){}}qa.OWNER="owner";const va=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/;class wa{constructor(xa,ya,za,Aa,Ba=!1,Ca="",Da=!1){this.secure=ya,this.namespace=za,this.webSocketOnly=Aa,this.nodeAdmin=Ba,this.persistenceKey=Ca,this.includeNamespaceInQueryParams=Da,this._host=xa.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=B.get("host:"+xa)||this._host}isCacheableHost(){return"s-"===this.internalHost.substr(0,2)}isCustomHost(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain}get host(){return this._host}set host(Ea){Ea!==this.internalHost&&(this.internalHost=Ea,this.isCacheableHost()&&B.set("host:"+this._host,this.internalHost))}toString(){let Fa=this.toURLString();return this.persistenceKey&&(Fa+="<"+this.persistenceKey+">"),Fa}toURLString(){const Ga=this.secure?"https://":"http://",Ha=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${Ga}${this.host}/${Ha}`}}function Ia(a,b,c){var d;(0,j.hu)("string"==typeof b,"typeof type must == string"),(0,j.hu)("object"==typeof c,"typeof params must == object");let e;if("websocket"===b)e=(a.secure?"wss://":"ws://")+a.internalHost+"/.ws?";else if("long_polling"===b)e=(a.secure?"https://":"http://")+a.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+b);((d=a).host!==d.internalHost||d.isCustomHost()||d.includeNamespaceInQueryParams)&&(c.ns=a.namespace);const f=[];return X(c,(a,b)=>{f.push(a+"="+b)}),e+f.join("&")}class Ja{constructor(){this.counters_={}}incrementCounter(Ka,La=1){(0,j.r3)(this.counters_,Ka)||(this.counters_[Ka]=0),this.counters_[Ka]+=La}get(){return(0,j.p$)(this.counters_)}}const Ma={},Na={};function Oa(a){const b=a.toString();return Ma[b]||(Ma[b]=new Ja()),Ma[b]}class Pa{constructor(Qa){this.onMessage_=Qa,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(Ra,Sa){this.closeAfterResponse=Ra,this.onClose=Sa,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(Ta,Ua){for(this.pendingResponses[Ta]=Ua;this.pendingResponses[this.currentResponseNum];){const Va=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let Wa=0;Wa<Va.length;++Wa)Va[Wa]&&_(()=>{this.onMessage_(Va[Wa])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const Xa=1840;class Ya{constructor(Za,$a,_a,ab,bb,cb,db){this.connId=Za,this.repoInfo=$a,this.applicationId=_a,this.appCheckToken=ab,this.authToken=bb,this.transportSessionId=cb,this.lastSessionId=db,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=M(Za),this.stats_=Oa($a),this.urlFn=a=>(this.appCheckToken&&(a.ac=this.appCheckToken),Ia($a,"long_polling",a))}open(eb,fb){this.curSegmentNum=0,this.onDisconnect_=fb,this.myPacketOrderer=new Pa(eb),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(30e3)),S(()=>{if(!this.isClosed_){this.scriptTagHolder=new qb((...a)=>{const[b,c,d,e,f]=a;if(this.incrementIncomingBytes_(a),this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,"start"===b)this.id=c,this.password=d;else if("close"===b)c?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(c,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+b)},(...a)=>{const[b,c]=a;this.incrementIncomingBytes_(a),this.myPacketOrderer.handleResponse(b,c)},()=>{this.onClosed_()},this.urlFn);const a={};a.start="t",a.ser=Math.floor(10e7*Math.random()),this.scriptTagHolder.uniqueCallbackIdentifier&&(a.cb=this.scriptTagHolder.uniqueCallbackIdentifier),a.v="5",this.transportSessionId&&(a.s=this.transportSessionId),this.lastSessionId&&(a.ls=this.lastSessionId),this.applicationId&&(a.p=this.applicationId),this.appCheckToken&&(a.ac=this.appCheckToken),"undefined"!=typeof location&&location.hostname&&va.test(location.hostname)&&(a.r="f");const b=this.urlFn(a);this.log_("Connecting via long-poll to "+b),this.scriptTagHolder.addTag(b,()=>{})}})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){Ya.forceAllow_=!0}static forceDisallow(){Ya.forceDisallow_=!0}static isAvailable(){return!(0,j.Yr)()&&(!!Ya.forceAllow_|| !Ya.forceDisallow_&&"undefined"!=typeof document&&null!=document.createElement&&!("object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))&&!("object"==typeof Windows&&"object"==typeof Windows.UI))}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){!this.isClosed_&&(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(gb){const hb=(0,j.Pz)(gb);this.bytesSent+=hb.length,this.stats_.incrementCounter("bytes_sent",hb.length);const ib=(0,j.h$)(hb),jb=W(ib,Xa);for(let kb=0;kb<jb.length;kb++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,jb.length,jb[kb]),this.curSegmentNum++}addDisconnectPingFrame(lb,mb){if(!(0,j.Yr)()){this.myDisconnFrame=document.createElement("iframe");const nb={};nb.dframe="t",nb.id=lb,nb.pw=mb,this.myDisconnFrame.src=this.urlFn(nb),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}}incrementIncomingBytes_(ob){const pb=(0,j.Pz)(ob).length;this.bytesReceived+=pb,this.stats_.incrementCounter("bytes_received",pb)}}class qb{constructor(rb,sb,tb,ub){if(this.onDisconnect=tb,this.urlFn=ub,this.outstandingRequests=new Set(),this.pendingSegs=[],this.currentSerial=Math.floor(10e7*Math.random()),this.sendNewPolls=!0,(0,j.Yr)())this.commandCB=rb,this.onMessageCB=sb;else{this.uniqueCallbackIdentifier=F(),window["pLPCommand"+this.uniqueCallbackIdentifier]=rb,window["pRTLPCB"+this.uniqueCallbackIdentifier]=sb,this.myIFrame=qb.createIFrame_();let vb="";if(this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,11)){const wb=document.domain;vb="<script>document.domain=\""+wb+"\";</script>"}const xb="<html><body>"+vb+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(xb),this.myIFrame.doc.close()}catch(yb){L("frame writing exception"),yb.stack&&L(yb.stack),L(yb)}}}static createIFrame_(){const zb=document.createElement("iframe");if(zb.style.display="none",document.body){document.body.appendChild(zb);try{const Ab=zb.contentWindow.document;Ab||L("No IE domain setting required")}catch(Bb){const Cb=document.domain;zb.src="javascript:void((function(){document.open();document.domain='"+Cb+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return zb.contentDocument?zb.doc=zb.contentDocument:zb.contentWindow?zb.doc=zb.contentWindow.document:zb.document&&(zb.doc=zb.document),zb}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout(()=>{null!==this.myIFrame&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const Db=this.onDisconnect;Db&&(this.onDisconnect=null,Db())}startLongPoll(Eb,Fb){for(this.myID=Eb,this.myPW=Fb,this.alive=!0;this.newRequest_(););}newRequest_(){if(!this.alive||!this.sendNewPolls||!(this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)))return!1;{this.currentSerial++;const Gb={};Gb.id=this.myID,Gb.pw=this.myPW,Gb.ser=this.currentSerial;let Hb=this.urlFn(Gb),Ib="",Jb=0;for(;this.pendingSegs.length>0;){const Kb=this.pendingSegs[0];if(Kb.d.length+30+Ib.length<=1870){const Lb=this.pendingSegs.shift();Ib=Ib+"&seg"+Jb+"="+Lb.seg+"&ts"+Jb+"="+Lb.ts+"&d"+Jb+"="+Lb.d,Jb++}else break}return Hb+=Ib,this.addLongPollTag_(Hb,this.currentSerial),!0}}enqueueSegment(Mb,Nb,Ob){this.pendingSegs.push({seg:Mb,ts:Nb,d:Ob}),this.alive&&this.newRequest_()}addLongPollTag_(Pb,Qb){this.outstandingRequests.add(Qb);const Rb=()=>{this.outstandingRequests.delete(Qb),this.newRequest_()},Sb=setTimeout(Rb,Math.floor(25000));this.addTag(Pb,()=>{clearTimeout(Sb),Rb()})}addTag(Tb,Ub){(0,j.Yr)()?this.doNodeLongPoll(Tb,Ub):setTimeout(()=>{try{if(!this.sendNewPolls)return;const a=this.myIFrame.doc.createElement("script");a.type="text/javascript",a.async=!0,a.src=Tb,a.onload=a.onreadystatechange=function(){const b=a.readyState;b&&"loaded"!==b&&"complete"!==b||(a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),Ub())},a.onerror=()=>{L("Long-poll script failed to load: "+Tb),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(a)}catch(b){}},Math.floor(1))}}let Vb=null;"undefined"!=typeof MozWebSocket?Vb=MozWebSocket:"undefined"!=typeof WebSocket&&(Vb=WebSocket);class Wb{constructor(Xb,Yb,Zb,$b,_b,ac,bc){this.connId=Xb,this.applicationId=Zb,this.appCheckToken=$b,this.authToken=_b,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=M(this.connId),this.stats_=Oa(Yb),this.connURL=Wb.connectionURL_(Yb,ac,bc,$b),this.nodeAdmin=Yb.nodeAdmin}static connectionURL_(cc,dc,ec,fc){const gc={};return gc.v="5",!(0,j.Yr)()&&"undefined"!=typeof location&&location.hostname&&va.test(location.hostname)&&(gc.r="f"),dc&&(gc.s=dc),ec&&(gc.ls=ec),fc&&(gc.ac=fc),Ia(cc,"websocket",gc)}open(hc,ic){this.onDisconnect=ic,this.onMessage=hc,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,B.set("previous_websocket_failure",!0);try{if((0,j.Yr)()){const jc=this.nodeAdmin?"AdminNode":"Node",kc={headers:{"User-Agent":`Firebase/5/${m}/${l.platform}/${jc}`,"X-Firebase-GMPID":this.applicationId||""}};this.authToken&&(kc.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(kc.headers["X-Firebase-AppCheck"]=this.appCheckToken);const lc=l.env,mc=0===this.connURL.indexOf("wss://")?lc.HTTPS_PROXY||lc.https_proxy:lc.HTTP_PROXY||lc.http_proxy;mc&&(kc.proxy={origin:mc}),this.mySock=new Vb(this.connURL,[],kc)}else{const nc={headers:{"X-Firebase-GMPID":this.applicationId||"","X-Firebase-AppCheck":this.appCheckToken||""}};this.mySock=new Vb(this.connURL,[],nc)}}catch(oc){this.log_("Error instantiating WebSocket.");const pc=oc.message||oc.data;pc&&this.log_(pc),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=a=>{this.handleIncomingFrame(a)},this.mySock.onerror=a=>{this.log_("WebSocket error.  Closing connection.");const b=a.message||a.data;b&&this.log_(b),this.onClosed_()}}start(){}static forceDisallow(){Wb.forceDisallow_=!0}static isAvailable(){let qc=!1;if("undefined"!=typeof navigator&&navigator.userAgent){const rc=/Android ([0-9]{0,}\.[0-9]{0,})/,sc=navigator.userAgent.match(rc);sc&&sc.length>1&&4.4>parseFloat(sc[1])&&(qc=!0)}return!qc&&null!==Vb&&!Wb.forceDisallow_}static previouslyFailed(){return B.isInMemoryStorage|| !0===B.get("previous_websocket_failure")}markConnectionHealthy(){B.remove("previous_websocket_failure")}appendFrame_(tc){if(this.frames.push(tc),this.frames.length===this.totalFrames){const uc=this.frames.join("");this.frames=null;const vc=(0,j.cI)(uc);this.onMessage(vc)}}handleNewFrameCount_(wc){this.totalFrames=wc,this.frames=[]}extractFrameCount_(xc){if((0,j.hu)(null===this.frames,"We already have a frame buffer"),xc.length<=6){const yc=Number(xc);if(!isNaN(yc))return this.handleNewFrameCount_(yc),null}return this.handleNewFrameCount_(1),xc}handleIncomingFrame(zc){if(null!==this.mySock){const Ac=zc.data;if(this.bytesReceived+=Ac.length,this.stats_.incrementCounter("bytes_received",Ac.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(Ac);else{const Bc=this.extractFrameCount_(Ac);null!==Bc&&this.appendFrame_(Bc)}}}send(Cc){this.resetKeepAlive();const Dc=(0,j.Pz)(Cc);this.bytesSent+=Dc.length,this.stats_.incrementCounter("bytes_sent",Dc.length);const Ec=W(Dc,16384);Ec.length>1&&this.sendString_(String(Ec.length));for(let Fc=0;Fc<Ec.length;Fc++)this.sendString_(Ec[Fc])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){!this.isClosed_&&(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(45000))}sendString_(Gc){try{this.mySock.send(Gc)}catch(Hc){this.log_("Exception thrown from WebSocket.send():",Hc.message||Hc.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}Wb.responsesRequiredToBeHealthy=2,Wb.healthyTimeout=30e3;class Ic{constructor(Jc){this.initTransports_(Jc)}static get ALL_TRANSPORTS(){return[Ya,Wb]}initTransports_(Kc){const Lc=Wb&&Wb.isAvailable();let Mc=Lc&&!Wb.previouslyFailed();if(Kc.webSocketOnly&&(Lc||P("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),Mc=!0),Mc)this.transports_=[Wb];else{const Nc=this.transports_=[];for(const Oc of Ic.ALL_TRANSPORTS)Oc&&Oc.isAvailable()&&Nc.push(Oc)}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}class Pc{constructor(Qc,Rc,Sc,Tc,Uc,Vc,Wc,Xc,Yc,Zc){this.id=Qc,this.repoInfo_=Rc,this.applicationId_=Sc,this.appCheckToken_=Tc,this.authToken_=Uc,this.onMessage_=Vc,this.onReady_=Wc,this.onDisconnect_=Xc,this.onKill_=Yc,this.lastSessionId=Zc,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=M("c:"+this.id+":"),this.transportManager_=new Ic(Rc),this.log_("Connection created"),this.start_()}start_(){const $c=this.transportManager_.initialTransport();this.conn_=new $c(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=$c.responsesRequiredToBeHealthy||0;const _c=this.connReceiver_(this.conn_),ad=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(_c,ad)},Math.floor(0));const bd=$c.healthyTimeout||0;bd>0&&(this.healthyTimeout_=ba(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>102400?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>10240?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(bd)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(cd){return a=>{cd===this.conn_?this.onConnectionLost_(a):cd===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(dd){return a=>{2!==this.state_&&(dd===this.rx_?this.onPrimaryMessageReceived_(a):dd===this.secondaryConn_?this.onSecondaryMessageReceived_(a):this.log_("message on old connection"))}}sendRequest(ed){this.sendData_({t:"d",d:ed})}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(fd){if("t"in fd){const gd=fd.t;"a"===gd?this.upgradeIfSecondaryHealthy_():"r"===gd?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):"o"===gd&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(hd){const id=U("t",hd),jd=U("d",hd);if("c"===id)this.onSecondaryControl_(jd);else if("d"===id)this.pendingDataMessages.push(jd);else throw new Error("Unknown protocol layer: "+id)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(kd){const ld=U("t",kd),md=U("d",kd);"c"===ld?this.onControl_(md):"d"===ld&&this.onDataMessage_(md)}onDataMessage_(nd){this.onPrimaryResponse_(),this.onMessage_(nd)}onPrimaryResponse_(){!this.isHealthy_&&(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(od){const pd=U("t",od);if("d"in od){const qd=od.d;if("h"===pd)this.onHandshake_(qd);else if("n"===pd){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let rd=0;rd<this.pendingDataMessages.length;++rd)this.onDataMessage_(this.pendingDataMessages[rd]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===pd?this.onConnectionShutdown_(qd):"r"===pd?this.onReset_(qd):"e"===pd?N("Server Error: "+qd):"o"===pd?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):N("Unknown control packet command: "+pd)}}onHandshake_(sd){const td=sd.ts,ud=sd.v,vd=sd.h;this.sessionId=sd.s,this.repoInfo_.host=vd,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,td),"5"!==ud&&P("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const wd=this.transportManager_.upgradeTransport();wd&&this.startUpgrade_(wd)}startUpgrade_(xd){this.secondaryConn_=new xd(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=xd.responsesRequiredToBeHealthy||0;const yd=this.connReceiver_(this.secondaryConn_),zd=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(yd,zd),ba(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(60e3))}onReset_(Ad){this.log_("Reset packet received.  New host: "+Ad),this.repoInfo_.host=Ad,1===this.state_?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(Bd,Cd){this.log_("Realtime connection established."),this.conn_=Bd,this.state_=1,this.onReady_&&(this.onReady_(Cd,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):ba(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(5000))}sendPingOnPrimaryIfNecessary_(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))}onSecondaryConnectionLost_(){const Dd=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===Dd||this.rx_===Dd)&&this.close()}onConnectionLost_(Ed){this.conn_=null,Ed||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(B.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()}onConnectionShutdown_(Fd){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(Fd),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(Gd){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(Gd)}close(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class Hd{put(Id,Jd,Kd,Ld){}merge(Md,Nd,Od,Pd){}refreshAuthToken(Qd){}refreshAppCheckToken(Rd){}onDisconnectPut(Sd,Td,Ud){}onDisconnectMerge(Vd,Wd,Xd){}onDisconnectCancel(Yd,Zd){}reportStats($d){}}class _d{constructor(ae){this.allowedEvents_=ae,this.listeners_={},(0,j.hu)(Array.isArray(ae)&&ae.length>0,"Requires a non-empty array")}trigger(be,...ce){if(Array.isArray(this.listeners_[be])){const de=[...this.listeners_[be]];for(let ee=0;ee<de.length;ee++)de[ee].callback.apply(de[ee].context,ce)}}on(fe,ge,he){this.validateEventType_(fe),this.listeners_[fe]=this.listeners_[fe]||[],this.listeners_[fe].push({callback:ge,context:he});const ie=this.getInitialEvent(fe);ie&&ge.apply(he,ie)}off(je,ke,le){this.validateEventType_(je);const me=this.listeners_[je]||[];for(let ne=0;ne<me.length;ne++)if(me[ne].callback===ke&&(!le||le===me[ne].context)){me.splice(ne,1);return}}validateEventType_(oe){(0,j.hu)(this.allowedEvents_.find(a=>a===oe),"Unknown event: "+oe)}}class pe extends _d{constructor(){super(["online"]),this.online_=!0,"undefined"==typeof window|| void 0===window.addEventListener||(0,j.uI)()||(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new pe()}getInitialEvent(qe){return(0,j.hu)("online"===qe,"Unknown event type: "+qe),[this.online_]}currentlyOnline(){return this.online_}}class re{constructor(se,te){if(void 0===te){this.pieces_=se.split("/");let ue=0;for(let ve=0;ve<this.pieces_.length;ve++)this.pieces_[ve].length>0&&(this.pieces_[ue]=this.pieces_[ve],ue++);this.pieces_.length=ue,this.pieceNum_=0}else this.pieces_=se,this.pieceNum_=te}toString(){let we="";for(let xe=this.pieceNum_;xe<this.pieces_.length;xe++)""!==this.pieces_[xe]&&(we+="/"+this.pieces_[xe]);return we||"/"}}function ye(){return new re("")}function ze(a){return a.pieceNum_>=a.pieces_.length?null:a.pieces_[a.pieceNum_]}function Ae(a){return a.pieces_.length-a.pieceNum_}function Be(a){let b=a.pieceNum_;return b<a.pieces_.length&&b++,new re(a.pieces_,b)}function Ce(a){return a.pieceNum_<a.pieces_.length?a.pieces_[a.pieces_.length-1]:null}function De(a,b=0){return a.pieces_.slice(a.pieceNum_+b)}function Ee(a){if(a.pieceNum_>=a.pieces_.length)return null;const b=[];for(let c=a.pieceNum_;c<a.pieces_.length-1;c++)b.push(a.pieces_[c]);return new re(b,0)}function Fe(a,b){const c=[];for(let d=a.pieceNum_;d<a.pieces_.length;d++)c.push(a.pieces_[d]);if(b instanceof re)for(let e=b.pieceNum_;e<b.pieces_.length;e++)c.push(b.pieces_[e]);else{const f=b.split("/");for(let g=0;g<f.length;g++)f[g].length>0&&c.push(f[g])}return new re(c,0)}function Ge(a){return a.pieceNum_>=a.pieces_.length}function He(a,b){const c=ze(a),d=ze(b);if(null===c)return b;if(c===d)return He(Be(a),Be(b));throw new Error("INTERNAL ERROR: innerPath ("+b+") is not within outerPath ("+a+")")}function Ie(a,b){if(Ae(a)!==Ae(b))return!1;for(let c=a.pieceNum_,d=b.pieceNum_;c<=a.pieces_.length;c++,d++)if(a.pieces_[c]!==b.pieces_[d])return!1;return!0}function Je(a,b){let c=a.pieceNum_,d=b.pieceNum_;if(Ae(a)>Ae(b))return!1;for(;c<a.pieces_.length;){if(a.pieces_[c]!==b.pieces_[d])return!1;++c,++d}return!0}class Ke{constructor(Le,Me){this.errorPrefix_=Me,this.parts_=De(Le,0),this.byteLength_=Math.max(1,this.parts_.length);for(let Ne=0;Ne<this.parts_.length;Ne++)this.byteLength_+=(0,j.ug)(this.parts_[Ne]);Oe(this)}}function Oe(a){if(a.byteLength_>768)throw new Error(a.errorPrefix_+"has a key path longer than 768 bytes ("+a.byteLength_+").");if(a.parts_.length>32)throw new Error(a.errorPrefix_+"path specified exceeds the maximum depth that can be written (32) or object contains a cycle "+Pe(a))}function Pe(a){return 0===a.parts_.length?"":"in property '"+a.parts_.join(".")+"'"}class Qe extends _d{constructor(){super(["visible"]);let Re,Se;"undefined"!=typeof document&& void 0!==document.addEventListener&&(void 0!==document.hidden?(Se="visibilitychange",Re="hidden"):void 0!==document.mozHidden?(Se="mozvisibilitychange",Re="mozHidden"):void 0!==document.msHidden?(Se="msvisibilitychange",Re="msHidden"):void 0!==document.webkitHidden&&(Se="webkitvisibilitychange",Re="webkitHidden")),this.visible_=!0,Se&&document.addEventListener(Se,()=>{const a=!document[Re];a!==this.visible_&&(this.visible_=a,this.trigger("visible",a))},!1)}static getInstance(){return new Qe()}getInitialEvent(Te){return(0,j.hu)("visible"===Te,"Unknown event type: "+Te),[this.visible_]}}class Ue extends Hd{constructor(Ve,We,Xe,Ye,Ze,$e,_e,af){if(super(),this.repoInfo_=Ve,this.applicationId_=We,this.onDataUpdate_=Xe,this.onConnectStatus_=Ye,this.onServerInfoUpdate_=Ze,this.authTokenProvider_=$e,this.appCheckTokenProvider_=_e,this.authOverride_=af,this.id=Ue.nextPersistentConnectionId_++,this.log_=M("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map(),this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=1000,this.maxReconnectDelay_=30e4,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,af&&!(0,j.Yr)())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Qe.getInstance().on("visible",this.onVisible_,this),-1===Ve.host.indexOf("fblocal")&&pe.getInstance().on("online",this.onOnline_,this)}sendRequest(bf,cf,df){const ef=++this.requestNumber_,ff={r:ef,a:bf,b:cf};this.log_((0,j.Pz)(ff)),(0,j.hu)(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(ff),df&&(this.requestCBHash_[ef]=df)}get(gf){this.initConnection_();const hf=new j.BH(),jf={p:gf._path.toString(),q:gf._queryObject},kf={action:"g",request:jf,onComplete:a=>{const b=a.d;"ok"===a.s?(this.onDataUpdate_(jf.p,b,!1,null),hf.resolve(b)):hf.reject(b)}};this.outstandingGets_.push(kf),this.outstandingGetCount_++;const lf=this.outstandingGets_.length-1;return this.connected_||setTimeout(()=>{const a=this.outstandingGets_[lf];void 0!==a&&kf===a&&(delete this.outstandingGets_[lf],this.outstandingGetCount_--,0===this.outstandingGetCount_&&(this.outstandingGets_=[]),this.log_("get "+lf+" timed out on connection"),hf.reject(new Error("Client is offline.")))},3000),this.connected_&&this.sendGet_(lf),hf.promise}listen(mf,nf,of,pf){this.initConnection_();const qf=mf._queryIdentifier,rf=mf._path.toString();this.log_("Listen called for "+rf+" "+qf),this.listens.has(rf)||this.listens.set(rf,new Map()),(0,j.hu)(mf._queryParams.isDefault()||!mf._queryParams.loadsAllData(),"listen() called for non-default but complete query"),(0,j.hu)(!this.listens.get(rf).has(qf),"listen() called twice for same path/queryId.");const sf={onComplete:pf,hashFn:nf,query:mf,tag:of};this.listens.get(rf).set(qf,sf),this.connected_&&this.sendListen_(sf)}sendGet_(tf){const uf=this.outstandingGets_[tf];this.sendRequest("g",uf.request,a=>{delete this.outstandingGets_[tf],this.outstandingGetCount_--,0===this.outstandingGetCount_&&(this.outstandingGets_=[]),uf.onComplete&&uf.onComplete(a)})}sendListen_(vf){const wf=vf.query,xf=wf._path.toString(),yf=wf._queryIdentifier;this.log_("Listen on "+xf+" for "+yf);const zf={p:xf};vf.tag&&(zf.q=wf._queryObject,zf.t=vf.tag),zf.h=vf.hashFn(),this.sendRequest("q",zf,a=>{const b=a.d,c=a.s;Ue.warnOnListenWarnings_(b,wf);const d=this.listens.get(xf)&&this.listens.get(xf).get(yf);d===vf&&(this.log_("listen response",a),"ok"!==c&&this.removeListen_(xf,yf),vf.onComplete&&vf.onComplete(c,b))})}static warnOnListenWarnings_(Af,Bf){if(Af&&"object"==typeof Af&&(0,j.r3)(Af,"w")){const Cf=(0,j.DV)(Af,"w");if(Array.isArray(Cf)&& ~Cf.indexOf("no_index")){const Df="\".indexOn\": \""+Bf._queryParams.getIndex().toString()+"\"",Ef=Bf._path.toString();P(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${Df} at ${Ef} to your security rules for better performance.`)}}}refreshAuthToken(Ff){this.authToken_=Ff,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(Ff)}reduceReconnectDelayIfAdminCredential_(Gf){const Hf=Gf&&40===Gf.length;(Hf||(0,j.GJ)(Gf))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=30e3)}refreshAppCheckToken(If){this.appCheckToken_=If,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const Jf=this.authToken_,Kf=(0,j.w9)(Jf)?"auth":"gauth",Lf={cred:Jf};null===this.authOverride_?Lf.noauth=!0:"object"==typeof this.authOverride_&&(Lf.authvar=this.authOverride_),this.sendRequest(Kf,Lf,a=>{const b=a.s,c=a.d||"error";this.authToken_===Jf&&("ok"===b?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(b,c))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},a=>{const b=a.s,c=a.d||"error";"ok"===b?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(b,c)})}unlisten(Mf,Nf){const Of=Mf._path.toString(),Pf=Mf._queryIdentifier;this.log_("Unlisten called for "+Of+" "+Pf),(0,j.hu)(Mf._queryParams.isDefault()||!Mf._queryParams.loadsAllData(),"unlisten() called for non-default but complete query");const Qf=this.removeListen_(Of,Pf);Qf&&this.connected_&&this.sendUnlisten_(Of,Pf,Mf._queryObject,Nf)}sendUnlisten_(Rf,Sf,Tf,Uf){this.log_("Unlisten on "+Rf+" for "+Sf);const Vf={p:Rf};Uf&&(Vf.q=Tf,Vf.t=Uf),this.sendRequest("n",Vf)}onDisconnectPut(Wf,Xf,Yf){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",Wf,Xf,Yf):this.onDisconnectRequestQueue_.push({pathString:Wf,action:"o",data:Xf,onComplete:Yf})}onDisconnectMerge(Zf,$f,_f){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",Zf,$f,_f):this.onDisconnectRequestQueue_.push({pathString:Zf,action:"om",data:$f,onComplete:_f})}onDisconnectCancel(ag,bg){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",ag,null,bg):this.onDisconnectRequestQueue_.push({pathString:ag,action:"oc",data:null,onComplete:bg})}sendOnDisconnect_(cg,dg,eg,fg){const gg={p:dg,d:eg};this.log_("onDisconnect "+cg,gg),this.sendRequest(cg,gg,a=>{fg&&setTimeout(()=>{fg(a.s,a.d)},Math.floor(0))})}put(hg,ig,jg,kg){this.putInternal("p",hg,ig,jg,kg)}merge(lg,mg,ng,og){this.putInternal("m",lg,mg,ng,og)}putInternal(pg,qg,rg,sg,tg){this.initConnection_();const ug={p:qg,d:rg};void 0!==tg&&(ug.h=tg),this.outstandingPuts_.push({action:pg,request:ug,onComplete:sg}),this.outstandingPutCount_++;const vg=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(vg):this.log_("Buffering put: "+qg)}sendPut_(wg){const xg=this.outstandingPuts_[wg].action,yg=this.outstandingPuts_[wg].request,zg=this.outstandingPuts_[wg].onComplete;this.outstandingPuts_[wg].queued=this.connected_,this.sendRequest(xg,yg,a=>{this.log_(xg+" response",a),delete this.outstandingPuts_[wg],this.outstandingPutCount_--,0===this.outstandingPutCount_&&(this.outstandingPuts_=[]),zg&&zg(a.s,a.d)})}reportStats(Ag){if(this.connected_){const Bg={c:Ag};this.log_("reportStats",Bg),this.sendRequest("s",Bg,a=>{const b=a.s;if("ok"!==b){const c=a.d;this.log_("reportStats","Error sending stats: "+c)}})}}onDataMessage_(Cg){if("r"in Cg){this.log_("from server: "+(0,j.Pz)(Cg));const Dg=Cg.r,Eg=this.requestCBHash_[Dg];Eg&&(delete this.requestCBHash_[Dg],Eg(Cg.b))}else if("error"in Cg)throw"A server-side error has occurred: "+Cg.error;else"a"in Cg&&this.onDataPush_(Cg.a,Cg.b)}onDataPush_(Fg,Gg){this.log_("handleServerMessage",Fg,Gg),"d"===Fg?this.onDataUpdate_(Gg.p,Gg.d,!1,Gg.t):"m"===Fg?this.onDataUpdate_(Gg.p,Gg.d,!0,Gg.t):"c"===Fg?this.onListenRevoked_(Gg.p,Gg.q):"ac"===Fg?this.onAuthRevoked_(Gg.s,Gg.d):"apc"===Fg?this.onAppCheckRevoked_(Gg.s,Gg.d):"sd"===Fg?this.onSecurityDebugPacket_(Gg):N("Unrecognized action received from server: "+(0,j.Pz)(Fg)+"\nAre you using the latest client?")}onReady_(Hg,Ig){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(Hg),this.lastSessionId=Ig,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(Jg){(0,j.hu)(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(Jg))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(Kg){!Kg||this.visible_||this.reconnectDelay_!==this.maxReconnectDelay_||(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=1000,this.realtime_||this.scheduleConnect_(0)),this.visible_=Kg}onOnline_(Lg){Lg?(this.log_("Browser went online."),this.reconnectDelay_=1000,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){const Mg=new Date().getTime()-this.lastConnectionEstablishedTime_;Mg>30e3&&(this.reconnectDelay_=1000),this.lastConnectionEstablishedTime_=null}}else this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime();const Ng=new Date().getTime()-this.lastConnectionAttemptTime_;let Og=Math.max(0,this.reconnectDelay_-Ng);Og=Math.random()*Og,this.log_("Trying to reconnect in "+Og+"ms"),this.scheduleConnect_(Og),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;const Pg=this.onDataMessage_.bind(this),Qg=this.onReady_.bind(this),Rg=this.onRealtimeDisconnect_.bind(this),Sg=this.id+":"+Ue.nextConnectionId_++,Tg=this.lastSessionId;let Ug=!1,Vg=null;const Wg=function(){Vg?Vg.close():(Ug=!0,Rg())},Xg=function(a){(0,j.hu)(Vg,"sendRequest call when we're not connected not allowed."),Vg.sendRequest(a)};this.realtime_={close:Wg,sendRequest:Xg};const Yg=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[Zg,$g]=await Promise.all([this.authTokenProvider_.getToken(Yg),this.appCheckTokenProvider_.getToken(Yg)]);Ug?L("getToken() completed but was canceled"):(L("getToken() completed. Creating connection."),this.authToken_=Zg&&Zg.accessToken,this.appCheckToken_=$g&&$g.token,Vg=new Pc(Sg,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,Pg,Qg,Rg,a=>{P(a+" ("+this.repoInfo_.toString()+")"),this.interrupt("server_kill")},Tg))}catch(_g){this.log_("Failed to get token: "+_g),Ug||(this.repoInfo_.nodeAdmin&&P(_g),Wg())}}}interrupt(ah){L("Interrupting connection for reason: "+ah),this.interruptReasons_[ah]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(bh){L("Resuming connection for reason: "+bh),delete this.interruptReasons_[bh],(0,j.xb)(this.interruptReasons_)&&(this.reconnectDelay_=1000,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(ch){const dh=ch-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:dh})}cancelSentTransactions_(){for(let eh=0;eh<this.outstandingPuts_.length;eh++){const fh=this.outstandingPuts_[eh];fh&&"h"in fh.request&&fh.queued&&(fh.onComplete&&fh.onComplete("disconnect"),delete this.outstandingPuts_[eh],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])}onListenRevoked_(gh,hh){let ih;ih=hh?hh.map(a=>V(a)).join("$"):"default";const jh=this.removeListen_(gh,ih);jh&&jh.onComplete&&jh.onComplete("permission_denied")}removeListen_(kh,lh){const mh=new re(kh).toString();let nh;if(this.listens.has(mh)){const oh=this.listens.get(mh);nh=oh.get(lh),oh.delete(lh),0===oh.size&&this.listens.delete(mh)}else nh=void 0;return nh}onAuthRevoked_(ph,qh){L("Auth token revoked: "+ph+"/"+qh),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),("invalid_token"===ph||"permission_denied"===ph)&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=30e3,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(rh,sh){L("App check token revoked: "+rh+"/"+sh),this.appCheckToken_=null,this.forceTokenRefresh_=!0,("invalid_token"===rh||"permission_denied"===rh)&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=3&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(th){this.securityDebugCallback_?this.securityDebugCallback_(th):"msg"in th&&console.log("FIREBASE: "+th.msg.replace("\n","\nFIREBASE: "))}restoreState_(){for(const uh of(this.tryAuth(),this.tryAppCheck(),this.listens.values()))for(const vh of uh.values())this.sendListen_(vh);for(let wh=0;wh<this.outstandingPuts_.length;wh++)this.outstandingPuts_[wh]&&this.sendPut_(wh);for(;this.onDisconnectRequestQueue_.length;){const xh=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(xh.action,xh.pathString,xh.data,xh.onComplete)}for(let yh=0;yh<this.outstandingGets_.length;yh++)this.outstandingGets_[yh]&&this.sendGet_(yh)}sendConnectStats_(){const zh={};let Ah="js";(0,j.Yr)()&&(Ah=this.repoInfo_.nodeAdmin?"admin_node":"node"),zh["sdk."+Ah+"."+m.replace(/\./g,"-")]=1,(0,j.uI)()?zh["framework.cordova"]=1:(0,j.b$)()&&(zh["framework.reactnative"]=1),this.reportStats(zh)}shouldReconnect_(){const Bh=pe.getInstance().currentlyOnline();return(0,j.xb)(this.interruptReasons_)&&Bh}}Ue.nextPersistentConnectionId_=0,Ue.nextConnectionId_=0;class Ch{constructor(Dh,Eh){this.name=Dh,this.node=Eh}static Wrap(Fh,Gh){return new Ch(Fh,Gh)}}class Hh{getCompare(){return this.compare.bind(this)}indexedValueChanged(Ih,Jh){const Kh=new Ch("[MIN_NAME]",Ih),Lh=new Ch("[MIN_NAME]",Jh);return 0!==this.compare(Kh,Lh)}minPost(){return Ch.MIN}}let Mh;class Nh extends Hh{static get __EMPTY_NODE(){return Mh}static set __EMPTY_NODE(Oh){Mh=Oh}compare(Ph,Qh){return T(Ph.name,Qh.name)}isDefinedOn(Rh){throw(0,j.g5)("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(Sh,Th){return!1}minPost(){return Ch.MIN}maxPost(){return new Ch("[MAX_NAME]",Mh)}makePost(Uh,Vh){return(0,j.hu)("string"==typeof Uh,"KeyIndex indexValue must always be a string."),new Ch(Uh,Mh)}toString(){return".key"}}const Wh=new Nh();class Xh{constructor(Yh,Zh,$h,_h,ai=null){this.isReverse_=_h,this.resultGenerator_=ai,this.nodeStack_=[];let bi=1;for(;!Yh.isEmpty();)if(Yh=Yh,bi=Zh?$h(Yh.key,Zh):1,_h&&(bi*=-1),bi<0)Yh=this.isReverse_?Yh.left:Yh.right;else if(0===bi){this.nodeStack_.push(Yh);break}else this.nodeStack_.push(Yh),Yh=this.isReverse_?Yh.right:Yh.left}getNext(){if(0===this.nodeStack_.length)return null;let ci=this.nodeStack_.pop(),di;if(di=this.resultGenerator_?this.resultGenerator_(ci.key,ci.value):{key:ci.key,value:ci.value},this.isReverse_)for(ci=ci.left;!ci.isEmpty();)this.nodeStack_.push(ci),ci=ci.right;else for(ci=ci.right;!ci.isEmpty();)this.nodeStack_.push(ci),ci=ci.left;return di}hasNext(){return this.nodeStack_.length>0}peek(){if(0===this.nodeStack_.length)return null;const ei=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(ei.key,ei.value):{key:ei.key,value:ei.value}}}class fi{constructor(gi,hi,ii,ji,ki){this.key=gi,this.value=hi,this.color=null!=ii?ii:fi.RED,this.left=null!=ji?ji:Li.EMPTY_NODE,this.right=null!=ki?ki:Li.EMPTY_NODE}copy(li,mi,ni,oi,pi){return new fi(null!=li?li:this.key,null!=mi?mi:this.value,null!=ni?ni:this.color,null!=oi?oi:this.left,null!=pi?pi:this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(qi){return this.left.inorderTraversal(qi)||!!qi(this.key,this.value)||this.right.inorderTraversal(qi)}reverseTraversal(ri){return this.right.reverseTraversal(ri)||ri(this.key,this.value)||this.left.reverseTraversal(ri)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(si,ti,ui){let vi=this;const wi=ui(si,vi.key);return(vi=wi<0?vi.copy(null,null,null,vi.left.insert(si,ti,ui),null):0===wi?vi.copy(null,ti,null,null,null):vi.copy(null,null,null,null,vi.right.insert(si,ti,ui))).fixUp_()}removeMin_(){if(this.left.isEmpty())return Li.EMPTY_NODE;let xi=this;return xi.left.isRed_()||xi.left.left.isRed_()||(xi=xi.moveRedLeft_()),(xi=xi.copy(null,null,null,xi.left.removeMin_(),null)).fixUp_()}remove(yi,zi){let Ai,Bi;if(Ai=this,0>zi(yi,Ai.key))Ai.left.isEmpty()||Ai.left.isRed_()||Ai.left.left.isRed_()||(Ai=Ai.moveRedLeft_()),Ai=Ai.copy(null,null,null,Ai.left.remove(yi,zi),null);else{if(Ai.left.isRed_()&&(Ai=Ai.rotateRight_()),Ai.right.isEmpty()||Ai.right.isRed_()||Ai.right.left.isRed_()||(Ai=Ai.moveRedRight_()),0===zi(yi,Ai.key)){if(Ai.right.isEmpty())return Li.EMPTY_NODE;Bi=Ai.right.min_(),Ai=Ai.copy(Bi.key,Bi.value,null,null,Ai.right.removeMin_())}Ai=Ai.copy(null,null,null,null,Ai.right.remove(yi,zi))}return Ai.fixUp_()}isRed_(){return this.color}fixUp_(){let Ci=this;return Ci.right.isRed_()&&!Ci.left.isRed_()&&(Ci=Ci.rotateLeft_()),Ci.left.isRed_()&&Ci.left.left.isRed_()&&(Ci=Ci.rotateRight_()),Ci.left.isRed_()&&Ci.right.isRed_()&&(Ci=Ci.colorFlip_()),Ci}moveRedLeft_(){let Di=this.colorFlip_();return Di.right.left.isRed_()&&(Di=(Di=(Di=Di.copy(null,null,null,null,Di.right.rotateRight_())).rotateLeft_()).colorFlip_()),Di}moveRedRight_(){let Ei=this.colorFlip_();return Ei.left.left.isRed_()&&(Ei=(Ei=Ei.rotateRight_()).colorFlip_()),Ei}rotateLeft_(){const Fi=this.copy(null,null,fi.RED,null,this.right.left);return this.right.copy(null,null,this.color,Fi,null)}rotateRight_(){const Gi=this.copy(null,null,fi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,Gi)}colorFlip_(){const Hi=this.left.copy(null,null,!this.left.color,null,null),Ii=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,Hi,Ii)}checkMaxDepth_(){const Ji=this.check_();return Math.pow(2,Ji)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const Ki=this.left.check_();if(Ki===this.right.check_())return Ki+(this.isRed_()?0:1);throw new Error("Black depths differ")}}fi.RED=!0,fi.BLACK=!1;class Li{constructor(Mi,Ni=Li.EMPTY_NODE){this.comparator_=Mi,this.root_=Ni}insert(Oi,Pi){return new Li(this.comparator_,this.root_.insert(Oi,Pi,this.comparator_).copy(null,null,fi.BLACK,null,null))}remove(Qi){return new Li(this.comparator_,this.root_.remove(Qi,this.comparator_).copy(null,null,fi.BLACK,null,null))}get(Ri){let Si,Ti=this.root_;for(;!Ti.isEmpty();){if(0===(Si=this.comparator_(Ri,Ti.key)))return Ti.value;Si<0?Ti=Ti.left:Si>0&&(Ti=Ti.right)}return null}getPredecessorKey(Ui){let Vi,Wi=this.root_,Xi=null;for(;!Wi.isEmpty();){if(0===(Vi=this.comparator_(Ui,Wi.key))){if(Wi.left.isEmpty())if(Xi)return Xi.key;else return null;for(Wi=Wi.left;!Wi.right.isEmpty();)Wi=Wi.right;return Wi.key}Vi<0?Wi=Wi.left:Vi>0&&(Xi=Wi,Wi=Wi.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(Yi){return this.root_.inorderTraversal(Yi)}reverseTraversal(Zi){return this.root_.reverseTraversal(Zi)}getIterator($i){return new Xh(this.root_,null,this.comparator_,!1,$i)}getIteratorFrom(_i,aj){return new Xh(this.root_,_i,this.comparator_,!1,aj)}getReverseIteratorFrom(bj,cj){return new Xh(this.root_,bj,this.comparator_,!0,cj)}getReverseIterator(dj){return new Xh(this.root_,null,this.comparator_,!0,dj)}}function ej(a,b){return T(a.name,b.name)}function fj(a,b){return T(a,b)}Li.EMPTY_NODE=new class{copy(gj,hj,ij,jj,kj){return this}insert(lj,mj,nj){return new fi(lj,mj,null)}remove(oj,pj){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(qj){return!1}reverseTraversal(rj){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}();let sj;const tj=function(a){return"number"==typeof a?"number:"+Y(a):"string:"+a},uj=function(a){if(a.isLeafNode()){const b=a.val();(0,j.hu)("string"==typeof b||"number"==typeof b||"object"==typeof b&&(0,j.r3)(b,".sv"),"Priority must be a string or number.")}else(0,j.hu)(a===sj||a.isEmpty(),"priority of unexpected type.");(0,j.hu)(a===sj||a.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let vj;class wj{constructor(xj,yj=wj.__childrenNodeConstructor.EMPTY_NODE){this.value_=xj,this.priorityNode_=yj,this.lazyHash_=null,(0,j.hu)(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),uj(this.priorityNode_)}static set __childrenNodeConstructor(zj){vj=zj}static get __childrenNodeConstructor(){return vj}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(Aj){return new wj(this.value_,Aj)}getImmediateChild(Bj){return".priority"===Bj?this.priorityNode_:wj.__childrenNodeConstructor.EMPTY_NODE}getChild(Cj){return Ge(Cj)?this:".priority"===ze(Cj)?this.priorityNode_:wj.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(Dj,Ej){return null}updateImmediateChild(Fj,Gj){return".priority"===Fj?this.updatePriority(Gj):Gj.isEmpty()&&".priority"!==Fj?this:wj.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(Fj,Gj).updatePriority(this.priorityNode_)}updateChild(Hj,Ij){const Jj=ze(Hj);return null===Jj?Ij:Ij.isEmpty()&&".priority"!==Jj?this:((0,j.hu)(".priority"!==Jj||1===Ae(Hj),".priority must be the last token in a path"),this.updateImmediateChild(Jj,wj.__childrenNodeConstructor.EMPTY_NODE.updateChild(Be(Hj),Ij)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(Kj,Lj){return!1}val(Mj){return Mj&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(null===this.lazyHash_){let Nj="";this.priorityNode_.isEmpty()||(Nj+="priority:"+tj(this.priorityNode_.val())+":");const Oj=typeof this.value_;Nj+=Oj+":","number"===Oj?Nj+=Y(this.value_):Nj+=this.value_,this.lazyHash_=G(Nj)}return this.lazyHash_}getValue(){return this.value_}compareTo(Pj){return Pj===wj.__childrenNodeConstructor.EMPTY_NODE?1:Pj instanceof wj.__childrenNodeConstructor?-1:((0,j.hu)(Pj.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(Pj))}compareToLeafNode_(Qj){const Rj=typeof Qj.value_,Sj=typeof this.value_,Tj=wj.VALUE_TYPE_ORDER.indexOf(Rj),Uj=wj.VALUE_TYPE_ORDER.indexOf(Sj);return((0,j.hu)(Tj>=0,"Unknown leaf type: "+Rj),(0,j.hu)(Uj>=0,"Unknown leaf type: "+Sj),Tj!==Uj)?Uj-Tj:"object"===Sj?0:this.value_<Qj.value_?-1:this.value_===Qj.value_?0:1}withIndex(){return this}isIndexed(){return!0}equals(Vj){if(Vj===this)return!0;{if(!Vj.isLeafNode())return!1;const Wj=Vj;return this.value_===Wj.value_&&this.priorityNode_.equals(Wj.priorityNode_)}}}wj.VALUE_TYPE_ORDER=["object","boolean","number","string"];let Xj,Yj;const Zj=new class extends Hh{compare($j,_j){const ak=$j.node.getPriority(),bk=_j.node.getPriority(),ck=ak.compareTo(bk);return 0===ck?T($j.name,_j.name):ck}isDefinedOn(dk){return!dk.getPriority().isEmpty()}indexedValueChanged(ek,fk){return!ek.getPriority().equals(fk.getPriority())}minPost(){return Ch.MIN}maxPost(){return new Ch("[MAX_NAME]",new wj("[PRIORITY-POST]",Yj))}makePost(gk,hk){const ik=Xj(gk);return new Ch(hk,new wj("[PRIORITY-POST]",ik))}toString(){return".priority"}}(),jk=Math.log(2);class kk{constructor(lk){this.count=parseInt(Math.log(lk+1)/jk,10),this.current_=this.count-1;const mk=parseInt(Array(this.count+1).join("1"),2);this.bits_=lk+1&mk}nextBitIsOne(){const nk=!(this.bits_&1<<this.current_);return this.current_--,nk}}const ok=function(a,b,c,d){a.sort(b);const e=function(b,d){const f=d-b;let g,h;if(0===f)return null;{if(1===f)return g=a[b],h=c?c(g):g,new fi(h,g.node,fi.BLACK,null,null);const i=parseInt(f/2,10)+b,j=e(b,i),k=e(i+1,d);return g=a[i],h=c?c(g):g,new fi(h,g.node,fi.BLACK,j,k)}},f=new kk(a.length),g=function(b){let d=null,f=null,g=a.length;const h=function(b,d){const f=g-b,h=g;g-=b;const j=e(f+1,h),k=a[f],l=c?c(k):k;i(new fi(l,k.node,d,null,j))},i=function(a){d?(d.left=a,d=a):(f=a,d=a)};for(let j=0;j<b.count;++j){const k=b.nextBitIsOne(),l=Math.pow(2,b.count-(j+1));k?h(l,fi.BLACK):(h(l,fi.BLACK),h(l,fi.RED))}return f}(f);return new Li(d||b,g)};let pk;const qk={};class rk{constructor(sk,tk){this.indexes_=sk,this.indexSet_=tk}static get Default(){return(0,j.hu)(qk&&Zj,"ChildrenNode.ts has not been loaded"),pk=pk||new rk({".priority":qk},{".priority":Zj})}get(uk){const vk=(0,j.DV)(this.indexes_,uk);if(!vk)throw new Error("No index defined for "+uk);return vk instanceof Li?vk:null}hasIndex(wk){return(0,j.r3)(this.indexSet_,wk.toString())}addIndex(xk,yk){(0,j.hu)(xk!==Wh,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const zk=[];let Ak=!1;const Bk=yk.getIterator(Ch.Wrap);let Ck=Bk.getNext();for(;Ck;)Ak=Ak||xk.isDefinedOn(Ck.node),zk.push(Ck),Ck=Bk.getNext();let Dk;Dk=Ak?ok(zk,xk.getCompare()):qk;const Ek=xk.toString(),Fk=Object.assign({},this.indexSet_);Fk[Ek]=xk;const Gk=Object.assign({},this.indexes_);return Gk[Ek]=Dk,new rk(Gk,Fk)}addToIndexes(Hk,Ik){const Jk=(0,j.UI)(this.indexes_,(a,b)=>{const c=(0,j.DV)(this.indexSet_,b);if((0,j.hu)(c,"Missing index implementation for "+b),a===qk){if(!c.isDefinedOn(Hk.node))return qk;{const d=[],e=Ik.getIterator(Ch.Wrap);let f=e.getNext();for(;f;)f.name!==Hk.name&&d.push(f),f=e.getNext();return d.push(Hk),ok(d,c.getCompare())}}{const g=Ik.get(Hk.name);let h=a;return g&&(h=h.remove(new Ch(Hk.name,g))),h.insert(Hk,Hk.node)}});return new rk(Jk,this.indexSet_)}removeFromIndexes(Kk,Lk){const Mk=(0,j.UI)(this.indexes_,a=>{if(a===qk)return a;{const b=Lk.get(Kk.name);return b?a.remove(new Ch(Kk.name,b)):a}});return new rk(Mk,this.indexSet_)}}let Nk;class Ok{constructor(Pk,Qk,Rk){this.children_=Pk,this.priorityNode_=Qk,this.indexMap_=Rk,this.lazyHash_=null,this.priorityNode_&&uj(this.priorityNode_),this.children_.isEmpty()&&(0,j.hu)(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return Nk||(Nk=new Ok(new Li(fj),null,rk.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||Nk}updatePriority(Sk){return this.children_.isEmpty()?this:new Ok(this.children_,Sk,this.indexMap_)}getImmediateChild(Tk){if(".priority"===Tk)return this.getPriority();{const Uk=this.children_.get(Tk);return null===Uk?Nk:Uk}}getChild(Vk){const Wk=ze(Vk);return null===Wk?this:this.getImmediateChild(Wk).getChild(Be(Vk))}hasChild(Xk){return null!==this.children_.get(Xk)}updateImmediateChild(Yk,Zk){if((0,j.hu)(Zk,"We should always be passing snapshot nodes"),".priority"===Yk)return this.updatePriority(Zk);{const $k=new Ch(Yk,Zk);let _k,al;Zk.isEmpty()?(_k=this.children_.remove(Yk),al=this.indexMap_.removeFromIndexes($k,this.children_)):(_k=this.children_.insert(Yk,Zk),al=this.indexMap_.addToIndexes($k,this.children_));const bl=_k.isEmpty()?Nk:this.priorityNode_;return new Ok(_k,bl,al)}}updateChild(cl,dl){const el=ze(cl);if(null===el)return dl;{(0,j.hu)(".priority"!==ze(cl)||1===Ae(cl),".priority must be the last token in a path");const fl=this.getImmediateChild(el).updateChild(Be(cl),dl);return this.updateImmediateChild(el,fl)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(gl){if(this.isEmpty())return null;const hl={};let il=0,jl=0,kl=!0;if(this.forEachChild(Zj,(a,b)=>{hl[a]=b.val(gl),il++,kl&&Ok.INTEGER_REGEXP_.test(a)?jl=Math.max(jl,Number(a)):kl=!1}),gl||!kl||!(jl<2*il))return gl&&!this.getPriority().isEmpty()&&(hl[".priority"]=this.getPriority().val()),hl;{const ll=[];for(const ml in hl)ll[ml]=hl[ml];return ll}}hash(){if(null===this.lazyHash_){let nl="";this.getPriority().isEmpty()||(nl+="priority:"+tj(this.getPriority().val())+":"),this.forEachChild(Zj,(a,b)=>{const c=b.hash();""!==c&&(nl+=":"+a+":"+c)}),this.lazyHash_=""===nl?"":G(nl)}return this.lazyHash_}getPredecessorChildName(ol,pl,ql){const rl=this.resolveIndex_(ql);if(!rl)return this.children_.getPredecessorKey(ol);{const sl=rl.getPredecessorKey(new Ch(ol,pl));return sl?sl.name:null}}getFirstChildName(tl){const ul=this.resolveIndex_(tl);if(!ul)return this.children_.minKey();{const vl=ul.minKey();return vl&&vl.name}}getFirstChild(wl){const xl=this.getFirstChildName(wl);return xl?new Ch(xl,this.children_.get(xl)):null}getLastChildName(yl){const zl=this.resolveIndex_(yl);if(!zl)return this.children_.maxKey();{const Al=zl.maxKey();return Al&&Al.name}}getLastChild(Bl){const Cl=this.getLastChildName(Bl);return Cl?new Ch(Cl,this.children_.get(Cl)):null}forEachChild(Dl,El){const Fl=this.resolveIndex_(Dl);return Fl?Fl.inorderTraversal(a=>El(a.name,a.node)):this.children_.inorderTraversal(El)}getIterator(Gl){return this.getIteratorFrom(Gl.minPost(),Gl)}getIteratorFrom(Hl,Il){const Jl=this.resolveIndex_(Il);if(Jl)return Jl.getIteratorFrom(Hl,a=>a);{const Kl=this.children_.getIteratorFrom(Hl.name,Ch.Wrap);let Ll=Kl.peek();for(;null!=Ll&&0>Il.compare(Ll,Hl);)Kl.getNext(),Ll=Kl.peek();return Kl}}getReverseIterator(Ml){return this.getReverseIteratorFrom(Ml.maxPost(),Ml)}getReverseIteratorFrom(Nl,Ol){const Pl=this.resolveIndex_(Ol);if(Pl)return Pl.getReverseIteratorFrom(Nl,a=>a);{const Ql=this.children_.getReverseIteratorFrom(Nl.name,Ch.Wrap);let Rl=Ql.peek();for(;null!=Rl&&Ol.compare(Rl,Nl)>0;)Ql.getNext(),Rl=Ql.peek();return Ql}}compareTo(Sl){return this.isEmpty()?Sl.isEmpty()?0:-1:Sl.isLeafNode()||Sl.isEmpty()?1:Sl===bm?-1:0}withIndex(Tl){if(Tl===Wh||this.indexMap_.hasIndex(Tl))return this;{const Ul=this.indexMap_.addIndex(Tl,this.children_);return new Ok(this.children_,this.priorityNode_,Ul)}}isIndexed(Vl){return Vl===Wh||this.indexMap_.hasIndex(Vl)}equals(Wl){if(Wl===this)return!0;{if(Wl.isLeafNode())return!1;const Xl=Wl;if(!this.getPriority().equals(Xl.getPriority()))return!1;{if(this.children_.count()!==Xl.children_.count())return!1;const Yl=this.getIterator(Zj),Zl=Xl.getIterator(Zj);let $l=Yl.getNext(),_l=Zl.getNext();for(;$l&&_l;){if($l.name!==_l.name||!$l.node.equals(_l.node))return!1;$l=Yl.getNext(),_l=Zl.getNext()}return null===$l&&null===_l}}}resolveIndex_(am){return am===Wh?null:this.indexMap_.get(am.toString())}}Ok.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;const bm=new class extends Ok{constructor(){super(new Li(fj),Ok.EMPTY_NODE,rk.Default)}compareTo(cm){return cm===this?0:1}equals(dm){return dm===this}getPriority(){return this}getImmediateChild(em){return Ok.EMPTY_NODE}isEmpty(){return!1}}();function fm(a,b=null){if(null===a)return Ok.EMPTY_NODE;if("object"==typeof a&&".priority"in a&&(b=a[".priority"]),(0,j.hu)(null===b||"string"==typeof b||"number"==typeof b||"object"==typeof b&&".sv"in b,"Invalid priority type found: "+typeof b),"object"==typeof a&&".value"in a&&null!==a[".value"]&&(a=a[".value"]),"object"!=typeof a||".sv"in a){const c=a;return new wj(c,fm(b))}if(a instanceof Array||0){let d=Ok.EMPTY_NODE;return X(a,(b,c)=>{if((0,j.r3)(a,b)&&"."!==b.substring(0,1)){const e=fm(c);(e.isLeafNode()||!e.isEmpty())&&(d=d.updateImmediateChild(b,e))}}),d.updatePriority(fm(b))}{const e=[];let f=!1;const g=a;if(X(g,(a,b)=>{if("."!==a.substring(0,1)){const c=fm(b);c.isEmpty()||(f=f||!c.getPriority().isEmpty(),e.push(new Ch(a,c)))}}),0===e.length)return Ok.EMPTY_NODE;const h=ok(e,ej,a=>a.name,fj);if(!f)return new Ok(h,fm(b),rk.Default);{const i=ok(e,Zj.getCompare());return new Ok(h,fm(b),new rk({".priority":i},{".priority":Zj}))}}}Object.defineProperties(Ch,{MIN:{value:new Ch("[MIN_NAME]",Ok.EMPTY_NODE)},MAX:{value:new Ch("[MAX_NAME]",bm)}}),Nh.__EMPTY_NODE=Ok.EMPTY_NODE,wj.__childrenNodeConstructor=Ok,sj=bm,Yj=bm,Xj=fm;class gm extends Hh{constructor(hm){super(),this.indexPath_=hm,(0,j.hu)(!Ge(hm)&&".priority"!==ze(hm),"Can't create PathIndex with empty path or .priority key")}extractChild(im){return im.getChild(this.indexPath_)}isDefinedOn(jm){return!jm.getChild(this.indexPath_).isEmpty()}compare(km,lm){const mm=this.extractChild(km.node),nm=this.extractChild(lm.node),om=mm.compareTo(nm);return 0===om?T(km.name,lm.name):om}makePost(pm,qm){const rm=fm(pm),sm=Ok.EMPTY_NODE.updateChild(this.indexPath_,rm);return new Ch(qm,sm)}maxPost(){const tm=Ok.EMPTY_NODE.updateChild(this.indexPath_,bm);return new Ch("[MAX_NAME]",tm)}toString(){return De(this.indexPath_,0).join("/")}}const um=new class extends Hh{compare(vm,wm){const xm=vm.node.compareTo(wm.node);return 0===xm?T(vm.name,wm.name):xm}isDefinedOn(ym){return!0}indexedValueChanged(zm,Am){return!zm.equals(Am)}minPost(){return Ch.MIN}maxPost(){return Ch.MAX}makePost(Bm,Cm){const Dm=fm(Bm);return new Ch(Cm,Dm)}toString(){return".value"}}();function Em(a){return{type:"value",snapshotNode:a}}function Fm(a,b){return{type:"child_added",snapshotNode:b,childName:a}}function Gm(a,b){return{type:"child_removed",snapshotNode:b,childName:a}}function Hm(a,b,c){return{type:"child_changed",snapshotNode:b,childName:a,oldSnap:c}}class Im{constructor(Jm){this.index_=Jm}updateChild(Km,Lm,Mm,Nm,Om,Pm){(0,j.hu)(Km.isIndexed(this.index_),"A node must be indexed if only a child is updated");const Qm=Km.getImmediateChild(Lm);return Qm.getChild(Nm).equals(Mm.getChild(Nm))&&Qm.isEmpty()===Mm.isEmpty()?Km:(null!=Pm&&(Mm.isEmpty()?Km.hasChild(Lm)?Pm.trackChildChange(Gm(Lm,Qm)):(0,j.hu)(Km.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):Qm.isEmpty()?Pm.trackChildChange(Fm(Lm,Mm)):Pm.trackChildChange(Hm(Lm,Mm,Qm))),Km.isLeafNode()&&Mm.isEmpty())?Km:Km.updateImmediateChild(Lm,Mm).withIndex(this.index_)}updateFullNode(Rm,Sm,Tm){return null==Tm||(Rm.isLeafNode()||Rm.forEachChild(Zj,(a,b)=>{Sm.hasChild(a)||Tm.trackChildChange(Gm(a,b))}),Sm.isLeafNode()||Sm.forEachChild(Zj,(a,b)=>{if(Rm.hasChild(a)){const c=Rm.getImmediateChild(a);c.equals(b)||Tm.trackChildChange(Hm(a,b,c))}else Tm.trackChildChange(Fm(a,b))})),Sm.withIndex(this.index_)}updatePriority(Um,Vm){return Um.isEmpty()?Ok.EMPTY_NODE:Um.updatePriority(Vm)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class Wm{constructor(Xm){this.indexedFilter_=new Im(Xm.getIndex()),this.index_=Xm.getIndex(),this.startPost_=Wm.getStartPost_(Xm),this.endPost_=Wm.getEndPost_(Xm)}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(Ym){return 0>=this.index_.compare(this.getStartPost(),Ym)&&0>=this.index_.compare(Ym,this.getEndPost())}updateChild(Zm,$m,_m,an,bn,cn){return this.matches(new Ch($m,_m))||(_m=Ok.EMPTY_NODE),this.indexedFilter_.updateChild(Zm,$m,_m,an,bn,cn)}updateFullNode(dn,en,fn){en.isLeafNode()&&(en=Ok.EMPTY_NODE);let gn=en.withIndex(this.index_);gn=gn.updatePriority(Ok.EMPTY_NODE);const hn=this;return en.forEachChild(Zj,(a,b)=>{hn.matches(new Ch(a,b))||(gn=gn.updateImmediateChild(a,Ok.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(dn,gn,fn)}updatePriority(jn,kn){return jn}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(ln){if(!ln.hasStart())return ln.getIndex().minPost();{const mn=ln.getIndexStartName();return ln.getIndex().makePost(ln.getIndexStartValue(),mn)}}static getEndPost_(nn){if(!nn.hasEnd())return nn.getIndex().maxPost();{const on=nn.getIndexEndName();return nn.getIndex().makePost(nn.getIndexEndValue(),on)}}}class pn{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=Zj}hasStart(){return this.startSet_}hasStartAfter(){return this.startAfterSet_}hasEndBefore(){return this.endBeforeSet_}isViewFromLeft(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_}getIndexStartValue(){return(0,j.hu)(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return((0,j.hu)(this.startSet_,"Only valid if start has been set"),this.startNameSet_)?this.indexStartName_:"[MIN_NAME]"}hasEnd(){return this.endSet_}getIndexEndValue(){return(0,j.hu)(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return((0,j.hu)(this.endSet_,"Only valid if end has been set"),this.endNameSet_)?this.indexEndName_:"[MAX_NAME]"}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&""!==this.viewFrom_}getLimit(){return(0,j.hu)(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===Zj}copy(){const qn=new pn();return qn.limitSet_=this.limitSet_,qn.limit_=this.limit_,qn.startSet_=this.startSet_,qn.indexStartValue_=this.indexStartValue_,qn.startNameSet_=this.startNameSet_,qn.indexStartName_=this.indexStartName_,qn.endSet_=this.endSet_,qn.indexEndValue_=this.indexEndValue_,qn.endNameSet_=this.endNameSet_,qn.indexEndName_=this.indexEndName_,qn.index_=this.index_,qn.viewFrom_=this.viewFrom_,qn}}function rn(a){const b={};if(a.isDefault())return b;let c;return a.index_===Zj?c="$priority":a.index_===um?c="$value":a.index_===Wh?c="$key":((0,j.hu)(a.index_ instanceof gm,"Unrecognized index type!"),c=a.index_.toString()),b.orderBy=(0,j.Pz)(c),a.startSet_&&(b.startAt=(0,j.Pz)(a.indexStartValue_),a.startNameSet_&&(b.startAt+=","+(0,j.Pz)(a.indexStartName_))),a.endSet_&&(b.endAt=(0,j.Pz)(a.indexEndValue_),a.endNameSet_&&(b.endAt+=","+(0,j.Pz)(a.indexEndName_))),a.limitSet_&&(a.isViewFromLeft()?b.limitToFirst=a.limit_:b.limitToLast=a.limit_),b}function sn(a){const b={};if(a.startSet_&&(b.sp=a.indexStartValue_,a.startNameSet_&&(b.sn=a.indexStartName_)),a.endSet_&&(b.ep=a.indexEndValue_,a.endNameSet_&&(b.en=a.indexEndName_)),a.limitSet_){b.l=a.limit_;let c=a.viewFrom_;""===c&&(c=a.isViewFromLeft()?"l":"r"),b.vf=c}return a.index_!==Zj&&(b.i=a.index_.toString()),b}class tn extends Hd{constructor(un,vn,wn,xn){super(),this.repoInfo_=un,this.onDataUpdate_=vn,this.authTokenProvider_=wn,this.appCheckTokenProvider_=xn,this.log_=M("p:rest:"),this.listens_={}}reportStats(yn){throw new Error("Method not implemented.")}static getListenId_(zn,An){return void 0!==An?"tag$"+An:((0,j.hu)(zn._queryParams.isDefault(),"should have a tag if it's not a default query."),zn._path.toString())}listen(Bn,Cn,Dn,En){const Fn=Bn._path.toString();this.log_("Listen called for "+Fn+" "+Bn._queryIdentifier);const Gn=tn.getListenId_(Bn,Dn),Hn={};this.listens_[Gn]=Hn;const In=rn(Bn._queryParams);this.restRequest_(Fn+".json",In,(a,b)=>{let c=b;404===a&&(c=null,a=null),null===a&&this.onDataUpdate_(Fn,c,!1,Dn),(0,j.DV)(this.listens_,Gn)===Hn&&En(a?401===a?"permission_denied":"rest_error:"+a:"ok",null)})}unlisten(Jn,Kn){const Ln=tn.getListenId_(Jn,Kn);delete this.listens_[Ln]}get(Mn){const Nn=rn(Mn._queryParams),On=Mn._path.toString(),Pn=new j.BH();return this.restRequest_(On+".json",Nn,(a,b)=>{let c=b;404===a&&(c=null,a=null),null===a?(this.onDataUpdate_(On,c,!1,null),Pn.resolve(c)):Pn.reject(new Error(c))}),Pn.promise}refreshAuthToken(Qn){}restRequest_(Rn,Sn={},Tn){return Sn.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([a,b])=>{a&&a.accessToken&&(Sn.auth=a.accessToken),b&&b.token&&(Sn.ac=b.token);const c=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+Rn+"?ns="+this.repoInfo_.namespace+(0,j.xO)(Sn);this.log_("Sending REST request for "+c);const d=new XMLHttpRequest();d.onreadystatechange=()=>{if(Tn&&4===d.readyState){this.log_("REST Response for "+c+" received. status:",d.status,"response:",d.responseText);let a=null;if(d.status>=200&&d.status<300){try{a=(0,j.cI)(d.responseText)}catch(b){P("Failed to parse JSON response for "+c+": "+d.responseText)}Tn(null,a)}else 401!==d.status&&404!==d.status&&P("Got unsuccessful REST response for "+c+" Status: "+d.status),Tn(d.status);Tn=null}},d.open("GET",c,!0),d.send()})}}class Un{constructor(){this.rootNode_=Ok.EMPTY_NODE}getNode(Vn){return this.rootNode_.getChild(Vn)}updateSnapshot(Wn,Xn){this.rootNode_=this.rootNode_.updateChild(Wn,Xn)}}function Yn(){return{value:null,children:new Map()}}function Zn(a,b,c){if(Ge(b))a.value=c,a.children.clear();else if(null!==a.value)a.value=a.value.updateChild(b,c);else{const d=ze(b);a.children.has(d)||a.children.set(d,Yn());const e=a.children.get(d);Zn(e,b=Be(b),c)}}function $n(a,b){if(Ge(b))return a.value=null,a.children.clear(),!0;if(null!==a.value){if(a.value.isLeafNode())return!1;{const c=a.value;return a.value=null,c.forEachChild(Zj,(b,c)=>{Zn(a,new re(b),c)}),$n(a,b)}}{if(!(a.children.size>0))return!0;const d=ze(b);if(b=Be(b),a.children.has(d)){const e=$n(a.children.get(d),b);e&&a.children.delete(d)}return 0===a.children.size}}function _n(a,b,c){null!==a.value?c(b,a.value):ao(a,(a,d)=>{const e=new re(b.toString()+"/"+a);_n(d,e,c)})}function ao(a,b){a.children.forEach((a,c)=>{b(c,a)})}class bo{constructor(co,eo){this.server_=eo,this.statsToReport_={},this.statsListener_=new class{constructor(fo){this.collection_=fo,this.last_=null}get(){const go=this.collection_.get(),ho=Object.assign({},go);return this.last_&&X(this.last_,(a,b)=>{ho[a]=ho[a]-b}),this.last_=go,ho}}(co),ba(this.reportStats_.bind(this),Math.floor(10e3+20e3*Math.random()))}reportStats_(){const io=this.statsListener_.get(),jo={};let ko=!1;X(io,(a,b)=>{b>0&&(0,j.r3)(this.statsToReport_,a)&&(jo[a]=b,ko=!0)}),ko&&this.server_.reportStats(jo),ba(this.reportStats_.bind(this),Math.floor(2*Math.random()*30e4))}}function lo(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function mo(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function no(a){return{fromUser:!1,fromServer:!0,queryId:a,tagged:!0}}(d=g||(g={}))[d.OVERWRITE=0]="OVERWRITE",d[d.MERGE=1]="MERGE",d[d.ACK_USER_WRITE=2]="ACK_USER_WRITE",d[d.LISTEN_COMPLETE=3]="LISTEN_COMPLETE";class oo{constructor(po,qo,ro){this.path=po,this.affectedTree=qo,this.revert=ro,this.type=g.ACK_USER_WRITE,this.source=lo()}operationForChild(so){if(!Ge(this.path))return(0,j.hu)(ze(this.path)===so,"operationForChild called for unrelated child."),new oo(Be(this.path),this.affectedTree,this.revert);{if(null!=this.affectedTree.value)return(0,j.hu)(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;const to=this.affectedTree.subtree(new re(so));return new oo(ye(),to,this.revert)}}}class uo{constructor(vo,wo){this.source=vo,this.path=wo,this.type=g.LISTEN_COMPLETE}operationForChild(xo){return Ge(this.path)?new uo(this.source,ye()):new uo(this.source,Be(this.path))}}class yo{constructor(zo,Ao,Bo){this.source=zo,this.path=Ao,this.snap=Bo,this.type=g.OVERWRITE}operationForChild(Co){return Ge(this.path)?new yo(this.source,ye(),this.snap.getImmediateChild(Co)):new yo(this.source,Be(this.path),this.snap)}}class Do{constructor(Eo,Fo,Go){this.source=Eo,this.path=Fo,this.children=Go,this.type=g.MERGE}operationForChild(Ho){if(!Ge(this.path))return(0,j.hu)(ze(this.path)===Ho,"Can't get a merge for a child not on the path of the operation"),new Do(this.source,Be(this.path),this.children);{const Io=this.children.subtree(new re(Ho));return Io.isEmpty()?null:Io.value?new yo(this.source,ye(),Io.value):new Do(this.source,ye(),Io)}}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class Jo{constructor(Ko,Lo,Mo){this.node_=Ko,this.fullyInitialized_=Lo,this.filtered_=Mo}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(No){if(Ge(No))return this.isFullyInitialized()&&!this.filtered_;const Oo=ze(No);return this.isCompleteForChild(Oo)}isCompleteForChild(Po){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(Po)}getNode(){return this.node_}}function Qo(a,b,c,d,e,f){const g=d.filter(a=>a.type===c);g.sort((b,c)=>So(a,b,c)),g.forEach(c=>{const d=Ro(a,c,f);e.forEach(e=>{e.respondsTo(c.type)&&b.push(e.createEvent(d,a.query_))})})}function Ro(a,b,c){return"value"===b.type||"child_removed"===b.type||(b.prevName=c.getPredecessorChildName(b.childName,b.snapshotNode,a.index_)),b}function So(a,b,c){if(null==b.childName||null==c.childName)throw(0,j.g5)("Should only compare child_ events.");const d=new Ch(b.childName,b.snapshotNode),e=new Ch(c.childName,c.snapshotNode);return a.index_.compare(d,e)}function To(a,b){return{eventCache:a,serverCache:b}}function Uo(a,b,c,d){return To(new Jo(b,c,d),a.serverCache)}function Vo(a,b,c,d){return To(a.eventCache,new Jo(b,c,d))}function Wo(a){return a.eventCache.isFullyInitialized()?a.eventCache.getNode():null}function Xo(a){return a.serverCache.isFullyInitialized()?a.serverCache.getNode():null}let Yo;class Zo{constructor($o,_o=(Yo||(Yo=new Li(function(a,b){return a===b?0:a<b?-1:1})),Yo)){this.value=$o,this.children=_o}static fromObject(ap){let bp=new Zo(null);return X(ap,(a,b)=>{bp=bp.set(new re(a),b)}),bp}isEmpty(){return null===this.value&&this.children.isEmpty()}findRootMostMatchingPathAndValue(cp,dp){if(null!=this.value&&dp(this.value))return{path:ye(),value:this.value};if(Ge(cp))return null;{const ep=ze(cp),fp=this.children.get(ep);if(null===fp)return null;{const gp=fp.findRootMostMatchingPathAndValue(Be(cp),dp);if(null==gp)return null;{const hp=Fe(new re(ep),gp.path);return{path:hp,value:gp.value}}}}}findRootMostValueAndPath(ip){return this.findRootMostMatchingPathAndValue(ip,()=>!0)}subtree(jp){if(Ge(jp))return this;{const kp=ze(jp),lp=this.children.get(kp);return null!==lp?lp.subtree(Be(jp)):new Zo(null)}}set(mp,np){if(Ge(mp))return new Zo(np,this.children);{const op=ze(mp),pp=this.children.get(op)||new Zo(null),qp=pp.set(Be(mp),np),rp=this.children.insert(op,qp);return new Zo(this.value,rp)}}remove(sp){if(Ge(sp))return this.children.isEmpty()?new Zo(null):new Zo(null,this.children);{const tp=ze(sp),up=this.children.get(tp);if(!up)return this;{const vp=up.remove(Be(sp));let wp;return(wp=vp.isEmpty()?this.children.remove(tp):this.children.insert(tp,vp),null===this.value&&wp.isEmpty())?new Zo(null):new Zo(this.value,wp)}}}get(xp){if(Ge(xp))return this.value;{const yp=ze(xp),zp=this.children.get(yp);return zp?zp.get(Be(xp)):null}}setTree(Ap,Bp){if(Ge(Ap))return Bp;{const Cp=ze(Ap),Dp=this.children.get(Cp)||new Zo(null),Ep=Dp.setTree(Be(Ap),Bp);let Fp;return Fp=Ep.isEmpty()?this.children.remove(Cp):this.children.insert(Cp,Ep),new Zo(this.value,Fp)}}fold(Gp){return this.fold_(ye(),Gp)}fold_(Hp,Ip){const Jp={};return this.children.inorderTraversal((a,b)=>{Jp[a]=b.fold_(Fe(Hp,a),Ip)}),Ip(Hp,this.value,Jp)}findOnPath(Kp,Lp){return this.findOnPath_(Kp,ye(),Lp)}findOnPath_(Mp,Np,Op){const Pp=!!this.value&&Op(Np,this.value);if(Pp)return Pp;if(Ge(Mp))return null;{const Qp=ze(Mp),Rp=this.children.get(Qp);return Rp?Rp.findOnPath_(Be(Mp),Fe(Np,Qp),Op):null}}foreachOnPath(Sp,Tp){return this.foreachOnPath_(Sp,ye(),Tp)}foreachOnPath_(Up,Vp,Wp){if(Ge(Up))return this;{this.value&&Wp(Vp,this.value);const Xp=ze(Up),Yp=this.children.get(Xp);return Yp?Yp.foreachOnPath_(Be(Up),Fe(Vp,Xp),Wp):new Zo(null)}}foreach(Zp){this.foreach_(ye(),Zp)}foreach_($p,_p){this.children.inorderTraversal((a,b)=>{b.foreach_(Fe($p,a),_p)}),this.value&&_p($p,this.value)}foreachChild(aq){this.children.inorderTraversal((a,b)=>{b.value&&aq(a,b.value)})}}class bq{constructor(cq){this.writeTree_=cq}static empty(){return new bq(new Zo(null))}}function dq(a,b,c){if(Ge(b))return new bq(new Zo(c));{const d=a.writeTree_.findRootMostValueAndPath(b);if(null!=d){const e=d.path;let f=d.value;const g=He(e,b);return f=f.updateChild(g,c),new bq(a.writeTree_.set(e,f))}{const h=new Zo(c),i=a.writeTree_.setTree(b,h);return new bq(i)}}}function eq(a,b,c){let d=a;return X(c,(a,c)=>{d=dq(d,Fe(b,a),c)}),d}function fq(a,b){if(Ge(b))return bq.empty();{const c=a.writeTree_.setTree(b,new Zo(null));return new bq(c)}}function gq(a,b){return null!=hq(a,b)}function hq(a,b){const c=a.writeTree_.findRootMostValueAndPath(b);return null!=c?a.writeTree_.get(c.path).getChild(He(c.path,b)):null}function iq(a){const b=[],c=a.writeTree_.value;return null!=c?c.isLeafNode()||c.forEachChild(Zj,(a,c)=>{b.push(new Ch(a,c))}):a.writeTree_.children.inorderTraversal((a,c)=>{null!=c.value&&b.push(new Ch(a,c.value))}),b}function jq(a,b){if(Ge(b))return a;{const c=hq(a,b);return new bq(null!=c?new Zo(c):a.writeTree_.subtree(b))}}function kq(a){return a.writeTree_.isEmpty()}function lq(a,b){return mq(ye(),a.writeTree_,b)}function mq(a,b,c){if(null!=b.value)return c.updateChild(a,b.value);{let d=null;return b.children.inorderTraversal((b,e)=>{".priority"===b?((0,j.hu)(null!==e.value,"Priority writes must always be leaf nodes"),d=e.value):c=mq(Fe(a,b),e,c)}),c.getChild(a).isEmpty()||null===d||(c=c.updateChild(Fe(a,".priority"),d)),c}}function nq(a,b){return yq(b,a)}function oq(a,b){if(a.snap)return Je(a.path,b);for(const c in a.children)if(a.children.hasOwnProperty(c)&&Je(Fe(a.path,c),b))return!0;return!1}function pq(a){return a.visible}function qq(a,b,c){let d=bq.empty();for(let e=0;e<a.length;++e){const f=a[e];if(b(f)){const g=f.path;let h;if(f.snap)Je(c,g)?d=dq(d,h=He(c,g),f.snap):Je(g,c)&&(h=He(g,c),d=dq(d,ye(),f.snap.getChild(h)));else if(f.children){if(Je(c,g))d=eq(d,h=He(c,g),f.children);else if(Je(g,c))if(Ge(h=He(g,c)))d=eq(d,ye(),f.children);else{const i=(0,j.DV)(f.children,ze(h));if(i){const k=i.getChild(Be(h));d=dq(d,ye(),k)}}}else throw(0,j.g5)("WriteRecord should have .snap or .children")}}return d}function rq(a,b,c,d,e){if(d||e){const f=jq(a.visibleWrites,b);if(!e&&kq(f))return c;if(!e&&null==c&&!gq(f,ye()))return null;{const g=function(a){return(a.visible||e)&&(!d||!~d.indexOf(a.writeId))&&(Je(a.path,b)||Je(b,a.path))},h=qq(a.allWrites,g,b),i=c||Ok.EMPTY_NODE;return lq(h,i)}}{const j=hq(a.visibleWrites,b);if(null!=j)return j;{const k=jq(a.visibleWrites,b);if(kq(k))return c;{if(null==c&&!gq(k,ye()))return null;const l=c||Ok.EMPTY_NODE;return lq(k,l)}}}}function sq(a,b,c,d){return rq(a.writeTree,a.treePath,b,c,d)}function tq(a,b){return(function(a,b,c){let d=Ok.EMPTY_NODE;const e=hq(a.visibleWrites,b);if(e)return e.isLeafNode()||e.forEachChild(Zj,(a,b)=>{d=d.updateImmediateChild(a,b)}),d;if(c){const f=jq(a.visibleWrites,b);return c.forEachChild(Zj,(a,b)=>{const c=lq(jq(f,new re(a)),b);d=d.updateImmediateChild(a,c)}),iq(f).forEach(a=>{d=d.updateImmediateChild(a.name,a.node)}),d}{const g=jq(a.visibleWrites,b);return iq(g).forEach(a=>{d=d.updateImmediateChild(a.name,a.node)}),d}})(a.writeTree,a.treePath,b)}function uq(a,b,c,d){return(function(a,b,c,d,e){(0,j.hu)(d||e,"Either existingEventSnap or existingServerSnap must exist");const f=Fe(b,c);if(gq(a.visibleWrites,f))return null;{const g=jq(a.visibleWrites,f);return kq(g)?e.getChild(c):lq(g,e.getChild(c))}})(a.writeTree,a.treePath,b,c,d)}function vq(a,b){var c;return a.writeTree,c=Fe(a.treePath,b),hq(a.writeTree.visibleWrites,c)}function wq(a,b,c){return(function(a,b,c,d){const e=Fe(b,c),f=hq(a.visibleWrites,e);if(null!=f)return f;if(!d.isCompleteForChild(c))return null;{const g=jq(a.visibleWrites,e);return lq(g,d.getNode().getImmediateChild(c))}})(a.writeTree,a.treePath,b,c)}function xq(a,b){return yq(Fe(a.treePath,b),a.writeTree)}function yq(a,b){return{treePath:a,writeTree:b}}class zq{constructor(){this.changeMap=new Map()}trackChildChange(Aq){const Bq=Aq.type,Cq=Aq.childName;(0,j.hu)("child_added"===Bq||"child_changed"===Bq||"child_removed"===Bq,"Only child changes supported for tracking"),(0,j.hu)(".priority"!==Cq,"Only non-priority child changes can be tracked.");const Dq=this.changeMap.get(Cq);if(Dq){const Eq=Dq.type;if("child_added"===Bq&&"child_removed"===Eq)this.changeMap.set(Cq,Hm(Cq,Aq.snapshotNode,Dq.snapshotNode));else if("child_removed"===Bq&&"child_added"===Eq)this.changeMap.delete(Cq);else if("child_removed"===Bq&&"child_changed"===Eq)this.changeMap.set(Cq,Gm(Cq,Dq.oldSnap));else if("child_changed"===Bq&&"child_added"===Eq)this.changeMap.set(Cq,Fm(Cq,Aq.snapshotNode));else if("child_changed"===Bq&&"child_changed"===Eq)this.changeMap.set(Cq,Hm(Cq,Aq.snapshotNode,Dq.oldSnap));else throw(0,j.g5)("Illegal combination of changes: "+Aq+" occurred after "+Dq)}else this.changeMap.set(Cq,Aq)}getChanges(){return Array.from(this.changeMap.values())}}const Fq=new class{getCompleteChild(Gq){return null}getChildAfterChild(Hq,Iq,Jq){return null}}();class Kq{constructor(Lq,Mq,Nq=null){this.writes_=Lq,this.viewCache_=Mq,this.optCompleteServerCache_=Nq}getCompleteChild(Oq){const Pq=this.viewCache_.eventCache;if(Pq.isCompleteForChild(Oq))return Pq.getNode().getImmediateChild(Oq);{const Qq=null!=this.optCompleteServerCache_?new Jo(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return wq(this.writes_,Oq,Qq)}}getChildAfterChild(Rq,Sq,Tq){var Uq,Vq,Wq,Xq,Yq;const Zq=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:Xo(this.viewCache_),$q=(Uq=this.writes_,Vq=Zq,Wq=Sq,Xq=Tq,Yq=Rq,function(a,b,c,d,e,f,g){let h;const i=jq(a.visibleWrites,b),j=hq(i,ye());if(null!=j)h=j;else{if(null==c)return[];h=lq(i,c)}if((h=h.withIndex(g)).isEmpty()||h.isLeafNode())return[];{const k=[],l=g.getCompare(),m=f?h.getReverseIteratorFrom(d,g):h.getIteratorFrom(d,g);let n=m.getNext();for(;n&&k.length<1;)0!==l(n,d)&&k.push(n),n=m.getNext();return k}}(Uq.writeTree,Uq.treePath,Vq,Wq,1,Xq,Yq));return 0===$q.length?null:$q[0]}}function _q(a,b,c,d,e,f){const g=b.eventCache;if(null!=vq(d,c))return b;{let h,i;if(Ge(c))if((0,j.hu)(b.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),b.serverCache.isFiltered()){const k=Xo(b),l=k instanceof Ok?k:Ok.EMPTY_NODE,m=tq(d,l);h=a.filter.updateFullNode(b.eventCache.getNode(),m,f)}else{const n=sq(d,Xo(b));h=a.filter.updateFullNode(b.eventCache.getNode(),n,f)}else{const o=ze(c);if(".priority"===o){(0,j.hu)(1===Ae(c),"Can't have a priority with additional path components");const p=g.getNode();i=b.serverCache.getNode();const q=uq(d,c,p,i);h=null!=q?a.filter.updatePriority(p,q):g.getNode()}else{const r=Be(c);let s;if(g.isCompleteForChild(o)){i=b.serverCache.getNode();const t=uq(d,c,g.getNode(),i);s=null!=t?g.getNode().getImmediateChild(o).updateChild(r,t):g.getNode().getImmediateChild(o)}else s=wq(d,o,b.serverCache);h=null!=s?a.filter.updateChild(g.getNode(),o,s,r,e,f):g.getNode()}}return Uo(b,h,g.isFullyInitialized()||Ge(c),a.filter.filtersNodes())}}function ar(a,b,c,d,e,f,g,h){const i=b.serverCache;let j;const k=g?a.filter:a.filter.getIndexedFilter();if(Ge(c))j=k.updateFullNode(i.getNode(),d,null);else if(k.filtersNodes()&&!i.isFiltered()){const l=i.getNode().updateChild(c,d);j=k.updateFullNode(i.getNode(),l,null)}else{const m=ze(c);if(!i.isCompleteForPath(c)&&Ae(c)>1)return b;const n=Be(c),o=i.getNode().getImmediateChild(m),p=o.updateChild(n,d);j=".priority"===m?k.updatePriority(i.getNode(),p):k.updateChild(i.getNode(),m,p,n,Fq,null)}const q=Vo(b,j,i.isFullyInitialized()||Ge(c),k.filtersNodes()),r=new Kq(e,q,f);return _q(a,q,c,e,r,h)}function br(a,b,c,d,e,f,g){const h=b.eventCache;let i,j;const k=new Kq(e,b,f);if(Ge(c))j=a.filter.updateFullNode(b.eventCache.getNode(),d,g),i=Uo(b,j,!0,a.filter.filtersNodes());else{const l=ze(c);if(".priority"===l)j=a.filter.updatePriority(b.eventCache.getNode(),d),i=Uo(b,j,h.isFullyInitialized(),h.isFiltered());else{const m=Be(c),n=h.getNode().getImmediateChild(l);let o;if(Ge(m))o=d;else{const p=k.getCompleteChild(l);o=null!=p?".priority"===Ce(m)&&p.getChild(Ee(m)).isEmpty()?p:p.updateChild(m,d):Ok.EMPTY_NODE}if(n.equals(o))i=b;else{const q=a.filter.updateChild(h.getNode(),l,o,m,k,g);i=Uo(b,q,h.isFullyInitialized(),a.filter.filtersNodes())}}}return i}function cr(a,b){return a.eventCache.isCompleteForChild(b)}function dr(a,b,c){return c.foreach((a,c)=>{b=b.updateChild(a,c)}),b}function er(a,b,c,d,e,f,g,h){if(b.serverCache.getNode().isEmpty()&&!b.serverCache.isFullyInitialized())return b;let i=b,j;j=Ge(c)?d:new Zo(null).setTree(c,d);const k=b.serverCache.getNode();return j.children.inorderTraversal((c,d)=>{if(k.hasChild(c)){const j=b.serverCache.getNode().getImmediateChild(c),l=dr(a,j,d);i=ar(a,i,new re(c),l,e,f,g,h)}}),j.children.inorderTraversal((c,d)=>{const j=!b.serverCache.isCompleteForChild(c)&& void 0===d.value;if(!k.hasChild(c)&&!j){const l=b.serverCache.getNode().getImmediateChild(c),m=dr(a,l,d);i=ar(a,i,new re(c),m,e,f,g,h)}}),i}class fr{constructor(gr,hr){var ir,jr;this.query_=gr,this.eventRegistrations_=[];const kr=this.query_._queryParams,lr=new Im(kr.getIndex()),mr=(ir=kr).loadsAllData()?new Im(ir.getIndex()):ir.hasLimit()?new class{constructor(nr){this.rangedFilter_=new Wm(nr),this.index_=nr.getIndex(),this.limit_=nr.getLimit(),this.reverse_=!nr.isViewFromLeft()}updateChild(or,pr,qr,rr,sr,tr){return(this.rangedFilter_.matches(new Ch(pr,qr))||(qr=Ok.EMPTY_NODE),or.getImmediateChild(pr).equals(qr))?or:or.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(or,pr,qr,rr,sr,tr):this.fullLimitUpdateChild_(or,pr,qr,sr,tr)}updateFullNode(ur,vr,wr){let xr;if(vr.isLeafNode()||vr.isEmpty())xr=Ok.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<vr.numChildren()&&vr.isIndexed(this.index_)){xr=Ok.EMPTY_NODE.withIndex(this.index_);let yr;yr=this.reverse_?vr.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):vr.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let zr=0;for(;yr.hasNext()&&zr<this.limit_;){const Ar=yr.getNext();if(this.reverse_?0>=this.index_.compare(this.rangedFilter_.getStartPost(),Ar):0>=this.index_.compare(Ar,this.rangedFilter_.getEndPost()))xr=xr.updateImmediateChild(Ar.name,Ar.node),zr++;else break}}else{xr=(xr=vr.withIndex(this.index_)).updatePriority(Ok.EMPTY_NODE);let Br,Cr,Dr,Er;if(this.reverse_){Er=xr.getReverseIterator(this.index_),Br=this.rangedFilter_.getEndPost(),Cr=this.rangedFilter_.getStartPost();const Fr=this.index_.getCompare();Dr=(a,b)=>Fr(b,a)}else Er=xr.getIterator(this.index_),Br=this.rangedFilter_.getStartPost(),Cr=this.rangedFilter_.getEndPost(),Dr=this.index_.getCompare();let Gr=0,Hr=!1;for(;Er.hasNext();){const Ir=Er.getNext();!Hr&&0>=Dr(Br,Ir)&&(Hr=!0);const Jr=Hr&&Gr<this.limit_&&0>=Dr(Ir,Cr);Jr?Gr++:xr=xr.updateImmediateChild(Ir.name,Ok.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(ur,xr,wr)}updatePriority(Kr,Lr){return Kr}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(Mr,Nr,Or,Pr,Qr){let Rr;if(this.reverse_){const Sr=this.index_.getCompare();Rr=(a,b)=>Sr(b,a)}else Rr=this.index_.getCompare();const Tr=Mr;(0,j.hu)(Tr.numChildren()===this.limit_,"");const Ur=new Ch(Nr,Or),Vr=this.reverse_?Tr.getFirstChild(this.index_):Tr.getLastChild(this.index_),Wr=this.rangedFilter_.matches(Ur);if(Tr.hasChild(Nr)){const Xr=Tr.getImmediateChild(Nr);let Yr=Pr.getChildAfterChild(this.index_,Vr,this.reverse_);for(;null!=Yr&&(Yr.name===Nr||Tr.hasChild(Yr.name));)Yr=Pr.getChildAfterChild(this.index_,Yr,this.reverse_);const Zr=null==Yr?1:Rr(Yr,Ur),$r=Wr&&!Or.isEmpty()&&Zr>=0;if($r)return null!=Qr&&Qr.trackChildChange(Hm(Nr,Or,Xr)),Tr.updateImmediateChild(Nr,Or);{null!=Qr&&Qr.trackChildChange(Gm(Nr,Xr));const _r=Tr.updateImmediateChild(Nr,Ok.EMPTY_NODE),as=null!=Yr&&this.rangedFilter_.matches(Yr);return as?(null!=Qr&&Qr.trackChildChange(Fm(Yr.name,Yr.node)),_r.updateImmediateChild(Yr.name,Yr.node)):_r}}return Or.isEmpty()?Mr:Wr&&Rr(Vr,Ur)>=0?(null!=Qr&&(Qr.trackChildChange(Gm(Vr.name,Vr.node)),Qr.trackChildChange(Fm(Nr,Or))),Tr.updateImmediateChild(Nr,Or).updateImmediateChild(Vr.name,Ok.EMPTY_NODE)):Mr}}(ir):new Wm(ir);this.processor_=(jr=mr,{filter:jr});const bs=hr.serverCache,cs=hr.eventCache,ds=lr.updateFullNode(Ok.EMPTY_NODE,bs.getNode(),null),es=mr.updateFullNode(Ok.EMPTY_NODE,cs.getNode(),null),fs=new Jo(ds,bs.isFullyInitialized(),lr.filtersNodes()),gs=new Jo(es,cs.isFullyInitialized(),mr.filtersNodes());this.viewCache_=To(gs,fs),this.eventGenerator_=new class{constructor(hs){this.query_=hs,this.index_=this.query_._queryParams.getIndex()}}(this.query_)}get query(){return this.query_}}function is(a,b){const c=Xo(a.viewCache_);return c&&(a.query._queryParams.loadsAllData()|| !Ge(b)&&!c.getImmediateChild(ze(b)).isEmpty())?c.getChild(b):null}function js(a){return 0===a.eventRegistrations_.length}function ks(a,b,c){const d=[];if(c){(0,j.hu)(null==b,"A cancel should cancel all event registrations.");const e=a.query._path;a.eventRegistrations_.forEach(a=>{const b=a.createCancelEvent(c,e);b&&d.push(b)})}if(b){let f=[];for(let g=0;g<a.eventRegistrations_.length;++g){const h=a.eventRegistrations_[g];if(h.matches(b)){if(b.hasAnyCallback()){f=f.concat(a.eventRegistrations_.slice(g+1));break}}else f.push(h)}a.eventRegistrations_=f}else a.eventRegistrations_=[];return d}function ls(a,b,c,d){var e,f;b.type===g.MERGE&&null!==b.source.queryId&&((0,j.hu)(Xo(a.viewCache_),"We should always have a full cache before handling merges"),(0,j.hu)(Wo(a.viewCache_),"Missing event cache, even though we have a server cache"));const h=a.viewCache_,i=function(a,b,c,d,e){const f=new zq();let h,i;if(c.type===g.OVERWRITE){const k=c;k.source.fromUser?h=br(a,b,k.path,k.snap,d,e,f):((0,j.hu)(k.source.fromServer,"Unknown source."),i=k.source.tagged||b.serverCache.isFiltered()&&!Ge(k.path),h=ar(a,b,k.path,k.snap,d,e,i,f))}else if(c.type===g.MERGE){var l,m,n,o,p,q,r;const s=c;let t;s.source.fromUser?h=(l=a,m=b,n=s.path,o=s.children,p=d,q=e,r=f,t=m,o.foreach((a,b)=>{const c=Fe(n,a);cr(m,ze(c))&&(t=br(l,t,c,b,p,q,r))}),o.foreach((a,b)=>{const c=Fe(n,a);cr(m,ze(c))||(t=br(l,t,c,b,p,q,r))}),t):((0,j.hu)(s.source.fromServer,"Unknown source."),i=s.source.tagged||b.serverCache.isFiltered(),h=er(a,b,s.path,s.children,d,e,i,f))}else if(c.type===g.ACK_USER_WRITE){const u=c;h=u.revert?(function(a,b,c,d,e,f){let g;if(null!=vq(d,c))return b;{const h=new Kq(d,b,e),i=b.eventCache.getNode();let k;if(Ge(c)||".priority"===ze(c)){let l;if(b.serverCache.isFullyInitialized())l=sq(d,Xo(b));else{const m=b.serverCache.getNode();(0,j.hu)(m instanceof Ok,"serverChildren would be complete if leaf node"),l=tq(d,m)}l=l,k=a.filter.updateFullNode(i,l,f)}else{const n=ze(c);let o=wq(d,n,b.serverCache);null==o&&b.serverCache.isCompleteForChild(n)&&(o=i.getImmediateChild(n)),(k=null!=o?a.filter.updateChild(i,n,o,Be(c),h,f):b.eventCache.getNode().hasChild(n)?a.filter.updateChild(i,n,Ok.EMPTY_NODE,Be(c),h,f):i).isEmpty()&&b.serverCache.isFullyInitialized()&&(g=sq(d,Xo(b))).isLeafNode()&&(k=a.filter.updateFullNode(k,g,f))}return g=b.serverCache.isFullyInitialized()||null!=vq(d,ye()),Uo(b,k,g,a.filter.filtersNodes())}})(a,b,u.path,d,e,f):(function(a,b,c,d,e,f,g){if(null!=vq(e,c))return b;const h=b.serverCache.isFiltered(),i=b.serverCache;if(null!=d.value){if(Ge(c)&&i.isFullyInitialized()||i.isCompleteForPath(c))return ar(a,b,c,i.getNode().getChild(c),e,f,h,g);{if(!Ge(c))return b;let j=new Zo(null);return i.getNode().forEachChild(Wh,(a,b)=>{j=j.set(new re(a),b)}),er(a,b,c,j,e,f,h,g)}}{let k=new Zo(null);return d.foreach((a,b)=>{const d=Fe(c,a);i.isCompleteForPath(d)&&(k=k.set(a,i.getNode().getChild(d)))}),er(a,b,c,k,e,f,h,g)}})(a,b,u.path,u.affectedTree,d,e,f)}else if(c.type===g.LISTEN_COMPLETE)h=(function(a,b,c,d,e){const f=b.serverCache,g=Vo(b,f.getNode(),f.isFullyInitialized()||Ge(c),f.isFiltered());return _q(a,g,c,d,Fq,e)})(a,b,c.path,d,f);else throw(0,j.g5)("Unknown operation type: "+c.type);const v=f.getChanges();return(function(a,b,c){const d=b.eventCache;if(d.isFullyInitialized()){const e=d.getNode().isLeafNode()||d.getNode().isEmpty(),f=Wo(a);!(c.length>0)&&a.eventCache.isFullyInitialized()&&(!e||d.getNode().equals(f))&&d.getNode().getPriority().equals(f.getPriority())||c.push(Em(Wo(b)))}})(b,h,v),{viewCache:h,changes:v}}(a.processor_,h,b,c,d);return e=a.processor_,f=i.viewCache,(0,j.hu)(f.eventCache.getNode().isIndexed(e.filter.getIndex()),"Event snap not indexed"),(0,j.hu)(f.serverCache.getNode().isIndexed(e.filter.getIndex()),"Server snap not indexed"),(0,j.hu)(i.viewCache.serverCache.isFullyInitialized()||!h.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),a.viewCache_=i.viewCache,ms(a,i.changes,i.viewCache.eventCache.getNode(),null)}function ms(a,b,c,d){const e=d?[d]:a.eventRegistrations_;return(function(a,b,c,d){const e=[],f=[];return b.forEach(b=>{if("child_changed"===b.type&&a.index_.indexedValueChanged(b.oldSnap,b.snapshotNode)){var c,d;f.push((c=b.childName,d=b.snapshotNode,{type:"child_moved",snapshotNode:d,childName:c}))}}),Qo(a,e,"child_removed",b,d,c),Qo(a,e,"child_added",b,d,c),Qo(a,e,"child_moved",f,d,c),Qo(a,e,"child_changed",b,d,c),Qo(a,e,"value",b,d,c),e})(a.eventGenerator_,b,c,e)}let ns;class os{constructor(){this.views=new Map()}}function ps(a,b,c,d){const e=b.source.queryId;if(null!==e){const f=a.views.get(e);return(0,j.hu)(null!=f,"SyncTree gave us an op for an invalid query."),ls(f,b,c,d)}{let g=[];for(const h of a.views.values())g=g.concat(ls(h,b,c,d));return g}}function qs(a){const b=[];for(const c of a.views.values())c.query._queryParams.loadsAllData()||b.push(c);return b}function rs(a,b){let c=null;for(const d of a.views.values())c=c||is(d,b);return c}function ss(a,b){const c=b._queryParams;if(c.loadsAllData())return vs(a);{const d=b._queryIdentifier;return a.views.get(d)}}function ts(a,b){return null!=ss(a,b)}function us(a){return null!=vs(a)}function vs(a){for(const b of a.views.values())if(b.query._queryParams.loadsAllData())return b;return null}let ws,xs=1;class ys{constructor(zs){this.listenProvider_=zs,this.syncPointTree_=new Zo(null),this.pendingWriteTree_={visibleWrites:bq.empty(),allWrites:[],lastWriteId:-1},this.tagToQueryMap=new Map(),this.queryToTagMap=new Map()}}function As(a,b,c,d,e){var f,g,h,i,k;return(f=a.pendingWriteTree_,g=b,h=c,i=d,k=e,(0,j.hu)(i>f.lastWriteId,"Stacking an older write on top of newer ones"),void 0===k&&(k=!0),f.allWrites.push({path:g,snap:h,writeId:i,visible:k}),k&&(f.visibleWrites=dq(f.visibleWrites,g,h)),f.lastWriteId=i,e)?Gs(a,new yo(lo(),b,c)):[]}function Bs(a,b,c=!1){const d=function(a,b){for(let c=0;c<a.allWrites.length;c++){const d=a.allWrites[c];if(d.writeId===b)return d}return null}(a.pendingWriteTree_,b),e=function(a,b){var c;const d=a.allWrites.findIndex(a=>a.writeId===b);(0,j.hu)(d>=0,"removeWrite called with nonexistent writeId.");const e=a.allWrites[d];a.allWrites.splice(d,1);let f=e.visible,g=!1,h=a.allWrites.length-1;for(;f&&h>=0;){const i=a.allWrites[h];i.visible&&(h>=d&&oq(i,e.path)?f=!1:Je(e.path,i.path)&&(g=!0)),h--}if(!f)return!1;if(g)return(c=a).visibleWrites=qq(c.allWrites,pq,ye()),c.allWrites.length>0?c.lastWriteId=c.allWrites[c.allWrites.length-1].writeId:c.lastWriteId=-1,!0;if(e.snap)a.visibleWrites=fq(a.visibleWrites,e.path);else{const k=e.children;X(k,b=>{a.visibleWrites=fq(a.visibleWrites,Fe(e.path,b))})}return!0}(a.pendingWriteTree_,b);if(!e)return[];{let f=new Zo(null);return null!=d.snap?f=f.set(ye(),!0):X(d.children,a=>{f=f.set(new re(a),!0)}),Gs(a,new oo(d.path,f,c))}}function Cs(a,b,c){return Gs(a,new yo(mo(),b,c))}function Ds(a,b,c,d){const e=b._path,f=a.syncPointTree_.get(e);let g=[];if(f&&("default"===b._queryIdentifier||ts(f,b))){const h=function(a,b,c,d){const e=b._queryIdentifier,f=[];let g=[];const h=us(a);if("default"===e)for(const[i,k]of a.views.entries())g=g.concat(ks(k,c,d)),js(k)&&(a.views.delete(i),k.query._queryParams.loadsAllData()||f.push(k.query));else{const l=a.views.get(e);l&&(g=g.concat(ks(l,c,d)),js(l)&&(a.views.delete(e),l.query._queryParams.loadsAllData()||f.push(l.query)))}return h&&!us(a)&&f.push(new((0,j.hu)(ns,"Reference.ts has not been loaded"),ns)(b._repo,b._path)),{removed:f,events:g}}(f,b,c,d);0===f.views.size&&(a.syncPointTree_=a.syncPointTree_.remove(e));const i=h.removed;g=h.events;const k=-1!==i.findIndex(a=>a._queryParams.loadsAllData()),l=a.syncPointTree_.findOnPath(e,(a,b)=>us(b));if(k&&!l){const m=a.syncPointTree_.subtree(e);if(!m.isEmpty()){const n=Ps(m);for(let o=0;o<n.length;++o){const p=n[o],q=p.query,r=Js(a,p);a.listenProvider_.startListening(Qs(q),Ks(a,q),r.hashFn,r.onComplete)}}}if(!l&&i.length>0&&!d)if(k){const s=null;a.listenProvider_.stopListening(Qs(b),s)}else i.forEach(b=>{const c=a.queryToTagMap.get(Ls(b));a.listenProvider_.stopListening(Qs(b),c)});Rs(a,i)}return g}function Es(a,b,c){const d=b._path;let e=null,f=!1;a.syncPointTree_.foreachOnPath(d,(a,b)=>{const c=He(a,d);e=e||rs(b,c),f=f||us(b)});let g=a.syncPointTree_.get(d);g?(f=f||us(g),e=e||rs(g,ye())):(g=new os(),a.syncPointTree_=a.syncPointTree_.set(d,g));let h;if(null!=e)h=!0;else{h=!1,e=Ok.EMPTY_NODE;const i=a.syncPointTree_.subtree(d);i.foreachChild((a,b)=>{const c=rs(b,ye());c&&(e=e.updateImmediateChild(a,c))})}const k=ts(g,b);if(!k&&!b._queryParams.loadsAllData()){const l=Ls(b);(0,j.hu)(!a.queryToTagMap.has(l),"View does not exist, but we have a tag");const m=Ss();a.queryToTagMap.set(l,m),a.tagToQueryMap.set(m,l)}const n=nq(a.pendingWriteTree_,d);let o=function(a,b,c,d,e,f){const g=function(a,b,c,d,e){const f=b._queryIdentifier,g=a.views.get(f);if(!g){let h=sq(c,e?d:null),i=!1;h?i=!0:d instanceof Ok?(h=tq(c,d),i=!1):(h=Ok.EMPTY_NODE,i=!1);const j=To(new Jo(h,i,!1),new Jo(d,e,!1));return new fr(b,j)}return g}(a,b,d,e,f);return a.views.has(b._queryIdentifier)||a.views.set(b._queryIdentifier,g),!function(a,b){a.eventRegistrations_.push(b)}(g,c),(function(a,b){const c=a.viewCache_.eventCache,d=[];if(!c.getNode().isLeafNode()){const e=c.getNode();e.forEachChild(Zj,(a,b)=>{d.push(Fm(a,b))})}return c.isFullyInitialized()&&d.push(Em(c.getNode())),ms(a,d,c.getNode(),b)})(g,c)}(g,b,c,n,e,h);if(!k&&!f){const p=ss(g,b);o=o.concat(Ts(a,b,p))}return o}function Fs(a,b,c){const d=a.pendingWriteTree_,e=a.syncPointTree_.findOnPath(b,(a,c)=>{const d=He(a,b),e=rs(c,d);if(e)return e});return rq(d,b,e,c,!0)}function Gs(a,b){return Hs(b,a.syncPointTree_,null,nq(a.pendingWriteTree_,ye()))}function Hs(a,b,c,d){if(Ge(a.path))return Is(a,b,c,d);{const e=b.get(ye());null==c&&null!=e&&(c=rs(e,ye()));let f=[];const g=ze(a.path),h=a.operationForChild(g),i=b.children.get(g);if(i&&h){const j=c?c.getImmediateChild(g):null,k=xq(d,g);f=f.concat(Hs(h,i,j,k))}return e&&(f=f.concat(ps(e,a,d,c))),f}}function Is(a,b,c,d){const e=b.get(ye());null==c&&null!=e&&(c=rs(e,ye()));let f=[];return b.children.inorderTraversal((b,e)=>{const g=c?c.getImmediateChild(b):null,h=xq(d,b),i=a.operationForChild(b);i&&(f=f.concat(Is(i,e,g,h)))}),e&&(f=f.concat(ps(e,a,d,c))),f}function Js(a,b){const c=b.query,d=Ks(a,c);return{hashFn:()=>{const a=b.viewCache_.serverCache.getNode()||Ok.EMPTY_NODE;return a.hash()},onComplete:b=>{if("ok"===b){var e,f;return d?(function(a,b,c){const d=Ms(a,c);if(!d)return[];{const e=Ns(d),f=e.path,g=e.queryId,h=He(f,b),i=new uo(no(g),h);return Os(a,f,i)}})(a,c._path,d):(e=a,f=c._path,Gs(e,new uo(mo(),f)))}{const g=function(a,b){let c="Unknown Error";"too_big"===a?c="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===a?c="Client doesn't have permission to access the desired data.":"unavailable"===a&&(c="The service is unavailable");const d=new Error(a+" at "+b._path.toString()+": "+c);return d.code=a.toUpperCase(),d}(b,c);return Ds(a,c,null,g)}}}}function Ks(a,b){const c=Ls(b);return a.queryToTagMap.get(c)}function Ls(a){return a._path.toString()+"$"+a._queryIdentifier}function Ms(a,b){return a.tagToQueryMap.get(b)}function Ns(a){const b=a.indexOf("$");return(0,j.hu)(-1!==b&&b<a.length-1,"Bad queryKey."),{queryId:a.substr(b+1),path:new re(a.substr(0,b))}}function Os(a,b,c){const d=a.syncPointTree_.get(b);(0,j.hu)(d,"Missing sync point for query tag that we're tracking");const e=nq(a.pendingWriteTree_,b);return ps(d,c,e,null)}function Ps(a){return a.fold((a,b,c)=>{if(b&&us(b)){const d=vs(b);return[d]}{let e=[];return b&&(e=qs(b)),X(c,(a,b)=>{e=e.concat(b)}),e}})}function Qs(a){return a._queryParams.loadsAllData()&&!a._queryParams.isDefault()?new((0,j.hu)(ws,"Reference.ts has not been loaded"),ws)(a._repo,a._path):a}function Rs(a,b){for(let c=0;c<b.length;++c){const d=b[c];if(!d._queryParams.loadsAllData()){const e=Ls(d),f=a.queryToTagMap.get(e);a.queryToTagMap.delete(e),a.tagToQueryMap.delete(f)}}}function Ss(){return xs++}function Ts(a,b,c){const d=b._path,e=Ks(a,b),f=Js(a,c),g=a.listenProvider_.startListening(Qs(b),e,f.hashFn,f.onComplete),h=a.syncPointTree_.subtree(d);if(e)(0,j.hu)(!us(h.value),"If we're adding a query, it shouldn't be shadowed");else{const i=h.fold((a,b,c)=>{if(!Ge(a)&&b&&us(b))return[vs(b).query];{let d=[];return b&&(d=d.concat(qs(b).map(a=>a.query))),X(c,(a,b)=>{d=d.concat(b)}),d}});for(let k=0;k<i.length;++k){const l=i[k];a.listenProvider_.stopListening(Qs(l),Ks(a,l))}}return g}class Us{constructor(Vs){this.node_=Vs}getImmediateChild(Ws){const Xs=this.node_.getImmediateChild(Ws);return new Us(Xs)}node(){return this.node_}}class Ys{constructor(Zs,$s){this.syncTree_=Zs,this.path_=$s}getImmediateChild(_s){const at=Fe(this.path_,_s);return new Ys(this.syncTree_,at)}node(){return Fs(this.syncTree_,this.path_)}}const bt=function(a,b,c){return a&&"object"==typeof a?((0,j.hu)(".sv"in a,"Unexpected leaf node or priority contents"),"string"==typeof a[".sv"])?ct(a[".sv"],b,c):"object"==typeof a[".sv"]?dt(a[".sv"],b):void(0,j.hu)(!1,"Unexpected server value: "+JSON.stringify(a,null,2)):a},ct=function(a,b,c){switch(a){case"timestamp":return c.timestamp;default:(0,j.hu)(!1,"Unexpected server value: "+a)}},dt=function(a,b,c){a.hasOwnProperty("increment")||(0,j.hu)(!1,"Unexpected server value: "+JSON.stringify(a,null,2));const d=a.increment;"number"!=typeof d&&(0,j.hu)(!1,"Unexpected increment value: "+d);const e=b.node();if((0,j.hu)(null!=e,"Expected ChildrenNode.EMPTY_NODE for nulls"),!e.isLeafNode())return d;const f=e.getValue();return"number"!=typeof f?d:f+d},et=function(a,b,c,d){return gt(b,new Ys(c,a),d)},ft=function(a,b,c){return gt(a,new Us(b),c)};function gt(a,b,c){const d=a.getPriority().val(),e=bt(d,b.getImmediateChild(".priority"),c);let f;if(a.isLeafNode()){const g=a,h=bt(g.getValue(),b,c);return h!==g.getValue()||e!==g.getPriority().val()?new wj(h,fm(e)):a}{const i=a;return f=i,e!==i.getPriority().val()&&(f=f.updatePriority(new wj(e))),i.forEachChild(Zj,(a,d)=>{const e=gt(d,b.getImmediateChild(a),c);e!==d&&(f=f.updateImmediateChild(a,e))}),f}}class ht{constructor(it="",jt=null,kt={children:{},childCount:0}){this.name=it,this.parent=jt,this.node=kt}}function lt(a,b){let c=b instanceof re?b:new re(b),d=a,e=ze(c);for(;null!==e;){const f=(0,j.DV)(d.node.children,e)||{children:{},childCount:0};d=new ht(e,d,f),e=ze(c=Be(c))}return d}function mt(a){return a.node.value}function nt(a,b){a.node.value=b,st(a)}function ot(a){return a.node.childCount>0}function pt(a,b){X(a.node.children,(c,d)=>{b(new ht(c,a,d))})}function qt(a,b,c,d){c&&!d&&b(a),pt(a,a=>{qt(a,b,!0,d)}),c&&d&&b(a)}function rt(a){return new re(null===a.parent?a.name:rt(a.parent)+"/"+a.name)}function st(a){null!==a.parent&&tt(a.parent,a.name,a)}function tt(a,b,c){var d;const e=void 0===mt(d=c)&&!ot(d),f=(0,j.r3)(a.node.children,b);e&&f?(delete a.node.children[b],a.node.childCount--,st(a)):e||f||(a.node.children[b]=c.node,a.node.childCount++,st(a))}const ut=/[\[\].#$\/\u0000-\u001F\u007F]/,vt=/[\[\].#$\u0000-\u001F\u007F]/,wt=function(a){return"string"==typeof a&&0!==a.length&&!ut.test(a)},xt=function(a){return"string"==typeof a&&0!==a.length&&!vt.test(a)},yt=function(a,b,c){const d=c instanceof re?new Ke(c,a):c;if(void 0===b)throw new Error(a+"contains undefined "+Pe(d));if("function"==typeof b)throw new Error(a+"contains a function "+Pe(d)+" with contents = "+b.toString());if(R(b))throw new Error(a+"contains "+b.toString()+" "+Pe(d));if("string"==typeof b&&b.length>3495253.3333333335&&(0,j.ug)(b)>10485760)throw new Error(a+"contains a string greater than 10485760 utf8 bytes "+Pe(d)+" ('"+b.substring(0,50)+"...')");if(b&&"object"==typeof b){let e=!1,f=!1;if(X(b,(b,c)=>{var g,h;if(".value"===b)e=!0;else if(".priority"!==b&&".sv"!==b&&(f=!0,!wt(b)))throw new Error(a+" contains an invalid key ("+b+") "+Pe(d)+".  Keys must be non-empty strings and can't contain \".\", \"#\", \"$\", \"/\", \"[\", or \"]\"");g=d,h=b,g.parts_.length>0&&(g.byteLength_+=1),g.parts_.push(h),g.byteLength_+=(0,j.ug)(h),Oe(g),yt(a,c,d),(function(a){const b=a.parts_.pop();a.byteLength_-=(0,j.ug)(b),a.parts_.length>0&&(a.byteLength_-=1)})(d)}),e&&f)throw new Error(a+" contains \".value\" child "+Pe(d)+" in addition to actual children.")}},zt=function(a,b,c,d){if((!d|| void 0!==c)&&!xt(c))throw new Error((0,j.gK)(a,b)+"was an invalid path = \""+c+"\". Paths must be non-empty strings and can't contain \".\", \"#\", \"$\", \"[\", or \"]\"")},At=function(a,b,c,d){c&&(c=c.replace(/^\/*\.info(\/|$)/,"/")),zt(a,b,c,d)},Bt=function(a,b){var c;const d=b.path.toString();if("string"!=typeof b.repoInfo.host||0===b.repoInfo.host.length|| !wt(b.repoInfo.namespace)&&"localhost"!==b.repoInfo.host.split(":")[0]||0!==d.length&&((c=d)&&(c=c.replace(/^\/*\.info(\/|$)/,"/")),!xt(c)))throw new Error((0,j.gK)(a,"url")+"must be a valid firebase URL and the path can't contain \".\", \"#\", \"$\", \"[\", or \"]\".")};function Ct(a,b){let c=null;for(let d=0;d<b.length;d++){const e=b[d],f=e.getPath();null===c||Ie(f,c.path)||(a.eventLists_.push(c),c=null),null===c&&(c={events:[],path:f}),c.events.push(e)}c&&a.eventLists_.push(c)}function Dt(a,b,c){Ct(a,c),Ft(a,a=>Ie(a,b))}function Et(a,b,c){Ct(a,c),Ft(a,a=>Je(a,b)||Je(b,a))}function Ft(a,b){a.recursionDepth_++;let c=!0;for(let d=0;d<a.eventLists_.length;d++){const e=a.eventLists_[d];if(e){const f=e.path;b(f)?(Gt(a.eventLists_[d]),a.eventLists_[d]=null):c=!1}}c&&(a.eventLists_=[]),a.recursionDepth_--}function Gt(a){for(let b=0;b<a.events.length;b++){const c=a.events[b];if(null!==c){a.events[b]=null;const d=c.getEventRunner();I&&L("event: "+c.toString()),_(d)}}}class Ht{constructor(It,Jt,Kt,Lt){this.repoInfo_=It,this.forceRestClient_=Jt,this.authTokenProvider_=Kt,this.appCheckProvider_=Lt,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new class{constructor(){this.eventLists_=[],this.recursionDepth_=0}}(),this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Yn(),this.transactionQueueTree_=new ht(),this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function Mt(a){var b;return(b=b={timestamp:(function(a){const b=a.infoData_.getNode(new re(".info/serverTimeOffset")),c=b.val()||0;return new Date().getTime()+c})(a)}).timestamp=b.timestamp||new Date().getTime(),b}function Nt(a,b,c,d,e){a.dataUpdateCount++;const f=new re(b);c=a.interceptServerDataCallback_?a.interceptServerDataCallback_(b,c):c;let g=[];if(e)if(d){const h=(0,j.UI)(c,a=>fm(a));g=(function(a,b,c,d){const e=Ms(a,d);if(!e)return[];{const f=Ns(e),g=f.path,h=f.queryId,i=He(g,b),j=Zo.fromObject(c),k=new Do(no(h),i,j);return Os(a,g,k)}})(a.serverSyncTree_,f,h,e)}else{const i=fm(c);g=(function(a,b,c,d){const e=Ms(a,d);if(null==e)return[];{const f=Ns(e),g=f.path,h=f.queryId,i=He(g,b),j=new yo(no(h),i,c);return Os(a,g,j)}})(a.serverSyncTree_,f,i,e)}else if(d){const k=(0,j.UI)(c,a=>fm(a));g=(function(a,b,c){const d=Zo.fromObject(c);return Gs(a,new Do(mo(),b,d))})(a.serverSyncTree_,f,k)}else{const l=fm(c);g=Cs(a.serverSyncTree_,f,l)}let m=f;g.length>0&&(m=Xt(a,f)),Et(a.eventQueue_,m,g)}function Ot(a,b){Pt(a,"connected",b),!1===b&&Rt(a)}function Pt(a,b,c){const d=new re("/.info/"+b),e=fm(c);a.infoData_.updateSnapshot(d,e);const f=Cs(a.infoSyncTree_,d,e);Et(a.eventQueue_,d,f)}function Qt(a){return a.nextWriteId_++}function Rt(a){Tt(a,"onDisconnectEvents");const b=Mt(a),c=Yn();_n(a.onDisconnect_,ye(),(d,e)=>{const f=et(d,e,a.serverSyncTree_,b);Zn(c,d,f)});let d=[];_n(c,ye(),(b,c)=>{d=d.concat(Cs(a.serverSyncTree_,b,c));const e=bu(a,b);Xt(a,e)}),a.onDisconnect_=Yn(),Et(a.eventQueue_,ye(),d)}function St(a,b,c){let d;d=".info"===ze(b._path)?Ds(a.infoSyncTree_,b,c):Ds(a.serverSyncTree_,b,c),Dt(a.eventQueue_,b._path,d)}function Tt(a,...b){let c="";a.persistentConnection_&&(c=a.persistentConnection_.id+":"),L(c,...b)}function Ut(a,b,c){return Fs(a.serverSyncTree_,b,c)||Ok.EMPTY_NODE}function Vt(a,b=a.transactionQueueTree_){if(b||au(a,b),mt(b)){const c=$t(a,b);(0,j.hu)(c.length>0,"Sending zero length transaction queue");const d=c.every(a=>0===a.status);d&&Wt(a,rt(b),c)}else ot(b)&&pt(b,b=>{Vt(a,b)})}function Wt(a,b,c){const d=c.map(a=>a.currentWriteId),e=Ut(a,b,d);let f=e;const g=e.hash();for(let h=0;h<c.length;h++){const i=c[h];(0,j.hu)(0===i.status,"tryToSendTransactionQueue_: items in queue should all be run."),i.status=1,i.retryCount++;const k=He(b,i.path);f=f.updateChild(k,i.currentOutputSnapshotRaw)}const l=f.val(!0),m=b;a.server_.put(m.toString(),l,d=>{Tt(a,"transaction put response",{path:m.toString(),status:d});let e=[];if("ok"===d){const f=[];for(let g=0;g<c.length;g++)c[g].status=2,e=e.concat(Bs(a.serverSyncTree_,c[g].currentWriteId)),c[g].onComplete&&f.push(()=>c[g].onComplete(null,!0,c[g].currentOutputSnapshotResolved)),c[g].unwatcher();au(a,lt(a.transactionQueueTree_,b)),Vt(a,a.transactionQueueTree_),Et(a.eventQueue_,b,e);for(let h=0;h<f.length;h++)_(f[h])}else{if("datastale"===d)for(let i=0;i<c.length;i++)3===c[i].status?c[i].status=4:c[i].status=0;else{P("transaction at "+m.toString()+" failed: "+d);for(let j=0;j<c.length;j++)c[j].status=4,c[j].abortReason=d}Xt(a,b)}},g)}function Xt(a,b){const c=Zt(a,b),d=rt(c),e=$t(a,c);return Yt(a,e,d),d}function Yt(a,b,c){if(0!==b.length){const d=[];let e=[];const f=b.filter(a=>0===a.status),g=f.map(a=>a.currentWriteId);for(let h=0;h<b.length;h++){const i=b[h],k=He(c,i.path);let l=!1,m;if((0,j.hu)(null!==k,"rerunTransactionsUnderNode_: relativePath should not be null."),4===i.status)l=!0,m=i.abortReason,e=e.concat(Bs(a.serverSyncTree_,i.currentWriteId,!0));else if(0===i.status)if(i.retryCount>=25)l=!0,m="maxretry",e=e.concat(Bs(a.serverSyncTree_,i.currentWriteId,!0));else{const n=Ut(a,i.path,g);i.currentInputSnapshot=n;const o=b[h].update(n.val());if(void 0!==o){yt("transaction failed: Data returned ",o,i.path);let p=fm(o);const q="object"==typeof o&&null!=o&&(0,j.r3)(o,".priority");q||(p=p.updatePriority(n.getPriority()));const r=i.currentWriteId,s=Mt(a),t=ft(p,n,s);i.currentOutputSnapshotRaw=p,i.currentOutputSnapshotResolved=t,i.currentWriteId=Qt(a),g.splice(g.indexOf(r),1),e=(e=e.concat(As(a.serverSyncTree_,i.path,t,i.currentWriteId,i.applyLocally))).concat(Bs(a.serverSyncTree_,r,!0))}else l=!0,m="nodata",e=e.concat(Bs(a.serverSyncTree_,i.currentWriteId,!0))}Et(a.eventQueue_,c,e),e=[],l&&(b[h].status=2,setTimeout(b[h].unwatcher,Math.floor(0)),b[h].onComplete&&("nodata"===m?d.push(()=>b[h].onComplete(null,!1,b[h].currentInputSnapshot)):d.push(()=>b[h].onComplete(new Error(m),!1,null))))}au(a,a.transactionQueueTree_);for(let u=0;u<d.length;u++)_(d[u]);Vt(a,a.transactionQueueTree_)}}function Zt(a,b){let c,d=a.transactionQueueTree_;for(c=ze(b);null!==c&& void 0===mt(d);)d=lt(d,c),c=ze(b=Be(b));return d}function $t(a,b){const c=[];return _t(a,b,c),c.sort((a,b)=>a.order-b.order),c}function _t(a,b,c){const d=mt(b);if(d)for(let e=0;e<d.length;e++)c.push(d[e]);pt(b,b=>{_t(a,b,c)})}function au(a,b){const c=mt(b);if(c){let d=0;for(let e=0;e<c.length;e++)2!==c[e].status&&(c[d]=c[e],d++);c.length=d,nt(b,c.length>0?c:void 0)}pt(b,b=>{au(a,b)})}function bu(a,b){const c=rt(Zt(a,b)),d=lt(a.transactionQueueTree_,b);return!function(a,b,c){let d=a.parent;for(;null!==d;){if(b(d))return!0;d=d.parent}return!1}(d,b=>{cu(a,b)}),cu(a,d),qt(d,b=>{cu(a,b)}),c}function cu(a,b){const c=mt(b);if(c){const d=[];let e=[],f=-1;for(let g=0;g<c.length;g++)3===c[g].status||(1===c[g].status?((0,j.hu)(f===g-1,"All SENT items should be at beginning of queue."),f=g,c[g].status=3,c[g].abortReason="set"):((0,j.hu)(0===c[g].status,"Unexpected transaction status in abort"),c[g].unwatcher(),e=e.concat(Bs(a.serverSyncTree_,c[g].currentWriteId,!0)),c[g].onComplete&&d.push(c[g].onComplete.bind(null,new Error("set"),!1,null))));-1===f?nt(b,void 0):c.length=f+1,Et(a.eventQueue_,rt(b),e);for(let h=0;h<d.length;h++)_(d[h])}}const du=function(a,b){const c=eu(a),d=c.namespace;"firebase.com"===c.domain&&O(c.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),d&&"undefined"!==d||"localhost"===c.domain||O("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),c.secure||Q();const e="ws"===c.scheme||"wss"===c.scheme;return{repoInfo:new wa(c.host,c.secure,d,b,e,"",d!==c.subdomain),path:new re(c.pathString)}},eu=function(a){let b="",c="",d="",e="",f="",g=!0,h="https",i=443;if("string"==typeof a){let j=a.indexOf("//");j>=0&&(h=a.substring(0,j-1),a=a.substring(j+2));let k=a.indexOf("/");-1===k&&(k=a.length);let l=a.indexOf("?");-1===l&&(l=a.length),b=a.substring(0,Math.min(k,l)),k<l&&(e=(function(a){let b="";const c=a.split("/");for(let d=0;d<c.length;d++)if(c[d].length>0){let e=c[d];try{e=decodeURIComponent(e.replace(/\+/g," "))}catch(f){}b+="/"+e}return b})(a.substring(k,l)));const m=function(a){const b={};for(const c of("?"===a.charAt(0)&&(a=a.substring(1)),a.split("&")))if(0!==c.length){const d=c.split("=");2===d.length?b[decodeURIComponent(d[0])]=decodeURIComponent(d[1]):P(`Invalid query segment '${c}' in query '${a}'`)}return b}(a.substring(Math.min(a.length,l)));(j=b.indexOf(":"))>=0?(g="https"===h||"wss"===h,i=parseInt(b.substring(j+1),10)):j=b.length;const n=b.slice(0,j);if("localhost"===n.toLowerCase())c="localhost";else if(n.split(".").length<=2)c=n;else{const o=b.indexOf(".");d=b.substring(0,o).toLowerCase(),c=b.substring(o+1),f=d}"ns"in m&&(f=m.ns)}return{host:b,port:i,domain:c,subdomain:d,secure:g,scheme:h,pathString:e,namespace:f}};class fu{constructor(gu,hu,iu,ju){this.eventType=gu,this.eventRegistration=hu,this.snapshot=iu,this.prevName=ju}getPath(){const ku=this.snapshot.ref;return"value"===this.eventType?ku._path:ku.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+(0,j.Pz)(this.snapshot.exportVal())}}class lu{constructor(mu,nu,ou){this.eventRegistration=mu,this.error=nu,this.path=ou}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class pu{constructor(qu,ru){this.snapshotCallback=qu,this.cancelCallback=ru}onValue(su,tu){this.snapshotCallback.call(null,su,tu)}onCancel(uu){return(0,j.hu)(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,uu)}get hasCancelCallback(){return!!this.cancelCallback}matches(vu){return this.snapshotCallback===vu.snapshotCallback|| void 0!==this.snapshotCallback.userCallback&&this.snapshotCallback.userCallback===vu.snapshotCallback.userCallback&&this.snapshotCallback.context===vu.snapshotCallback.context}}class wu{constructor(xu,yu,zu,Au){this._repo=xu,this._path=yu,this._queryParams=zu,this._orderByCalled=Au}get key(){return Ge(this._path)?null:Ce(this._path)}get ref(){return new Hu(this._repo,this._path)}get _queryIdentifier(){const Bu=sn(this._queryParams),Cu=V(Bu);return"{}"===Cu?"default":Cu}get _queryObject(){return sn(this._queryParams)}isEqual(Du){if(!((Du=(0,j.m9)(Du))instanceof wu))return!1;const Eu=this._repo===Du._repo,Fu=Ie(this._path,Du._path),Gu=this._queryIdentifier===Du._queryIdentifier;return Eu&&Fu&&Gu}toJSON(){return this.toString()}toString(){return this._repo.toString()+(function(a){let b="";for(let c=a.pieceNum_;c<a.pieces_.length;c++)""!==a.pieces_[c]&&(b+="/"+encodeURIComponent(String(a.pieces_[c])));return b||"/"})(this._path)}}class Hu extends wu{constructor(Iu,Ju){super(Iu,Ju,new pn(),!1)}get parent(){const Ku=Ee(this._path);return null===Ku?null:new Hu(this._repo,Ku)}get root(){let Lu=this;for(;null!==Lu.parent;)Lu=Lu.parent;return Lu}}class Mu{constructor(Nu,Ou,Pu){this._node=Nu,this.ref=Ou,this._index=Pu}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(Qu){const Ru=new re(Qu),Su=Yu(this.ref,Qu);return new Mu(this._node.getChild(Ru),Su,Zj)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(Tu){if(this._node.isLeafNode())return!1;const Uu=this._node;return!!Uu.forEachChild(this._index,(a,b)=>Tu(new Mu(b,Yu(this.ref,a),Zj)))}hasChild(Vu){const Wu=new re(Vu);return!this._node.getChild(Wu).isEmpty()}hasChildren(){return!this._node.isLeafNode()&&!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function Xu(a,b){return(a=(0,j.m9)(a))._checkNotDeleted("ref"),void 0!==b?Yu(a._root,b):a._root}function Yu(a,b){return null===ze((a=(0,j.m9)(a))._path)?At("child","path",b,!1):zt("child","path",b,!1),new Hu(a._repo,Fe(a._path,b))}class Zu{constructor($u){this.callbackContext=$u}respondsTo(_u){return"value"===_u}createEvent(av,bv){const cv=bv._queryParams.getIndex();return new fu("value",this,new Mu(av.snapshotNode,new Hu(bv._repo,bv._path),cv))}getEventRunner(dv){return"cancel"===dv.getEventType()?()=>this.callbackContext.onCancel(dv.error):()=>this.callbackContext.onValue(dv.snapshot,null)}createCancelEvent(ev,fv){return this.callbackContext.hasCancelCallback?new lu(this,ev,fv):null}matches(gv){return gv instanceof Zu&&(!gv.callbackContext||!this.callbackContext||gv.callbackContext.matches(this.callbackContext))}hasAnyCallback(){return null!==this.callbackContext}}class hv{constructor(iv,jv){this.eventType=iv,this.callbackContext=jv}respondsTo(kv){let lv="children_added"===kv?"child_added":kv;return lv="children_removed"===lv?"child_removed":lv,this.eventType===lv}createCancelEvent(mv,nv){return this.callbackContext.hasCancelCallback?new lu(this,mv,nv):null}createEvent(ov,pv){(0,j.hu)(null!=ov.childName,"Child events should have a childName.");const qv=Yu(new Hu(pv._repo,pv._path),ov.childName),rv=pv._queryParams.getIndex();return new fu(ov.type,this,new Mu(ov.snapshotNode,qv,rv),ov.prevName)}getEventRunner(sv){return"cancel"===sv.getEventType()?()=>this.callbackContext.onCancel(sv.error):()=>this.callbackContext.onValue(sv.snapshot,sv.prevName)}matches(tv){return tv instanceof hv&&this.eventType===tv.eventType&&(!this.callbackContext||!tv.callbackContext||this.callbackContext.matches(tv.callbackContext))}hasAnyCallback(){return!!this.callbackContext}}function uv(a,b,c,d){return(function(a,b,c,d,e){var f,g,h;let i;if("object"==typeof d&&(i=void 0,e=d),"function"==typeof d&&(i=d),e&&e.onlyOnce){const j=c,k=(b,c)=>{St(a._repo,a,m),j(b,c)};k.userCallback=c.userCallback,k.context=c.context,c=k}const l=new pu(c,i||void 0),m="value"===b?new Zu(l):new hv(b,l);let n;return f=a._repo,g=a,h=m,n=".info"===ze(g._path)?Es(f.infoSyncTree_,g,h):Es(f.serverSyncTree_,g,h),Dt(f.eventQueue_,g._path,n),()=>St(a._repo,a,m)})(a,"value",b,c,d)}function vv(a,b,c){let d=null;const e=c?new pu(c):null;"value"===b?d=new Zu(e):b&&(d=new hv(b,e)),St(a._repo,a,d)}e=Hu,(0,j.hu)(!ns,"__referenceConstructor has already been defined"),ns=e,f=Hu,(0,j.hu)(!ws,"__referenceConstructor has already been defined"),ws=f;const wv={};class xv{constructor(yv,zv){this._repoInternal=yv,this.app=zv,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||((function(a,b,c){if(a.stats_=Oa(a.repoInfo_),a.forceRestClient_||aa())a.server_=new tn(a.repoInfo_,(b,c,d,e)=>{Nt(a,b,c,d,e)},a.authTokenProvider_,a.appCheckProvider_),setTimeout(()=>Ot(a,!0),0);else{if(null!=c){if("object"!=typeof c)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{(0,j.Pz)(c)}catch(d){throw new Error("Invalid authOverride provided: "+d)}}a.persistentConnection_=new Ue(a.repoInfo_,b,(b,c,d,e)=>{Nt(a,b,c,d,e)},b=>{Ot(a,b)},b=>{var c;c=a,X(b,(a,b)=>{Pt(c,a,b)})},a.authTokenProvider_,a.appCheckProvider_,c),a.server_=a.persistentConnection_}a.authTokenProvider_.addTokenChangeListener(b=>{a.server_.refreshAuthToken(b)}),a.appCheckProvider_.addTokenChangeListener(b=>{a.server_.refreshAppCheckToken(b.token)}),a.statsReporter_=(function(a,b){const c=a.toString();return Na[c]||(Na[c]=b()),Na[c]})(a.repoInfo_,()=>new bo(a.stats_,a.server_)),a.infoData_=new Un(),a.infoSyncTree_=new ys({startListening:(b,c,d,e)=>{let f=[];const g=a.infoData_.getNode(b._path);return g.isEmpty()||(f=Cs(a.infoSyncTree_,b._path,g),setTimeout(()=>{e("ok")},0)),f},stopListening:()=>{}}),Pt(a,"connected",!1),a.serverSyncTree_=new ys({startListening:(b,c,d,e)=>(a.server_.listen(b,d,c,(c,d)=>{const f=e(c,d);Et(a.eventQueue_,b._path,f)}),[]),stopListening:(b,c)=>{a.server_.unlisten(b,c)}})})(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new Hu(this._repo,ye())),this._rootInternal}_delete(){return null!==this._rootInternal&&((function(a,b){var c;const d=wv[b];d&&d[a.key]===a||O(`Database ${b}(${a.repoInfo_}) has already been deleted.`),(c=a).persistentConnection_&&c.persistentConnection_.interrupt("repo_interrupt"),delete d[a.key]})(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(Av){null===this._rootInternal&&O("Cannot call "+Av+" on a deleted database.")}}function Bv(a=(0,h.getApp)(),b){return(0,h._getProvider)(a,"database").getImmediate({identifier:b})}Ue.prototype.simpleListen=function(a,b){this.sendRequest("q",{p:a},b)},Ue.prototype.echo=function(a,b){this.sendRequest("echo",{d:a},b)},m=h.SDK_VERSION,(0,h._registerComponent)(new i.wA("database",(a,{instanceIdentifier:b})=>{const c=a.getProvider("app").getImmediate(),d=a.getProvider("auth-internal"),e=a.getProvider("app-check-internal");return(function(a,b,c,d,e){var f,g,h,i;let j=d||a.options.databaseURL;void 0===j&&(a.options.projectId||O("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),L("Using default host for project ",a.options.projectId),j=`${a.options.projectId}-default-rtdb.firebaseio.com`);let k=du(j,e),m=k.repoInfo,n,o;void 0!==l&&(o=l.env.FIREBASE_DATABASE_EMULATOR_HOST),o?(n=!0,m=(k=du(j=`http://${o}?ns=${m.namespace}`,e)).repoInfo):n=!k.repoInfo.secure;const p=e&&n?new qa(qa.OWNER):new ia(a.name,a.options,b);Bt("Invalid Firebase Database URL",k),Ge(k.path)||O("Database URL must point to the root of a Firebase Database (not including a child path).");let q,r;const s=(f=m,g=a,h=p,i=new ca(a.name,c),(q=wv[g.name])||(q={},wv[g.name]=q),(r=q[f.toURLString()])&&O("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new Ht(f,!1,h,i),q[f.toURLString()]=r,r);return new xv(s,a)})(c,d,e,b)},"PUBLIC").setMultipleInstances(!0)),(0,h.registerVersion)("@firebase/database","0.12.4",void 0),(0,h.registerVersion)("@firebase/database","0.12.4","esm2017")}}])