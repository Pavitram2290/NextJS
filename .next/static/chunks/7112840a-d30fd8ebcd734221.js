"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(a,b,c){c.d(b,{F8:function(){return yE},EK:function(){return sa},JU:function(){return LD},QT:function(){return vG},ad:function(){return jE},pl:function(){return BG}});var d,e,f=c(2238),g=c(8463),h=c(3333),i=c(4444),j=c(3510),k=c(4155);class l{constructor(m){this.uid=m}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(n){return n.uid===this.uid}}l.UNAUTHENTICATED=new l(null),l.GOOGLE_CREDENTIALS=new l("google-credentials-uid"),l.FIRST_PARTY=new l("first-party-uid"),l.MOCK_USER=new l("mock-user");let o="9.4.0";const p=new h.Yd("@firebase/firestore");function q(){return p.logLevel}function r(a,...b){if(p.logLevel<=h.in.DEBUG){const c=b.map(u);p.debug(`Firestore (${o}): ${a}`,...c)}}function s(a,...b){if(p.logLevel<=h.in.ERROR){const c=b.map(u);p.error(`Firestore (${o}): ${a}`,...c)}}function t(a,...b){if(p.logLevel<=h.in.WARN){const c=b.map(u);p.warn(`Firestore (${o}): ${a}`,...c)}}function u(a){var b;if("string"==typeof a)return a;try{return b=a,JSON.stringify(b)}catch(c){return a}}function v(a="Unexpected state"){const b=`FIRESTORE (${o}) INTERNAL ASSERTION FAILED: `+a;throw s(b),new Error(b)}function w(a,b){a||v()}function x(a,b){return a}const y={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class z extends Error{constructor(A,B){super(B),this.code=A,this.message=B,this.name="FirebaseError",this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class C{constructor(){this.promise=new Promise((a,b)=>{this.resolve=a,this.reject=b})}}class D{constructor(E,F){this.user=F,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization=`Bearer ${E}`}}class G{getToken(){return Promise.resolve(null)}invalidateToken(){}start(H,I){H.enqueueRetryable(()=>I(l.UNAUTHENTICATED))}shutdown(){}}class J{constructor(K){this.t=K,this.currentUser=l.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(L,M){let N=this.i;const O=a=>this.i!==N?(N=this.i,M(a)):Promise.resolve();let P=new C;this.o=()=>{this.i++,this.currentUser=this.u(),P.resolve(),P=new C,L.enqueueRetryable(()=>O(this.currentUser))};const Q=()=>{const a=P;L.enqueueRetryable(async()=>{await a.promise,await O(this.currentUser)})},R=a=>{r("FirebaseCredentialsProvider","Auth detected"),this.auth=a,this.auth.addAuthTokenListener(this.o),Q()};this.t.onInit(a=>R(a)),setTimeout(()=>{if(!this.auth){const a=this.t.getImmediate({optional:!0});a?R(a):(r("FirebaseCredentialsProvider","Auth not yet detected"),P.resolve(),P=new C)}},0),Q()}getToken(){const S=this.i,T=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(T).then(a=>this.i!==S?(r("FirebaseCredentialsProvider","getToken aborted due to token change."),this.getToken()):a?(w("string"==typeof a.accessToken),new D(a.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const U=this.auth&&this.auth.getUid();return w(null===U||"string"==typeof U),new l(U)}}class V{constructor(W,X,Y){this.h=W,this.l=X,this.m=Y,this.type="FirstParty",this.user=l.FIRST_PARTY}get authHeaders(){const Z={"X-Goog-AuthUser":this.l},$=this.h.auth.getAuthHeaderValueForFirstParty([]);return $&&(Z.Authorization=$),this.m&&(Z["X-Goog-Iam-Authorization-Token"]=this.m),Z}}class _{constructor(aa,ba,ca){this.h=aa,this.l=ba,this.m=ca}getToken(){return Promise.resolve(new V(this.h,this.l,this.m))}start(da,ea){da.enqueueRetryable(()=>ea(l.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class fa{constructor(ga,ha){this.previousValue=ga,ha&&(ha.sequenceNumberHandler=a=>this.g(a),this.p=a=>ha.writeSequenceNumber(a))}g(ia){return this.previousValue=Math.max(ia,this.previousValue),this.previousValue}next(){const ja=++this.previousValue;return this.p&&this.p(ja),ja}}function ka(a){const b="undefined"!=typeof self&&(self.crypto||self.msCrypto),c=new Uint8Array(a);if(b&&"function"==typeof b.getRandomValues)b.getRandomValues(c);else for(let d=0;d<a;d++)c[d]=Math.floor(256*Math.random());return c}fa.T=-1;class la{static I(){const ma=62*Math.floor(4.129032258064516);let na="";for(;na.length<20;){const oa=ka(40);for(let pa=0;pa<oa.length;++pa)na.length<20&&oa[pa]<ma&&(na+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(oa[pa]%62))}return na}}function qa(a,b){return a<b?-1:a>b?1:0}function ra(a,b,c){return a.length===b.length&&a.every((a,d)=>c(a,b[d]))}class sa{constructor(ta,ua){if(this.seconds=ta,this.nanoseconds=ua,ua<0)throw new z(y.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+ua);if(ua>=10e8)throw new z(y.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+ua);if(ta< -62135596800)throw new z(y.INVALID_ARGUMENT,"Timestamp seconds out of range: "+ta);if(ta>=253402300800)throw new z(y.INVALID_ARGUMENT,"Timestamp seconds out of range: "+ta)}static now(){return sa.fromMillis(Date.now())}static fromDate(va){return sa.fromMillis(va.getTime())}static fromMillis(wa){const xa=Math.floor(wa/1000);return new sa(xa,Math.floor(10e5*(wa-1000*xa)))}toDate(){return new Date(this.toMillis())}toMillis(){return 1000*this.seconds+this.nanoseconds/10e5}_compareTo(ya){return this.seconds===ya.seconds?qa(this.nanoseconds,ya.nanoseconds):qa(this.seconds,ya.seconds)}isEqual(za){return za.seconds===this.seconds&&za.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const Aa=this.seconds- -62135596800;return String(Aa).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Ba{constructor(Ca){this.timestamp=Ca}static fromTimestamp(Da){return new Ba(Da)}static min(){return new Ba(new sa(0,0))}compareTo(Ea){return this.timestamp._compareTo(Ea.timestamp)}isEqual(Fa){return this.timestamp.isEqual(Fa.timestamp)}toMicroseconds(){return 10e5*this.timestamp.seconds+this.timestamp.nanoseconds/1000}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function Ga(a){let b=0;for(const c in a)Object.prototype.hasOwnProperty.call(a,c)&&b++;return b}function Ha(a,b){for(const c in a)Object.prototype.hasOwnProperty.call(a,c)&&b(c,a[c])}function Ia(a){for(const b in a)if(Object.prototype.hasOwnProperty.call(a,b))return!1;return!0}class Ja{constructor(Ka,La,Ma){void 0===La?La=0:0>Ka.length&&v(),void 0===Ma?Ma=Ka.length-0:Ma>Ka.length-0&&v(),this.segments=Ka,this.offset=0,this.len=Ma}get length(){return this.len}isEqual(Na){return 0===Ja.comparator(this,Na)}child(Oa){const Pa=this.segments.slice(this.offset,this.limit());return Oa instanceof Ja?Oa.forEach(a=>{Pa.push(a)}):Pa.push(Oa),this.construct(Pa)}limit(){return this.offset+this.length}popFirst(Qa){return Qa=void 0===Qa?1:Qa,this.construct(this.segments,this.offset+Qa,this.length-Qa)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(Ra){return this.segments[this.offset+Ra]}isEmpty(){return 0===this.length}isPrefixOf(Sa){if(Sa.length<this.length)return!1;for(let Ta=0;Ta<this.length;Ta++)if(this.get(Ta)!==Sa.get(Ta))return!1;return!0}isImmediateParentOf(Ua){if(this.length+1!==Ua.length)return!1;for(let Va=0;Va<this.length;Va++)if(this.get(Va)!==Ua.get(Va))return!1;return!0}forEach(Wa){for(let Xa=this.offset,Ya=this.limit();Xa<Ya;Xa++)Wa(this.segments[Xa])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(Za,$a){const _a=Math.min(Za.length,$a.length);for(let ab=0;ab<_a;ab++){const bb=Za.get(ab),cb=$a.get(ab);if(bb<cb)return -1;if(bb>cb)return 1}return Za.length<$a.length?-1:Za.length>$a.length?1:0}}class db extends Ja{construct(eb,fb,gb){return new db(eb,fb,gb)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...hb){const ib=[];for(const jb of hb){if(jb.indexOf("//")>=0)throw new z(y.INVALID_ARGUMENT,`Invalid segment (${jb}). Paths must not contain // in them.`);ib.push(...jb.split("/").filter(a=>a.length>0))}return new db(ib)}static emptyPath(){return new db([])}}const kb=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class lb extends Ja{construct(mb,nb,ob){return new lb(mb,nb,ob)}static isValidIdentifier(pb){return kb.test(pb)}canonicalString(){return this.toArray().map(a=>(a=a.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),lb.isValidIdentifier(a)||(a="`"+a+"`"),a)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new lb(["__name__"])}static fromServerFormat(qb){const rb=[];let sb="",tb=0;const ub=()=>{if(0===sb.length)throw new z(y.INVALID_ARGUMENT,`Invalid field path (${qb}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);rb.push(sb),sb=""};let vb=!1;for(;tb<qb.length;){const wb=qb[tb];if("\\"===wb){if(tb+1===qb.length)throw new z(y.INVALID_ARGUMENT,"Path has trailing escape character: "+qb);const xb=qb[tb+1];if("\\"!==xb&&"."!==xb&&"`"!==xb)throw new z(y.INVALID_ARGUMENT,"Path has invalid escape sequence: "+qb);sb+=xb,tb+=2}else"`"===wb?(vb=!vb,tb++):"."!==wb||vb?(sb+=wb,tb++):(ub(),tb++)}if(ub(),vb)throw new z(y.INVALID_ARGUMENT,"Unterminated ` in path: "+qb);return new lb(rb)}static emptyPath(){return new lb([])}}class yb{constructor(zb){this.fields=zb,zb.sort(lb.comparator)}covers(Ab){for(const Bb of this.fields)if(Bb.isPrefixOf(Ab))return!0;return!1}isEqual(Cb){return ra(this.fields,Cb.fields,(a,b)=>a.isEqual(b))}}class Db{constructor(Eb){this.binaryString=Eb}static fromBase64String(Fb){const Gb=atob(Fb);return new Db(Gb)}static fromUint8Array(Hb){const Ib=function(a){let b="";for(let c=0;c<a.length;++c)b+=String.fromCharCode(a[c]);return b}(Hb);return new Db(Ib)}toBase64(){return this.binaryString,btoa(this.binaryString)}toUint8Array(){return(function(a){const b=new Uint8Array(a.length);for(let c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return b})(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(Jb){return qa(this.binaryString,Jb.binaryString)}isEqual(Kb){return this.binaryString===Kb.binaryString}}Db.EMPTY_BYTE_STRING=new Db("");const Lb=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Mb(a){if(w(!!a),"string"==typeof a){let b=0;const c=Lb.exec(a);if(w(!!c),c[1]){let d=c[1];b=Number(d=(d+"000000000").substr(0,9))}const e=new Date(a);return{seconds:Math.floor(e.getTime()/1000),nanos:b}}return{seconds:Nb(a.seconds),nanos:Nb(a.nanos)}}function Nb(a){return"number"==typeof a?a:"string"==typeof a?Number(a):0}function Ob(a){return"string"==typeof a?Db.fromBase64String(a):Db.fromUint8Array(a)}function Pb(a){var b,c;return"server_timestamp"===(null===(c=((null===(b=null==a?void 0:a.mapValue)|| void 0===b?void 0:b.fields)||{}).__type__)|| void 0===c?void 0:c.stringValue)}function Qb(a){const b=a.mapValue.fields.__previous_value__;return Pb(b)?Qb(b):b}function Rb(a){const b=Mb(a.mapValue.fields.__local_write_time__.timestampValue);return new sa(b.seconds,b.nanos)}function Sb(a){return null==a}function Tb(a){return 0===a&&!1}function Ub(a){return"number"==typeof a&&Number.isInteger(a)&&!Tb(a)&&a<=Number.MAX_SAFE_INTEGER&&a>=Number.MIN_SAFE_INTEGER}class Vb{constructor(Wb){this.path=Wb}static fromPath(Xb){return new Vb(db.fromString(Xb))}static fromName(Yb){return new Vb(db.fromString(Yb).popFirst(5))}hasCollectionId(Zb){return this.path.length>=2&&this.path.get(this.path.length-2)===Zb}isEqual($b){return null!==$b&&0===db.comparator(this.path,$b.path)}toString(){return this.path.toString()}static comparator(_b,ac){return db.comparator(_b.path,ac.path)}static isDocumentKey(bc){return bc.length%2==0}static fromSegments(cc){return new Vb(new db(cc.slice()))}}function dc(a){return"nullValue"in a?0:"booleanValue"in a?1:"integerValue"in a||"doubleValue"in a?2:"timestampValue"in a?3:"stringValue"in a?5:"bytesValue"in a?6:"referenceValue"in a?7:"geoPointValue"in a?8:"arrayValue"in a?9:"mapValue"in a?Pb(a)?4:10:v()}function ec(a,b){var c,d,e,f;const g=dc(a);if(g!==dc(b))return!1;switch(g){case 0:return!0;case 1:return a.booleanValue===b.booleanValue;case 4:return Rb(a).isEqual(Rb(b));case 3:return(function(a,b){if("string"==typeof a.timestampValue&&"string"==typeof b.timestampValue&&a.timestampValue.length===b.timestampValue.length)return a.timestampValue===b.timestampValue;const c=Mb(a.timestampValue),d=Mb(b.timestampValue);return c.seconds===d.seconds&&c.nanos===d.nanos})(a,b);case 5:return a.stringValue===b.stringValue;case 6:return c=a,d=b,Ob(c.bytesValue).isEqual(Ob(d.bytesValue));case 7:return a.referenceValue===b.referenceValue;case 8:return e=a,f=b,Nb(e.geoPointValue.latitude)===Nb(f.geoPointValue.latitude)&&Nb(e.geoPointValue.longitude)===Nb(f.geoPointValue.longitude);case 2:return(function(a,b){if("integerValue"in a&&"integerValue"in b)return Nb(a.integerValue)===Nb(b.integerValue);if("doubleValue"in a&&"doubleValue"in b){const c=Nb(a.doubleValue),d=Nb(b.doubleValue);return c===d?Tb(c)===Tb(d):isNaN(c)&&isNaN(d)}return!1})(a,b);case 9:return ra(a.arrayValue.values||[],b.arrayValue.values||[],ec);case 10:return(function(a,b){const c=a.mapValue.fields||{},d=b.mapValue.fields||{};if(Ga(c)!==Ga(d))return!1;for(const e in c)if(c.hasOwnProperty(e)&&(void 0===d[e]||!ec(c[e],d[e])))return!1;return!0})(a,b);default:return v()}}function fc(a,b){return void 0!==(a.values||[]).find(a=>ec(a,b))}function gc(a,b){const c=dc(a),d=dc(b);if(c!==d)return qa(c,d);switch(c){case 0:return 0;case 1:return qa(a.booleanValue,b.booleanValue);case 2:return(function(a,b){const c=Nb(a.integerValue||a.doubleValue),d=Nb(b.integerValue||b.doubleValue);return c<d?-1:c>d?1:c===d?0:isNaN(c)?isNaN(d)?0:-1:1})(a,b);case 3:return hc(a.timestampValue,b.timestampValue);case 4:return hc(Rb(a),Rb(b));case 5:return qa(a.stringValue,b.stringValue);case 6:return(function(a,b){const c=Ob(a),d=Ob(b);return c.compareTo(d)})(a.bytesValue,b.bytesValue);case 7:return(function(a,b){const c=a.split("/"),d=b.split("/");for(let e=0;e<c.length&&e<d.length;e++){const f=qa(c[e],d[e]);if(0!==f)return f}return qa(c.length,d.length)})(a.referenceValue,b.referenceValue);case 8:return(function(a,b){const c=qa(Nb(a.latitude),Nb(b.latitude));return 0!==c?c:qa(Nb(a.longitude),Nb(b.longitude))})(a.geoPointValue,b.geoPointValue);case 9:return(function(a,b){const c=a.values||[],d=b.values||[];for(let e=0;e<c.length&&e<d.length;++e){const f=gc(c[e],d[e]);if(f)return f}return qa(c.length,d.length)})(a.arrayValue,b.arrayValue);case 10:return(function(a,b){const c=a.fields||{},d=Object.keys(c),e=b.fields||{},f=Object.keys(e);d.sort(),f.sort();for(let g=0;g<d.length&&g<f.length;++g){const h=qa(d[g],f[g]);if(0!==h)return h;const i=gc(c[d[g]],e[f[g]]);if(0!==i)return i}return qa(d.length,f.length)})(a.mapValue,b.mapValue);default:throw v()}}function hc(a,b){if("string"==typeof a&&"string"==typeof b&&a.length===b.length)return qa(a,b);const c=Mb(a),d=Mb(b),e=qa(c.seconds,d.seconds);return 0!==e?e:qa(c.nanos,d.nanos)}function ic(a){return jc(a)}function jc(a){var b,c;return"nullValue"in a?"null":"booleanValue"in a?""+a.booleanValue:"integerValue"in a?""+a.integerValue:"doubleValue"in a?""+a.doubleValue:"timestampValue"in a?(function(a){const b=Mb(a);return`time(${b.seconds},${b.nanos})`})(a.timestampValue):"stringValue"in a?a.stringValue:"bytesValue"in a?Ob(a.bytesValue).toBase64():"referenceValue"in a?(c=a.referenceValue,Vb.fromName(c).toString()):"geoPointValue"in a?`geo(${(b=a.geoPointValue).latitude},${b.longitude})`:"arrayValue"in a?(function(a){let b="[",c=!0;for(const d of a.values||[])c?c=!1:b+=",",b+=jc(d);return b+"]"})(a.arrayValue):"mapValue"in a?(function(a){const b=Object.keys(a.fields||{}).sort();let c="{",d=!0;for(const e of b)d?d=!1:c+=",",c+=`${e}:${jc(a.fields[e])}`;return c+"}"})(a.mapValue):v()}function kc(a){return!!a&&"integerValue"in a}function lc(a){return!!a&&"arrayValue"in a}function mc(a){return!!a&&"nullValue"in a}function nc(a){return!!a&&"doubleValue"in a&&isNaN(Number(a.doubleValue))}function oc(a){return!!a&&"mapValue"in a}function pc(a){if(a.geoPointValue)return{geoPointValue:Object.assign({},a.geoPointValue)};if(a.timestampValue&&"object"==typeof a.timestampValue)return{timestampValue:Object.assign({},a.timestampValue)};if(a.mapValue){const b={mapValue:{fields:{}}};return Ha(a.mapValue.fields,(a,c)=>b.mapValue.fields[a]=pc(c)),b}if(a.arrayValue){const c={arrayValue:{values:[]}};for(let d=0;d<(a.arrayValue.values||[]).length;++d)c.arrayValue.values[d]=pc(a.arrayValue.values[d]);return c}return Object.assign({},a)}class qc{constructor(rc){this.value=rc}static empty(){return new qc({mapValue:{}})}field(sc){if(sc.isEmpty())return this.value;{let tc=this.value;for(let uc=0;uc<sc.length-1;++uc)if(!oc(tc=(tc.mapValue.fields||{})[sc.get(uc)]))return null;return(tc=(tc.mapValue.fields||{})[sc.lastSegment()])||null}}set(vc,wc){this.getFieldsMap(vc.popLast())[vc.lastSegment()]=pc(wc)}setAll(xc){let yc=lb.emptyPath(),zc={},Ac=[];xc.forEach((a,b)=>{if(!yc.isImmediateParentOf(b)){const c=this.getFieldsMap(yc);this.applyChanges(c,zc,Ac),zc={},Ac=[],yc=b.popLast()}a?zc[b.lastSegment()]=pc(a):Ac.push(b.lastSegment())});const Bc=this.getFieldsMap(yc);this.applyChanges(Bc,zc,Ac)}delete(Cc){const Dc=this.field(Cc.popLast());oc(Dc)&&Dc.mapValue.fields&&delete Dc.mapValue.fields[Cc.lastSegment()]}isEqual(Ec){return ec(this.value,Ec.value)}getFieldsMap(Fc){let Gc=this.value;Gc.mapValue.fields||(Gc.mapValue={fields:{}});for(let Hc=0;Hc<Fc.length;++Hc){let Ic=Gc.mapValue.fields[Fc.get(Hc)];oc(Ic)&&Ic.mapValue.fields||(Ic={mapValue:{fields:{}}},Gc.mapValue.fields[Fc.get(Hc)]=Ic),Gc=Ic}return Gc.mapValue.fields}applyChanges(Jc,Kc,Lc){for(const Mc of(Ha(Kc,(a,b)=>Jc[a]=b),Lc))delete Jc[Mc]}clone(){return new qc(pc(this.value))}}function Nc(a){const b=[];return Ha(a.fields,(a,c)=>{const d=new lb([a]);if(oc(c)){const e=Nc(c.mapValue).fields;if(0===e.length)b.push(d);else for(const f of e)b.push(d.child(f))}else b.push(d)}),new yb(b)}class Oc{constructor(Pc,Qc,Rc,Sc,Tc){this.key=Pc,this.documentType=Qc,this.version=Rc,this.data=Sc,this.documentState=Tc}static newInvalidDocument(Uc){return new Oc(Uc,0,Ba.min(),qc.empty(),0)}static newFoundDocument(Vc,Wc,Xc){return new Oc(Vc,1,Wc,Xc,0)}static newNoDocument(Yc,Zc){return new Oc(Yc,2,Zc,qc.empty(),0)}static newUnknownDocument($c,_c){return new Oc($c,3,_c,qc.empty(),2)}convertToFoundDocument(ad,bd){return this.version=ad,this.documentType=1,this.data=bd,this.documentState=0,this}convertToNoDocument(cd){return this.version=cd,this.documentType=2,this.data=qc.empty(),this.documentState=0,this}convertToUnknownDocument(dd){return this.version=dd,this.documentType=3,this.data=qc.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(ed){return ed instanceof Oc&&this.key.isEqual(ed.key)&&this.version.isEqual(ed.version)&&this.documentType===ed.documentType&&this.documentState===ed.documentState&&this.data.isEqual(ed.data)}clone(){return new Oc(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class fd{constructor(gd,hd=null,id=[],jd=[],kd=null,ld=null,md=null){this.path=gd,this.collectionGroup=hd,this.orderBy=id,this.filters=jd,this.limit=kd,this.startAt=ld,this.endAt=md,this.A=null}}function nd(a,b=null,c=[],d=[],e=null,f=null,g=null){return new fd(a,b,c,d,e,f,g)}function od(a){const b=x(a);if(null===b.A){let c=b.path.canonicalString();null!==b.collectionGroup&&(c+="|cg:"+b.collectionGroup),c+="|f:",c+=b.filters.map(a=>Ed(a)).join(","),c+="|ob:",c+=b.orderBy.map(a=>{var b;return(b=a).field.canonicalString()+b.dir}).join(","),Sb(b.limit)||(c+="|l:",c+=b.limit),b.startAt&&(c+="|lb:",c+=pe(b.startAt)),b.endAt&&(c+="|ub:",c+=pe(b.endAt)),b.A=c}return b.A}function pd(a,b){var c,d;if(a.limit!==b.limit)return!1;if(a.orderBy.length!==b.orderBy.length)return!1;for(let e=0;e<a.orderBy.length;e++)if(!te(a.orderBy[e],b.orderBy[e]))return!1;if(a.filters.length!==b.filters.length)return!1;for(let f=0;f<a.filters.length;f++)if(c=a.filters[f],d=b.filters[f],c.op!==d.op||!c.field.isEqual(d.field)||!ec(c.value,d.value))return!1;return a.collectionGroup===b.collectionGroup&& !!a.path.isEqual(b.path)&& !!ve(a.startAt,b.startAt)&&ve(a.endAt,b.endAt)}function qd(a){return Vb.isDocumentKey(a.path)&&null===a.collectionGroup&&0===a.filters.length}class rd extends class{}{constructor(sd,td,ud){super(),this.field=sd,this.op=td,this.value=ud}static create(vd,wd,xd){return vd.isKeyField()?"in"===wd||"not-in"===wd?this.R(vd,wd,xd):new Fd(vd,wd,xd):"array-contains"===wd?new Ud(vd,xd):"in"===wd?new Zd(vd,xd):"not-in"===wd?new ce(vd,xd):"array-contains-any"===wd?new he(vd,xd):new rd(vd,wd,xd)}static R(yd,zd,Ad){return"in"===zd?new Ld(yd,Ad):new Pd(yd,Ad)}matches(Bd){const Cd=Bd.data.field(this.field);return"!="===this.op?null!==Cd&&this.P(gc(Cd,this.value)):null!==Cd&&dc(this.value)===dc(Cd)&&this.P(gc(Cd,this.value))}P(Dd){switch(this.op){case"<":return Dd<0;case"<=":return Dd<=0;case"==":return 0===Dd;case"!=":return 0!==Dd;case">":return Dd>0;case">=":return Dd>=0;default:return v()}}v(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}function Ed(a){return a.field.canonicalString()+a.op.toString()+ic(a.value)}class Fd extends rd{constructor(Gd,Hd,Id){super(Gd,Hd,Id),this.key=Vb.fromName(Id.referenceValue)}matches(Jd){const Kd=Vb.comparator(Jd.key,this.key);return this.P(Kd)}}class Ld extends rd{constructor(Md,Nd){super(Md,"in",Nd),this.keys=Td("in",Nd)}matches(Od){return this.keys.some(a=>a.isEqual(Od.key))}}class Pd extends rd{constructor(Qd,Rd){super(Qd,"not-in",Rd),this.keys=Td("not-in",Rd)}matches(Sd){return!this.keys.some(a=>a.isEqual(Sd.key))}}function Td(a,b){var c;return((null===(c=b.arrayValue)|| void 0===c?void 0:c.values)||[]).map(a=>Vb.fromName(a.referenceValue))}class Ud extends rd{constructor(Vd,Wd){super(Vd,"array-contains",Wd)}matches(Xd){const Yd=Xd.data.field(this.field);return lc(Yd)&&fc(Yd.arrayValue,this.value)}}class Zd extends rd{constructor($d,_d){super($d,"in",_d)}matches(ae){const be=ae.data.field(this.field);return null!==be&&fc(this.value.arrayValue,be)}}class ce extends rd{constructor(de,ee){super(de,"not-in",ee)}matches(fe){if(fc(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const ge=fe.data.field(this.field);return null!==ge&&!fc(this.value.arrayValue,ge)}}class he extends rd{constructor(ie,je){super(ie,"array-contains-any",je)}matches(ke){const le=ke.data.field(this.field);return!(!lc(le)||!le.arrayValue.values)&&le.arrayValue.values.some(a=>fc(this.value.arrayValue,a))}}class me{constructor(ne,oe){this.position=ne,this.before=oe}}function pe(a){return`${a.before?"b":"a"}:${a.position.map(a=>ic(a)).join(",")}`}class qe{constructor(re,se="asc"){this.field=re,this.dir=se}}function te(a,b){return a.dir===b.dir&&a.field.isEqual(b.field)}function ue(a,b,c){let d=0;for(let e=0;e<a.position.length;e++){const f=b[e],g=a.position[e];if(d=f.field.isKeyField()?Vb.comparator(Vb.fromName(g.referenceValue),c.key):gc(g,c.data.field(f.field)),"desc"===f.dir&&(d*=-1),0!==d)break}return a.before?d<=0:d<0}function ve(a,b){if(null===a)return null===b;if(null===b)return!1;if(a.before!==b.before||a.position.length!==b.position.length)return!1;for(let c=0;c<a.position.length;c++)if(!ec(a.position[c],b.position[c]))return!1;return!0}class we{constructor(xe,ye=null,ze=[],Ae=[],Be=null,Ce="F",De=null,Ee=null){this.path=xe,this.collectionGroup=ye,this.explicitOrderBy=ze,this.filters=Ae,this.limit=Be,this.limitType=Ce,this.startAt=De,this.endAt=Ee,this.V=null,this.S=null,this.startAt,this.endAt}}function Fe(a){return new we(a)}function Ge(a){return!Sb(a.limit)&&"F"===a.limitType}function He(a){return!Sb(a.limit)&&"L"===a.limitType}function Ie(a){const b=x(a);if(null===b.V){var c;b.V=[];const d=function(a){for(const b of a.filters)if(b.v())return b.field;return null}(b),e=(c=b).explicitOrderBy.length>0?c.explicitOrderBy[0].field:null;if(null!==d&&null===e)d.isKeyField()||b.V.push(new qe(d)),b.V.push(new qe(lb.keyField(),"asc"));else{let f=!1;for(const g of b.explicitOrderBy)b.V.push(g),g.field.isKeyField()&&(f=!0);if(!f){const h=b.explicitOrderBy.length>0?b.explicitOrderBy[b.explicitOrderBy.length-1].dir:"asc";b.V.push(new qe(lb.keyField(),h))}}}return b.V}function Je(a){const b=x(a);if(!b.S)if("F"===b.limitType)b.S=nd(b.path,b.collectionGroup,Ie(b),b.filters,b.limit,b.startAt,b.endAt);else{const c=[];for(const d of Ie(b)){const e="desc"===d.dir?"asc":"desc";c.push(new qe(d.field,e))}const f=b.endAt?new me(b.endAt.position,!b.endAt.before):null,g=b.startAt?new me(b.startAt.position,!b.startAt.before):null;b.S=nd(b.path,b.collectionGroup,c,b.filters,b.limit,f,g)}return b.S}function Ke(a,b){return pd(Je(a),Je(b))&&a.limitType===b.limitType}function Le(a){return`${od(Je(a))}|lt:${a.limitType}`}function Me(a){var b;let c;return`Query(target=${c=(b=Je(a)).path.canonicalString(),null!==b.collectionGroup&&(c+=" collectionGroup="+b.collectionGroup),b.filters.length>0&&(c+=`, filters: [${b.filters.map(a=>{var b;return`${(b=a).field.canonicalString()} ${b.op} ${ic(b.value)}`}).join(", ")}]`),Sb(b.limit)||(c+=", limit: "+b.limit),b.orderBy.length>0&&(c+=`, orderBy: [${b.orderBy.map(a=>{var b;return b=a,`${b.field.canonicalString()} (${b.dir})`}).join(", ")}]`),b.startAt&&(c+=", startAt: "+pe(b.startAt)),b.endAt&&(c+=", endAt: "+pe(b.endAt)),`Target(${c})`}; limitType=${a.limitType})`}function Ne(a,b){var c,d;return b.isFoundDocument()&&(function(a,b){const c=b.key.path;return null!==a.collectionGroup?b.key.hasCollectionId(a.collectionGroup)&&a.path.isPrefixOf(c):Vb.isDocumentKey(a.path)?a.path.isEqual(c):a.path.isImmediateParentOf(c)})(a,b)&&(function(a,b){for(const c of a.explicitOrderBy)if(!c.field.isKeyField()&&null===b.data.field(c.field))return!1;return!0})(a,b)&&(function(a,b){for(const c of a.filters)if(!c.matches(b))return!1;return!0})(a,b)&&(c=a,d=b,(!c.startAt||!!ue(c.startAt,Ie(c),d))&&!(c.endAt&&ue(c.endAt,Ie(c),d)))}function Oe(a){return(b,c)=>{let d=!1;for(const e of Ie(a)){const f=Pe(e,b,c);if(0!==f)return f;d=d||e.field.isKeyField()}return 0}}function Pe(a,b,c){const d=a.field.isKeyField()?Vb.comparator(b.key,c.key):function(a,b,c){const d=b.data.field(a),e=c.data.field(a);return null!==d&&null!==e?gc(d,e):v()}(a.field,b,c);switch(a.dir){case"asc":return d;case"desc":return -1*d;default:return v()}}function Qe(a,b){if(a.D){if(isNaN(b))return{doubleValue:"NaN"};if(b===1/0)return{doubleValue:"Infinity"}}return{doubleValue:Tb(b)?"-0":b}}function Re(a){return{integerValue:""+a}}class Se{constructor(){this._=void 0}}function Te(a,b,c){return a instanceof We?(function(a,b){const c={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:a.seconds,nanos:a.nanoseconds}}}};return b&&(c.fields.__previous_value__=b),{mapValue:c}})(c,b):a instanceof Xe?Ze(a,b):a instanceof $e?af(a,b):(function(a,b){const c=Ve(a,b),d=ef(c)+ef(a.C);return kc(c)&&kc(a.C)?Re(d):Qe(a.N,d)})(a,b)}function Ue(a,b,c){return a instanceof Xe?Ze(a,b):a instanceof $e?af(a,b):c}function Ve(a,b){var c,d;return a instanceof bf?kc(c=b)||(d=c)&&"doubleValue"in d?b:{integerValue:0}:null}class We extends Se{}class Xe extends Se{constructor(Ye){super(),this.elements=Ye}}function Ze(a,b){const c=ff(b);for(const d of a.elements)c.some(a=>ec(a,d))||c.push(d);return{arrayValue:{values:c}}}class $e extends Se{constructor(_e){super(),this.elements=_e}}function af(a,b){let c=ff(b);for(const d of a.elements)c=c.filter(a=>!ec(a,d));return{arrayValue:{values:c}}}class bf extends Se{constructor(cf,df){super(),this.N=cf,this.C=df}}function ef(a){return Nb(a.integerValue||a.doubleValue)}function ff(a){return lc(a)&&a.arrayValue.values?a.arrayValue.values.slice():[]}class gf{constructor(hf,jf){this.field=hf,this.transform=jf}}class kf{constructor(lf,mf){this.version=lf,this.transformResults=mf}}class nf{constructor(of,pf){this.updateTime=of,this.exists=pf}static none(){return new nf}static exists(qf){return new nf(void 0,qf)}static updateTime(rf){return new nf(rf)}get isNone(){return void 0===this.updateTime&& void 0===this.exists}isEqual(sf){return this.exists===sf.exists&&(this.updateTime?!!sf.updateTime&&this.updateTime.isEqual(sf.updateTime):!sf.updateTime)}}function tf(a,b){return void 0!==a.updateTime?b.isFoundDocument()&&b.version.isEqual(a.updateTime):void 0===a.exists||a.exists===b.isFoundDocument()}class uf{}function vf(a,b,c){a instanceof Af?(function(a,b,c){const d=a.value.clone(),e=Mf(a.fieldTransforms,b,c.transformResults);d.setAll(e),b.convertToFoundDocument(c.version,d).setHasCommittedMutations()})(a,b,c):a instanceof Ff?(function(a,b,c){if(!tf(a.precondition,b))return void b.convertToUnknownDocument(c.version);const d=Mf(a.fieldTransforms,b,c.transformResults),e=b.data;e.setAll(Lf(a)),e.setAll(d),b.convertToFoundDocument(c.version,e).setHasCommittedMutations()})(a,b,c):(function(a,b,c){b.convertToNoDocument(c.version).setHasCommittedMutations()})(0,b,c)}function wf(a,b,c){var d,e;a instanceof Af?(function(a,b,c){if(tf(a.precondition,b)){const d=a.value.clone(),e=Nf(a.fieldTransforms,c,b);d.setAll(e),b.convertToFoundDocument(zf(b),d).setHasLocalMutations()}})(a,b,c):a instanceof Ff?(function(a,b,c){if(tf(a.precondition,b)){const d=Nf(a.fieldTransforms,c,b),e=b.data;e.setAll(Lf(a)),e.setAll(d),b.convertToFoundDocument(zf(b),e).setHasLocalMutations()}})(a,b,c):(d=a,e=b,tf(d.precondition,e)&&e.convertToNoDocument(Ba.min()))}function xf(a,b){let c=null;for(const d of a.fieldTransforms){const e=b.data.field(d.field),f=Ve(d.transform,e||null);null!=f&&(null==c&&(c=qc.empty()),c.set(d.field,f))}return c||null}function yf(a,b){var c,d;return a.type===b.type&& !!a.key.isEqual(b.key)&& !!a.precondition.isEqual(b.precondition)&&(c=a.fieldTransforms,d=b.fieldTransforms,!!(void 0===c&& void 0===d|| !(!c||!d)&&ra(c,d,(a,b)=>{var c,d,e,f;return c=a,d=b,c.field.isEqual(d.field)&&(e=c.transform,f=d.transform,e instanceof Xe&&f instanceof Xe||e instanceof $e&&f instanceof $e?ra(e.elements,f.elements,ec):e instanceof bf&&f instanceof bf?ec(e.C,f.C):e instanceof We&&f instanceof We)}))&&(0===a.type?a.value.isEqual(b.value):1!==a.type||a.data.isEqual(b.data)&&a.fieldMask.isEqual(b.fieldMask)))}function zf(a){return a.isFoundDocument()?a.version:Ba.min()}class Af extends uf{constructor(Bf,Cf,Df,Ef=[]){super(),this.key=Bf,this.value=Cf,this.precondition=Df,this.fieldTransforms=Ef,this.type=0}}class Ff extends uf{constructor(Gf,Hf,If,Jf,Kf=[]){super(),this.key=Gf,this.data=Hf,this.fieldMask=If,this.precondition=Jf,this.fieldTransforms=Kf,this.type=1}}function Lf(a){const b=new Map;return a.fieldMask.fields.forEach(c=>{if(!c.isEmpty()){const d=a.data.field(c);b.set(c,d)}}),b}function Mf(a,b,c){const d=new Map;w(a.length===c.length);for(let e=0;e<c.length;e++){const f=a[e],g=f.transform,h=b.data.field(f.field);d.set(f.field,Ue(g,h,c[e]))}return d}function Nf(a,b,c){const d=new Map;for(const e of a){const f=e.transform,g=c.data.field(e.field);d.set(e.field,Te(f,g,b))}return d}class Of extends uf{constructor(Pf,Qf){super(),this.key=Pf,this.precondition=Qf,this.type=2,this.fieldTransforms=[]}}class Rf extends uf{constructor(Sf,Tf){super(),this.key=Sf,this.precondition=Tf,this.type=3,this.fieldTransforms=[]}}class Uf{constructor(Vf){this.count=Vf}}function Wf(a){if(void 0===a)return s("GRPC error has no .code"),y.UNKNOWN;switch(a){case d.OK:return y.OK;case d.CANCELLED:return y.CANCELLED;case d.UNKNOWN:return y.UNKNOWN;case d.DEADLINE_EXCEEDED:return y.DEADLINE_EXCEEDED;case d.RESOURCE_EXHAUSTED:return y.RESOURCE_EXHAUSTED;case d.INTERNAL:return y.INTERNAL;case d.UNAVAILABLE:return y.UNAVAILABLE;case d.UNAUTHENTICATED:return y.UNAUTHENTICATED;case d.INVALID_ARGUMENT:return y.INVALID_ARGUMENT;case d.NOT_FOUND:return y.NOT_FOUND;case d.ALREADY_EXISTS:return y.ALREADY_EXISTS;case d.PERMISSION_DENIED:return y.PERMISSION_DENIED;case d.FAILED_PRECONDITION:return y.FAILED_PRECONDITION;case d.ABORTED:return y.ABORTED;case d.OUT_OF_RANGE:return y.OUT_OF_RANGE;case d.UNIMPLEMENTED:return y.UNIMPLEMENTED;case d.DATA_LOSS:return y.DATA_LOSS;default:return v()}}(e=d||(d={}))[e.OK=0]="OK",e[e.CANCELLED=1]="CANCELLED",e[e.UNKNOWN=2]="UNKNOWN",e[e.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",e[e.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",e[e.NOT_FOUND=5]="NOT_FOUND",e[e.ALREADY_EXISTS=6]="ALREADY_EXISTS",e[e.PERMISSION_DENIED=7]="PERMISSION_DENIED",e[e.UNAUTHENTICATED=16]="UNAUTHENTICATED",e[e.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",e[e.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",e[e.ABORTED=10]="ABORTED",e[e.OUT_OF_RANGE=11]="OUT_OF_RANGE",e[e.UNIMPLEMENTED=12]="UNIMPLEMENTED",e[e.INTERNAL=13]="INTERNAL",e[e.UNAVAILABLE=14]="UNAVAILABLE",e[e.DATA_LOSS=15]="DATA_LOSS";class Xf{constructor(Yf,Zf){this.comparator=Yf,this.root=Zf||xg.EMPTY}insert($f,_f){return new Xf(this.comparator,this.root.insert($f,_f,this.comparator).copy(null,null,xg.BLACK,null,null))}remove(ag){return new Xf(this.comparator,this.root.remove(ag,this.comparator).copy(null,null,xg.BLACK,null,null))}get(bg){let cg=this.root;for(;!cg.isEmpty();){const dg=this.comparator(bg,cg.key);if(0===dg)return cg.value;dg<0?cg=cg.left:dg>0&&(cg=cg.right)}return null}indexOf(eg){let fg=0,gg=this.root;for(;!gg.isEmpty();){const hg=this.comparator(eg,gg.key);if(0===hg)return fg+gg.left.size;hg<0?gg=gg.left:(fg+=gg.left.size+1,gg=gg.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(ig){return this.root.inorderTraversal(ig)}forEach(jg){this.inorderTraversal((a,b)=>(jg(a,b),!1))}toString(){const kg=[];return this.inorderTraversal((a,b)=>(kg.push(`${a}:${b}`),!1)),`{${kg.join(", ")}}`}reverseTraversal(lg){return this.root.reverseTraversal(lg)}getIterator(){return new og(this.root,null,this.comparator,!1)}getIteratorFrom(mg){return new og(this.root,mg,this.comparator,!1)}getReverseIterator(){return new og(this.root,null,this.comparator,!0)}getReverseIteratorFrom(ng){return new og(this.root,ng,this.comparator,!0)}}class og{constructor(pg,qg,rg,sg){this.isReverse=sg,this.nodeStack=[];let tg=1;for(;!pg.isEmpty();)if(tg=qg?rg(pg.key,qg):1,sg&&(tg*=-1),tg<0)pg=this.isReverse?pg.left:pg.right;else{if(0===tg){this.nodeStack.push(pg);break}this.nodeStack.push(pg),pg=this.isReverse?pg.right:pg.left}}getNext(){let ug=this.nodeStack.pop();const vg={key:ug.key,value:ug.value};if(this.isReverse)for(ug=ug.left;!ug.isEmpty();)this.nodeStack.push(ug),ug=ug.right;else for(ug=ug.right;!ug.isEmpty();)this.nodeStack.push(ug),ug=ug.left;return vg}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const wg=this.nodeStack[this.nodeStack.length-1];return{key:wg.key,value:wg.value}}}class xg{constructor(yg,zg,Ag,Bg,Cg){this.key=yg,this.value=zg,this.color=null!=Ag?Ag:xg.RED,this.left=null!=Bg?Bg:xg.EMPTY,this.right=null!=Cg?Cg:xg.EMPTY,this.size=this.left.size+1+this.right.size}copy(Dg,Eg,Fg,Gg,Hg){return new xg(null!=Dg?Dg:this.key,null!=Eg?Eg:this.value,null!=Fg?Fg:this.color,null!=Gg?Gg:this.left,null!=Hg?Hg:this.right)}isEmpty(){return!1}inorderTraversal(Ig){return this.left.inorderTraversal(Ig)||Ig(this.key,this.value)||this.right.inorderTraversal(Ig)}reverseTraversal(Jg){return this.right.reverseTraversal(Jg)||Jg(this.key,this.value)||this.left.reverseTraversal(Jg)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(Kg,Lg,Mg){let Ng=this;const Og=Mg(Kg,Ng.key);return(Ng=Og<0?Ng.copy(null,null,null,Ng.left.insert(Kg,Lg,Mg),null):0===Og?Ng.copy(null,Lg,null,null,null):Ng.copy(null,null,null,null,Ng.right.insert(Kg,Lg,Mg))).fixUp()}removeMin(){if(this.left.isEmpty())return xg.EMPTY;let Pg=this;return Pg.left.isRed()||Pg.left.left.isRed()||(Pg=Pg.moveRedLeft()),(Pg=Pg.copy(null,null,null,Pg.left.removeMin(),null)).fixUp()}remove(Qg,Rg){let Sg,Tg=this;if(0>Rg(Qg,Tg.key))Tg.left.isEmpty()||Tg.left.isRed()||Tg.left.left.isRed()||(Tg=Tg.moveRedLeft()),Tg=Tg.copy(null,null,null,Tg.left.remove(Qg,Rg),null);else{if(Tg.left.isRed()&&(Tg=Tg.rotateRight()),Tg.right.isEmpty()||Tg.right.isRed()||Tg.right.left.isRed()||(Tg=Tg.moveRedRight()),0===Rg(Qg,Tg.key)){if(Tg.right.isEmpty())return xg.EMPTY;Sg=Tg.right.min(),Tg=Tg.copy(Sg.key,Sg.value,null,null,Tg.right.removeMin())}Tg=Tg.copy(null,null,null,null,Tg.right.remove(Qg,Rg))}return Tg.fixUp()}isRed(){return this.color}fixUp(){let Ug=this;return Ug.right.isRed()&&!Ug.left.isRed()&&(Ug=Ug.rotateLeft()),Ug.left.isRed()&&Ug.left.left.isRed()&&(Ug=Ug.rotateRight()),Ug.left.isRed()&&Ug.right.isRed()&&(Ug=Ug.colorFlip()),Ug}moveRedLeft(){let Vg=this.colorFlip();return Vg.right.left.isRed()&&(Vg=(Vg=(Vg=Vg.copy(null,null,null,null,Vg.right.rotateRight())).rotateLeft()).colorFlip()),Vg}moveRedRight(){let Wg=this.colorFlip();return Wg.left.left.isRed()&&(Wg=(Wg=Wg.rotateRight()).colorFlip()),Wg}rotateLeft(){const Xg=this.copy(null,null,xg.RED,null,this.right.left);return this.right.copy(null,null,this.color,Xg,null)}rotateRight(){const Yg=this.copy(null,null,xg.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,Yg)}colorFlip(){const Zg=this.left.copy(null,null,!this.left.color,null,null),$g=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,Zg,$g)}checkMaxDepth(){const _g=this.check();return Math.pow(2,_g)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const ah=this.left.check();if(ah!==this.right.check())throw v();return ah+(this.isRed()?0:1)}}xg.EMPTY=null,xg.RED=!0,xg.BLACK=!1,xg.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(bh,ch,dh,eh,fh){return this}insert(gh,hh,ih){return new xg(gh,hh)}remove(jh,kh){return this}isEmpty(){return!0}inorderTraversal(lh){return!1}reverseTraversal(mh){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class nh{constructor(oh){this.comparator=oh,this.data=new Xf(this.comparator)}has(ph){return null!==this.data.get(ph)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(qh){return this.data.indexOf(qh)}forEach(rh){this.data.inorderTraversal((a,b)=>(rh(a),!1))}forEachInRange(sh,th){const uh=this.data.getIteratorFrom(sh[0]);for(;uh.hasNext();){const vh=uh.getNext();if(this.comparator(vh.key,sh[1])>=0)return;th(vh.key)}}forEachWhile(wh,xh){let yh;for(yh=void 0!==xh?this.data.getIteratorFrom(xh):this.data.getIterator();yh.hasNext();)if(!wh(yh.getNext().key))return}firstAfterOrEqual(zh){const Ah=this.data.getIteratorFrom(zh);return Ah.hasNext()?Ah.getNext().key:null}getIterator(){return new Ph(this.data.getIterator())}getIteratorFrom(Bh){return new Ph(this.data.getIteratorFrom(Bh))}add(Ch){return this.copy(this.data.remove(Ch).insert(Ch,!0))}delete(Dh){return this.has(Dh)?this.copy(this.data.remove(Dh)):this}isEmpty(){return this.data.isEmpty()}unionWith(Eh){let Fh=this;return Fh.size<Eh.size&&(Fh=Eh,Eh=this),Eh.forEach(a=>{Fh=Fh.add(a)}),Fh}isEqual(Gh){if(!(Gh instanceof nh))return!1;if(this.size!==Gh.size)return!1;const Hh=this.data.getIterator(),Ih=Gh.data.getIterator();for(;Hh.hasNext();){const Jh=Hh.getNext().key,Kh=Ih.getNext().key;if(0!==this.comparator(Jh,Kh))return!1}return!0}toArray(){const Lh=[];return this.forEach(a=>{Lh.push(a)}),Lh}toString(){const Mh=[];return this.forEach(a=>Mh.push(a)),"SortedSet("+Mh.toString()+")"}copy(Nh){const Oh=new nh(this.comparator);return Oh.data=Nh,Oh}}class Ph{constructor(Qh){this.iter=Qh}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const Rh=new Xf(Vb.comparator);function Sh(){return Rh}const Th=new Xf(Vb.comparator);function Uh(){return Th}const Vh=new Xf(Vb.comparator);function Wh(){return Vh}const Xh=new nh(Vb.comparator);function Yh(...a){let b=Xh;for(const c of a)b=b.add(c);return b}const Zh=new nh(qa);function $h(){return Zh}class _h{constructor(ai,bi,ci,di,ei){this.snapshotVersion=ai,this.targetChanges=bi,this.targetMismatches=ci,this.documentUpdates=di,this.resolvedLimboDocuments=ei}static createSynthesizedRemoteEventForCurrentChange(fi,gi){const hi=new Map;return hi.set(fi,ii.createSynthesizedTargetChangeForCurrentChange(fi,gi)),new _h(Ba.min(),hi,$h(),Sh(),Yh())}}class ii{constructor(ji,ki,li,mi,ni){this.resumeToken=ji,this.current=ki,this.addedDocuments=li,this.modifiedDocuments=mi,this.removedDocuments=ni}static createSynthesizedTargetChangeForCurrentChange(oi,pi){return new ii(Db.EMPTY_BYTE_STRING,pi,Yh(),Yh(),Yh())}}class qi{constructor(ri,si,ti,ui){this.k=ri,this.removedTargetIds=si,this.key=ti,this.$=ui}}class vi{constructor(wi,xi){this.targetId=wi,this.O=xi}}class yi{constructor(zi,Ai,Bi=Db.EMPTY_BYTE_STRING,Ci=null){this.state=zi,this.targetIds=Ai,this.resumeToken=Bi,this.cause=Ci}}class Di{constructor(){this.F=0,this.M=yj(),this.L=Db.EMPTY_BYTE_STRING,this.B=!1,this.U=!0}get current(){return this.B}get resumeToken(){return this.L}get q(){return 0!==this.F}get K(){return this.U}j(Ei){Ei.approximateByteSize()>0&&(this.U=!0,this.L=Ei)}W(){let Fi=Yh(),Gi=Yh(),Hi=Yh();return this.M.forEach((a,b)=>{switch(b){case 0:Fi=Fi.add(a);break;case 2:Gi=Gi.add(a);break;case 1:Hi=Hi.add(a);break;default:v()}}),new ii(this.L,this.B,Fi,Gi,Hi)}G(){this.U=!1,this.M=yj()}H(Ii,Ji){this.U=!0,this.M=this.M.insert(Ii,Ji)}J(Ki){this.U=!0,this.M=this.M.remove(Ki)}Y(){this.F+=1}X(){this.F-=1}Z(){this.U=!0,this.B=!0}}class Li{constructor(Mi){this.tt=Mi,this.et=new Map,this.nt=Sh(),this.st=xj(),this.it=new nh(qa)}rt(Ni){for(const Oi of Ni.k)Ni.$&&Ni.$.isFoundDocument()?this.ot(Oi,Ni.$):this.ct(Oi,Ni.key,Ni.$);for(const Pi of Ni.removedTargetIds)this.ct(Pi,Ni.key,Ni.$)}at(Qi){this.forEachTarget(Qi,a=>{const b=this.ut(a);switch(Qi.state){case 0:this.ht(a)&&b.j(Qi.resumeToken);break;case 1:b.X(),b.q||b.G(),b.j(Qi.resumeToken);break;case 2:b.X(),b.q||this.removeTarget(a);break;case 3:this.ht(a)&&(b.Z(),b.j(Qi.resumeToken));break;case 4:this.ht(a)&&(this.lt(a),b.j(Qi.resumeToken));break;default:v()}})}forEachTarget(Ri,Si){Ri.targetIds.length>0?Ri.targetIds.forEach(Si):this.et.forEach((a,b)=>{this.ht(b)&&Si(b)})}ft(Ti){const Ui=Ti.targetId,Vi=Ti.O.count,Wi=this.dt(Ui);if(Wi){const Xi=Wi.target;if(qd(Xi))if(0===Vi){const Yi=new Vb(Xi.path);this.ct(Ui,Yi,Oc.newNoDocument(Yi,Ba.min()))}else w(1===Vi);else this.wt(Ui)!==Vi&&(this.lt(Ui),this.it=this.it.add(Ui))}}_t(Zi){const $i=new Map;this.et.forEach((a,b)=>{const c=this.dt(b);if(c){if(a.current&&qd(c.target)){const d=new Vb(c.target.path);null!==this.nt.get(d)||this.gt(b,d)||this.ct(b,d,Oc.newNoDocument(d,Zi))}a.K&&($i.set(b,a.W()),a.G())}});let _i=Yh();this.st.forEach((a,b)=>{let c=!0;b.forEachWhile(a=>{const b=this.dt(a);return!b||2===b.purpose||(c=!1,!1)}),c&&(_i=_i.add(a))});const aj=new _h(Zi,$i,this.it,this.nt,_i);return this.nt=Sh(),this.st=xj(),this.it=new nh(qa),aj}ot(bj,cj){if(this.ht(bj)){const dj=this.gt(bj,cj.key)?2:0;this.ut(bj).H(cj.key,dj),this.nt=this.nt.insert(cj.key,cj),this.st=this.st.insert(cj.key,this.yt(cj.key).add(bj))}}ct(ej,fj,gj){if(this.ht(ej)){const hj=this.ut(ej);this.gt(ej,fj)?hj.H(fj,1):hj.J(fj),this.st=this.st.insert(fj,this.yt(fj).delete(ej)),gj&&(this.nt=this.nt.insert(fj,gj))}}removeTarget(ij){this.et.delete(ij)}wt(jj){const kj=this.ut(jj).W();return this.tt.getRemoteKeysForTarget(jj).size+kj.addedDocuments.size-kj.removedDocuments.size}Y(lj){this.ut(lj).Y()}ut(mj){let nj=this.et.get(mj);return nj||(nj=new Di,this.et.set(mj,nj)),nj}yt(oj){let pj=this.st.get(oj);return pj||(pj=new nh(qa),this.st=this.st.insert(oj,pj)),pj}ht(qj){const rj=null!==this.dt(qj);return rj||r("WatchChangeAggregator","Detected inactive target",qj),rj}dt(sj){const tj=this.et.get(sj);return tj&&tj.q?null:this.tt.Tt(sj)}lt(uj){this.et.set(uj,new Di),this.tt.getRemoteKeysForTarget(uj).forEach(a=>{this.ct(uj,a,null)})}gt(vj,wj){return this.tt.getRemoteKeysForTarget(vj).has(wj)}}function xj(){return new Xf(Vb.comparator)}function yj(){return new Xf(Vb.comparator)}const zj={asc:"ASCENDING",desc:"DESCENDING"},Aj={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Bj{constructor(Cj,Dj){this.databaseId=Cj,this.D=Dj}}function Ej(a,b){return a.D?`${new Date(1000*b.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+b.nanoseconds).slice(-9)}Z`:{seconds:""+b.seconds,nanos:b.nanoseconds}}function Fj(a,b){return a.D?b.toBase64():b.toUint8Array()}function Gj(a){return w(!!a),Ba.fromTimestamp(function(a){const b=Mb(a);return new sa(b.seconds,b.nanos)}(a))}function Hj(a,b){var c;return(c=a,new db(["projects",c.projectId,"databases",c.database])).child("documents").child(b).canonicalString()}function Ij(a){const b=db.fromString(a);return w(Zj(b)),b}function Jj(a,b){return Hj(a.databaseId,b.path)}function Kj(a,b){const c=Ij(b);if(c.get(1)!==a.databaseId.projectId)throw new z(y.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+c.get(1)+" vs "+a.databaseId.projectId);if(c.get(3)!==a.databaseId.database)throw new z(y.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+c.get(3)+" vs "+a.databaseId.database);return new Vb(Nj(c))}function Lj(a,b){return Hj(a.databaseId,b)}function Mj(a){return new db(["projects",a.databaseId.projectId,"databases",a.databaseId.database]).canonicalString()}function Nj(a){return w(a.length>4&&"documents"===a.get(4)),a.popFirst(5)}function Oj(a,b,c){return{name:Jj(a,b),fields:c.value.mapValue.fields}}function Pj(a,b){var c,d;let e;if(b instanceof Af)e={update:Oj(a,b.key,b.value)};else if(b instanceof Of)e={delete:Jj(a,b.key)};else if(b instanceof Ff)e={update:Oj(a,b.key,b.data),updateMask:Yj(b.fieldMask)};else{if(!(b instanceof Rf))return v();e={verify:Jj(a,b.key)}}return b.fieldTransforms.length>0&&(e.updateTransforms=b.fieldTransforms.map(a=>(function(a,b){const c=b.transform;if(c instanceof We)return{fieldPath:b.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(c instanceof Xe)return{fieldPath:b.field.canonicalString(),appendMissingElements:{values:c.elements}};if(c instanceof $e)return{fieldPath:b.field.canonicalString(),removeAllFromArray:{values:c.elements}};if(c instanceof bf)return{fieldPath:b.field.canonicalString(),increment:c.C};throw v()})(0,a))),b.precondition.isNone||(e.currentDocument=(c=a,void 0!==(d=b.precondition).updateTime?{updateTime:Ej(c,d.updateTime.toTimestamp())}:void 0!==d.exists?{exists:d.exists}:v())),e}function Qj(a,b){var c;const d=b.currentDocument?void 0!==(c=b.currentDocument).updateTime?nf.updateTime(Gj(c.updateTime)):void 0!==c.exists?nf.exists(c.exists):nf.none():nf.none(),e=b.updateTransforms?b.updateTransforms.map(b=>(function(a,b){let c=null;if("setToServerValue"in b)w("REQUEST_TIME"===b.setToServerValue),c=new We;else if("appendMissingElements"in b){const d=b.appendMissingElements.values||[];c=new Xe(d)}else if("removeAllFromArray"in b){const e=b.removeAllFromArray.values||[];c=new $e(e)}else"increment"in b?c=new bf(a,b.increment):v();const f=lb.fromServerFormat(b.fieldPath);return new gf(f,c)})(a,b)):[];if(b.update){b.update.name;const f=Kj(a,b.update.name),g=new qc({mapValue:{fields:b.update.fields}});if(b.updateMask){const h=function(a){const b=a.fieldPaths||[];return new yb(b.map(a=>lb.fromServerFormat(a)))}(b.updateMask);return new Ff(f,g,h,d,e)}return new Af(f,g,d,e)}if(b.delete){const i=Kj(a,b.delete);return new Of(i,d)}if(b.verify){const j=Kj(a,b.verify);return new Rf(j,d)}return v()}function Rj(a){return a?void 0!==a.unaryFilter?[Xj(a)]:void 0!==a.fieldFilter?[Wj(a)]:void 0!==a.compositeFilter?a.compositeFilter.filters.map(a=>Rj(a)).reduce((a,b)=>a.concat(b)):v():[]}function Sj(a){return{before:a.before,values:a.position}}function Tj(a){const b=!!a.before,c=a.values||[];return new me(c,b)}function Uj(a){return{fieldPath:a.canonicalString()}}function Vj(a){return lb.fromServerFormat(a.fieldPath)}function Wj(a){return rd.create(Vj(a.fieldFilter.field),function(a){switch(a){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(a.fieldFilter.op),a.fieldFilter.value)}function Xj(a){switch(a.unaryFilter.op){case"IS_NAN":const b=Vj(a.unaryFilter.field);return rd.create(b,"==",{doubleValue:NaN});case"IS_NULL":const c=Vj(a.unaryFilter.field);return rd.create(c,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const d=Vj(a.unaryFilter.field);return rd.create(d,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const e=Vj(a.unaryFilter.field);return rd.create(e,"!=",{nullValue:"NULL_VALUE"});default:return v()}}function Yj(a){const b=[];return a.fields.forEach(a=>b.push(a.canonicalString())),{fieldPaths:b}}function Zj(a){return a.length>=4&&"projects"===a.get(0)&&"databases"===a.get(2)}function $j(a){let b="";for(let c=0;c<a.length;c++)b.length>0&&(b=ak(b)),b=_j(a.get(c),b);return ak(b)}function _j(a,b){let c=b;const d=a.length;for(let e=0;e<d;e++){const f=a.charAt(e);switch(f){case"\x00":c+="\x01\x10";break;case"\x01":c+="\x01\x11";break;default:c+=f}}return c}function ak(a){return a+"\x01\x01"}function bk(a){const b=a.length;if(w(b>=2),2===b)return w("\x01"===a.charAt(0)&&"\x01"===a.charAt(1)),db.emptyPath();const c=[];let d="";for(let e=0;e<b;){const f=a.indexOf("\x01",e);switch((f<0||f>g)&&v(),a.charAt(f+1)){case"\x01":const g=a.substring(e,f);let h;0===d.length?h=g:(h=d+=g,d=""),c.push(h);break;case"\x10":d+=a.substring(e,f),d+="\x00";break;case"\x11":d+=a.substring(e,f+1);break;default:v()}e=f+2}return new db(c)}class ck{constructor(dk,ek,fk){this.ownerId=dk,this.allowTabSynchronization=ek,this.leaseTimestampMs=fk}}ck.store="owner",ck.key="owner";class gk{constructor(hk,ik,jk){this.userId=hk,this.lastAcknowledgedBatchId=ik,this.lastStreamToken=jk}}gk.store="mutationQueues",gk.keyPath="userId";class kk{constructor(lk,mk,nk,ok,pk){this.userId=lk,this.batchId=mk,this.localWriteTimeMs=nk,this.baseMutations=ok,this.mutations=pk}}kk.store="mutations",kk.keyPath="batchId",kk.userMutationsIndex="userMutationsIndex",kk.userMutationsKeyPath=["userId","batchId"];class qk{constructor(){}static prefixForUser(rk){return[rk]}static prefixForPath(sk,tk){return[sk,$j(tk)]}static key(uk,vk,wk){return[uk,$j(vk),wk]}}qk.store="documentMutations",qk.PLACEHOLDER=new qk;class xk{constructor(yk,zk,Ak,Bk,Ck,Dk){this.unknownDocument=yk,this.noDocument=zk,this.document=Ak,this.hasCommittedMutations=Bk,this.readTime=Ck,this.parentPath=Dk}}xk.store="remoteDocuments",xk.readTimeIndex="readTimeIndex",xk.readTimeIndexPath="readTime",xk.collectionReadTimeIndex="collectionReadTimeIndex",xk.collectionReadTimeIndexPath=["parentPath","readTime"];class Ek{constructor(Fk){this.byteSize=Fk}}Ek.store="remoteDocumentGlobal",Ek.key="remoteDocumentGlobalKey";class Gk{constructor(Hk,Ik,Jk,Kk,Lk,Mk,Nk){this.targetId=Hk,this.canonicalId=Ik,this.readTime=Jk,this.resumeToken=Kk,this.lastListenSequenceNumber=Lk,this.lastLimboFreeSnapshotVersion=Mk,this.query=Nk}}Gk.store="targets",Gk.keyPath="targetId",Gk.queryTargetsIndexName="queryTargetsIndex",Gk.queryTargetsKeyPath=["canonicalId","targetId"];class Ok{constructor(Pk,Qk,Rk){this.targetId=Pk,this.path=Qk,this.sequenceNumber=Rk}}Ok.store="targetDocuments",Ok.keyPath=["targetId","path"],Ok.documentTargetsIndex="documentTargetsIndex",Ok.documentTargetsKeyPath=["path","targetId"];class Sk{constructor(Tk,Uk,Vk,Wk){this.highestTargetId=Tk,this.highestListenSequenceNumber=Uk,this.lastRemoteSnapshotVersion=Vk,this.targetCount=Wk}}Sk.key="targetGlobalKey",Sk.store="targetGlobal";class Xk{constructor(Yk,Zk){this.collectionId=Yk,this.parent=Zk}}Xk.store="collectionParents",Xk.keyPath=["collectionId","parent"];class $k{constructor(_k,al,bl,cl){this.clientId=_k,this.updateTimeMs=al,this.networkEnabled=bl,this.inForeground=cl}}$k.store="clientMetadata",$k.keyPath="clientId";class dl{constructor(el,fl,gl){this.bundleId=el,this.createTime=fl,this.version=gl}}dl.store="bundles",dl.keyPath="bundleId";class hl{constructor(il,jl,kl){this.name=il,this.readTime=jl,this.bundledQuery=kl}}hl.store="namedQueries",hl.keyPath="name";class ll{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(ml){this.onCommittedListeners.push(ml)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(a=>a())}}class nl{constructor(ol){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,ol(a=>{this.isDone=!0,this.result=a,this.nextCallback&&this.nextCallback(a)},a=>{this.isDone=!0,this.error=a,this.catchCallback&&this.catchCallback(a)})}catch(pl){return this.next(void 0,pl)}next(ql,rl){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(rl,this.error):this.wrapSuccess(ql,this.result):new nl((a,b)=>{this.nextCallback=c=>{this.wrapSuccess(ql,c).next(a,b)},this.catchCallback=c=>{this.wrapFailure(rl,c).next(a,b)}})}toPromise(){return new Promise((a,b)=>{this.next(a,b)})}wrapUserFunction(sl){try{const tl=sl();return tl instanceof nl?tl:nl.resolve(tl)}catch(ul){return nl.reject(ul)}}wrapSuccess(vl,wl){return vl?this.wrapUserFunction(()=>vl(wl)):nl.resolve(wl)}wrapFailure(xl,yl){return xl?this.wrapUserFunction(()=>xl(yl)):nl.reject(yl)}static resolve(zl){return new nl((a,b)=>{a(zl)})}static reject(Al){return new nl((a,b)=>{b(Al)})}static waitFor(Bl){return new nl((a,b)=>{let c=0,d=0,e=!1;Bl.forEach(f=>{++c,f.next(()=>{++d,e&&d===c&&a()},a=>b(a))}),e=!0,d===c&&a()})}static or(Cl){let Dl=nl.resolve(!1);for(const El of Cl)Dl=Dl.next(a=>a?nl.resolve(a):El());return Dl}static forEach(Fl,Gl){const Hl=[];return Fl.forEach((a,b)=>{Hl.push(Gl.call(this,a,b))}),this.waitFor(Hl)}}class Il{constructor(Jl,Kl){this.action=Jl,this.transaction=Kl,this.aborted=!1,this.Et=new C,this.transaction.oncomplete=()=>{this.Et.resolve()},this.transaction.onabort=()=>{Kl.error?this.Et.reject(new Am(Jl,Kl.error)):this.Et.resolve()},this.transaction.onerror=a=>{const b=kn(a.target.error);this.Et.reject(new Am(Jl,b))}}static open(Ll,Ml,Nl,Ol){try{return new Il(Ml,Ll.transaction(Ol,Nl))}catch(Pl){throw new Am(Ml,Pl)}}get It(){return this.Et.promise}abort(Ql){Ql&&this.Et.reject(Ql),this.aborted||(r("SimpleDb","Aborting transaction:",Ql?Ql.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(Rl){const Sl=this.transaction.objectStore(Rl);return new Em(Sl)}}class Tl{constructor(Ul,Vl,Wl){this.name=Ul,this.version=Vl,this.At=Wl,12.2===Tl.Rt(getUA())&&s("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(Xl){return r("SimpleDb","Removing database:",Xl),hn(window.indexedDB.deleteDatabase(Xl)).toPromise()}static bt(){if(!isIndexedDBAvailable())return!1;if(Tl.Pt())return!0;const Yl=getUA(),Zl=Tl.Rt(Yl),$l=0<Zl&&Zl<10,_l=Tl.vt(Yl),am=0<_l&&_l<4.5;return!(Yl.indexOf("MSIE ")>0||Yl.indexOf("Trident/")>0||Yl.indexOf("Edge/")>0||$l||am)}static Pt(){var bm;return void 0!==k&&"YES"===(null===(bm=k.env)|| void 0===bm?void 0:bm.Vt)}static St(cm,dm){return cm.store(dm)}static Rt(em){const fm=em.match(/i(?:phone|pad|pod) os ([\d_]+)/i),gm=fm?fm[1].split("_").slice(0,2).join("."):"-1";return Number(gm)}static vt(hm){const im=hm.match(/Android ([\d.]+)/i),jm=im?im[1].split(".").slice(0,2).join("."):"-1";return Number(jm)}async Dt(km){return this.db||(r("SimpleDb","Opening database:",this.name),this.db=await new Promise((a,b)=>{const c=indexedDB.open(this.name,this.version);c.onsuccess=b=>{const c=b.target.result;a(c)},c.onblocked=()=>{b(new Am(km,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},c.onerror=a=>{const c=a.target.error;"VersionError"===c.name?b(new z(y.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===c.name?b(new z(y.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+c)):b(new Am(km,c))},c.onupgradeneeded=a=>{r("SimpleDb","Database \""+this.name+"\" requires upgrade from version:",a.oldVersion);const b=a.target.result;this.At.Ct(b,c.transaction,a.oldVersion,this.version).next(()=>{r("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.Nt&&(this.db.onversionchange=a=>this.Nt(a)),this.db}xt(lm){this.Nt=lm,this.db&&(this.db.onversionchange=a=>lm(a))}async runTransaction(mm,nm,om,pm){const qm="readonly"===nm;let rm=0;for(;;){++rm;try{this.db=await this.Dt(mm);const sm=Il.open(this.db,mm,qm?"readonly":"readwrite",om),tm=pm(sm).catch(a=>(sm.abort(a),nl.reject(a))).toPromise();return tm.catch(()=>{}),await sm.It,tm}catch(um){const vm="FirebaseError"!==um.name&&rm<3;if(r("SimpleDb","Transaction failed with error:",um.message,"Retrying:",vm),this.close(),!vm)return Promise.reject(um)}}}close(){this.db&&this.db.close(),this.db=void 0}}class wm{constructor(xm){this.kt=xm,this.$t=!1,this.Ot=null}get isDone(){return this.$t}get Ft(){return this.Ot}set cursor(ym){this.kt=ym}done(){this.$t=!0}Mt(zm){this.Ot=zm}delete(){return hn(this.kt.delete())}}class Am extends null{constructor(Bm,Cm){super(y.UNAVAILABLE,`IndexedDB transaction '${Bm}' failed: ${Cm}`),this.name="IndexedDbTransactionError"}}function Dm(a){return"IndexedDbTransactionError"===a.name}class Em{constructor(Fm){this.store=Fm}put(Gm,Hm){let Im;return void 0!==Hm?(r("SimpleDb","PUT",this.store.name,Gm,Hm),Im=this.store.put(Hm,Gm)):(r("SimpleDb","PUT",this.store.name,"<auto-key>",Gm),Im=this.store.put(Gm)),hn(Im)}add(Jm){return r("SimpleDb","ADD",this.store.name,Jm,Jm),hn(this.store.add(Jm))}get(Km){return hn(this.store.get(Km)).next(a=>(void 0===a&&(a=null),r("SimpleDb","GET",this.store.name,Km,a),a))}delete(Lm){return r("SimpleDb","DELETE",this.store.name,Lm),hn(this.store.delete(Lm))}count(){return r("SimpleDb","COUNT",this.store.name),hn(this.store.count())}Lt(Mm,Nm){const Om=this.cursor(this.options(Mm,Nm)),Pm=[];return this.Bt(Om,(a,b)=>{Pm.push(b)}).next(()=>Pm)}Ut(Qm,Rm){r("SimpleDb","DELETE ALL",this.store.name);const Sm=this.options(Qm,Rm);Sm.qt=!1;const Tm=this.cursor(Sm);return this.Bt(Tm,(a,b,c)=>c.delete())}Kt(Um,Vm){let Wm;Vm?Wm=Um:(Wm={},Vm=Um);const Xm=this.cursor(Wm);return this.Bt(Xm,Vm)}jt(Ym){const Zm=this.cursor({});return new nl((a,b)=>{Zm.onerror=a=>{const c=kn(a.target.error);b(c)},Zm.onsuccess=b=>{const c=b.target.result;c?Ym(c.primaryKey,c.value).next(b=>{b?c.continue():a()}):a()}})}Bt($m,_m){const an=[];return new nl((a,b)=>{$m.onerror=a=>{b(a.target.error)},$m.onsuccess=b=>{const c=b.target.result;if(!c)return void a();const d=new wm(c),e=_m(c.primaryKey,c.value,d);if(e instanceof nl){const f=e.catch(a=>(d.done(),nl.reject(a)));an.push(f)}d.isDone?a():null===d.Ft?c.continue():c.continue(d.Ft)}}).next(()=>nl.waitFor(an))}options(bn,cn){let dn;return void 0!==bn&&("string"==typeof bn?dn=bn:cn=bn),{index:dn,range:cn}}cursor(en){let fn="next";if(en.reverse&&(fn="prev"),en.index){const gn=this.store.index(en.index);return en.qt?gn.openKeyCursor(en.range,fn):gn.openCursor(en.range,fn)}return this.store.openCursor(en.range,fn)}}function hn(a){return new nl((b,c)=>{a.onsuccess=a=>{const c=a.target.result;b(c)},a.onerror=a=>{const b=kn(a.target.error);c(b)}})}let jn=null;function kn(a){const b=Tl.Rt(getUA());if(b>=12.2&&b<13){const c="An internal error was encountered in the Indexed Database server";if(a.message.indexOf(c)>=0){const d=new z("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${c}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return jn||(jn=!0,setTimeout(()=>{throw d},0)),d}}return a}function ln(a,b){const c=x(a);return Tl.St(c.Qt,b)}class mn{constructor(nn,on,pn,qn){this.batchId=nn,this.localWriteTime=on,this.baseMutations=pn,this.mutations=qn}applyToRemoteDocument(rn,sn){const tn=sn.mutationResults;for(let un=0;un<this.mutations.length;un++){const vn=this.mutations[un];vn.key.isEqual(rn.key)&&vf(vn,rn,tn[un])}}applyToLocalView(wn){for(const xn of this.baseMutations)xn.key.isEqual(wn.key)&&wf(xn,wn,this.localWriteTime);for(const yn of this.mutations)yn.key.isEqual(wn.key)&&wf(yn,wn,this.localWriteTime)}applyToLocalDocumentSet(zn){this.mutations.forEach(a=>{const b=zn.get(a.key),c=b;this.applyToLocalView(c),b.isValidDocument()||c.convertToNoDocument(Ba.min())})}keys(){return this.mutations.reduce((a,b)=>a.add(b.key),Yh())}isEqual(An){return this.batchId===An.batchId&&ra(this.mutations,An.mutations,(a,b)=>yf(a,b))&&ra(this.baseMutations,An.baseMutations,(a,b)=>yf(a,b))}}class Bn{constructor(Cn,Dn,En,Fn){this.batch=Cn,this.commitVersion=Dn,this.mutationResults=En,this.docVersions=Fn}static from(Gn,Hn,In){w(Gn.mutations.length===In.length);let Jn=Wh();const Kn=Gn.mutations;for(let Ln=0;Ln<Kn.length;Ln++)Jn=Jn.insert(Kn[Ln].key,In[Ln].version);return new Bn(Gn,Hn,In,Jn)}}class Mn{constructor(Nn,On,Pn,Qn,Rn=Ba.min(),Sn=Ba.min(),Tn=Db.EMPTY_BYTE_STRING){this.target=Nn,this.targetId=On,this.purpose=Pn,this.sequenceNumber=Qn,this.snapshotVersion=Rn,this.lastLimboFreeSnapshotVersion=Sn,this.resumeToken=Tn}withSequenceNumber(Un){return new Mn(this.target,this.targetId,this.purpose,Un,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(Vn,Wn){return new Mn(this.target,this.targetId,this.purpose,this.sequenceNumber,Wn,this.lastLimboFreeSnapshotVersion,Vn)}withLastLimboFreeSnapshotVersion(Xn){return new Mn(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,Xn,this.resumeToken)}}function Yn(a,b){const c=(b.baseMutations||[]).map(b=>Qj(a.Wt,b));for(let d=0;d<b.mutations.length-1;++d){const e=b.mutations[d];if(d+1<b.mutations.length&& void 0!==b.mutations[d+1].transform){const f=b.mutations[d+1];e.updateTransforms=f.transform.fieldTransforms,b.mutations.splice(d+1,1),++d}}const g=b.mutations.map(b=>Qj(a.Wt,b)),h=sa.fromMillis(b.localWriteTimeMs);return new mn(b.batchId,h,c,g)}class Zn{constructor($n,_n,ao){this.cacheSizeCollectionThreshold=$n,this.percentileToCollect=_n,this.maximumSequenceNumbersToCollect=ao}static withCacheSize(bo){return new Zn(bo,Zn.DEFAULT_COLLECTION_PERCENTILE,Zn.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}Zn.DEFAULT_COLLECTION_PERCENTILE=10,Zn.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1000,Zn.DEFAULT=new Zn(41943040,Zn.DEFAULT_COLLECTION_PERCENTILE,Zn.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Zn.DISABLED=new Zn(-1,0,0);class co{constructor(eo,fo,go,ho){this.userId=eo,this.N=fo,this.Ht=go,this.referenceDelegate=ho,this.Jt={}}static Yt(io,jo,ko,lo){w(""!==io.uid);const mo=io.isAuthenticated()?io.uid:"";return new co(mo,jo,ko,lo)}checkEmpty(no){let oo=!0;const po=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return kp(no).Kt({index:kk.userMutationsIndex,range:po},(a,b,c)=>{oo=!1,c.done()}).next(()=>oo)}addMutationBatch(qo,ro,so,to){const uo=lp(qo),vo=kp(qo);return vo.add({}).next(a=>{w("number"==typeof a);const b=new mn(a,ro,so,to),c=function(a,b,c){const d=c.baseMutations.map(b=>Pj(a.Wt,b)),e=c.mutations.map(b=>Pj(a.Wt,b));return new kk(b,c.batchId,c.localWriteTime.toMillis(),d,e)}(this.N,this.userId,b),d=[];let e=new nh((a,b)=>qa(a.canonicalString(),b.canonicalString()));for(const f of to){const g=qk.key(this.userId,f.key.path,a);e=e.add(f.key.path.popLast()),d.push(vo.put(c)),d.push(uo.put(g,qk.PLACEHOLDER))}return e.forEach(a=>{d.push(this.Ht.addToCollectionParentIndex(qo,a))}),qo.addOnCommittedListener(()=>{this.Jt[a]=b.keys()}),nl.waitFor(d).next(()=>b)})}lookupMutationBatch(wo,xo){return kp(wo).get(xo).next(a=>a?(w(a.userId===this.userId),Yn(this.N,a)):null)}Xt(yo,zo){return this.Jt[zo]?nl.resolve(this.Jt[zo]):this.lookupMutationBatch(yo,zo).next(a=>{if(a){const b=a.keys();return this.Jt[zo]=b,b}return null})}getNextMutationBatchAfterBatchId(Ao,Bo){const Co=Bo+1,Do=IDBKeyRange.lowerBound([this.userId,Co]);let Eo=null;return kp(Ao).Kt({index:kk.userMutationsIndex,range:Do},(a,b,c)=>{b.userId===this.userId&&(w(b.batchId>=Co),Eo=Yn(this.N,b)),c.done()}).next(()=>Eo)}getHighestUnacknowledgedBatchId(Fo){const Go=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let Ho=-1;return kp(Fo).Kt({index:kk.userMutationsIndex,range:Go,reverse:!0},(a,b,c)=>{Ho=b.batchId,c.done()}).next(()=>Ho)}getAllMutationBatches(Io){const Jo=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return kp(Io).Lt(kk.userMutationsIndex,Jo).next(a=>a.map(a=>Yn(this.N,a)))}getAllMutationBatchesAffectingDocumentKey(Ko,Lo){const Mo=qk.prefixForPath(this.userId,Lo.path),No=IDBKeyRange.lowerBound(Mo),Oo=[];return lp(Ko).Kt({range:No},(a,b,c)=>{const[d,e,f]=a,g=bk(e);if(d===this.userId&&Lo.path.isEqual(g))return kp(Ko).get(f).next(a=>{if(!a)throw v();w(a.userId===this.userId),Oo.push(Yn(this.N,a))});c.done()}).next(()=>Oo)}getAllMutationBatchesAffectingDocumentKeys(Po,Qo){let Ro=new nh(qa);const So=[];return Qo.forEach(a=>{const b=qk.prefixForPath(this.userId,a.path),c=IDBKeyRange.lowerBound(b),d=lp(Po).Kt({range:c},(b,c,d)=>{const[e,f,g]=b,h=bk(f);e===this.userId&&a.path.isEqual(h)?Ro=Ro.add(g):d.done()});So.push(d)}),nl.waitFor(So).next(()=>this.Zt(Po,Ro))}getAllMutationBatchesAffectingQuery(To,Uo){const Vo=Uo.path,Wo=Vo.length+1,Xo=qk.prefixForPath(this.userId,Vo),Yo=IDBKeyRange.lowerBound(Xo);let Zo=new nh(qa);return lp(To).Kt({range:Yo},(a,b,c)=>{const[d,e,f]=a,g=bk(e);d===this.userId&&Vo.isPrefixOf(g)?g.length===Wo&&(Zo=Zo.add(f)):c.done()}).next(()=>this.Zt(To,Zo))}Zt($o,_o){const ap=[],bp=[];return _o.forEach(a=>{bp.push(kp($o).get(a).next(a=>{if(null===a)throw v();w(a.userId===this.userId),ap.push(Yn(this.N,a))}))}),nl.waitFor(bp).next(()=>ap)}removeMutationBatch(cp,dp){return(function(a,b,c){const d=a.store(kk.store),e=a.store(qk.store),f=[],g=IDBKeyRange.only(c.batchId);let h=0;const i=d.Kt({range:g},(a,b,c)=>(h++,c.delete()));f.push(i.next(()=>{w(1===h)}));const j=[];for(const k of c.mutations){const l=qk.key(b,k.key.path,c.batchId);f.push(e.delete(l)),j.push(k.key)}return nl.waitFor(f).next(()=>j)})(cp.Qt,this.userId,dp).next(a=>(cp.addOnCommittedListener(()=>{this.te(dp.batchId)}),nl.forEach(a,a=>this.referenceDelegate.markPotentiallyOrphaned(cp,a))))}te(ep){delete this.Jt[ep]}performConsistencyCheck(fp){return this.checkEmpty(fp).next(a=>{if(!a)return nl.resolve();const b=IDBKeyRange.lowerBound(qk.prefixForUser(this.userId)),c=[];return lp(fp).Kt({range:b},(a,b,d)=>{if(a[0]===this.userId){const e=bk(a[1]);c.push(e)}else d.done()}).next(()=>{w(0===c.length)})})}containsKey(gp,hp){return jp(gp,this.userId,hp)}ee(ip){return mp(ip).get(this.userId).next(a=>a||new gk(this.userId,-1,""))}}function jp(a,b,c){const d=qk.prefixForPath(b,c.path),e=d[1],f=IDBKeyRange.lowerBound(d);let g=!1;return lp(a).Kt({range:f,qt:!0},(a,c,d)=>{const[f,h,i]=a;f===b&&h===e&&(g=!0),d.done()}).next(()=>g)}function kp(a){return ln(a,kk.store)}function lp(a){return ln(a,qk.store)}function mp(a){return ln(a,gk.store)}class np{constructor(op){this.ne=op}next(){return this.ne+=2,this.ne}static se(){return new np(0)}static ie(){return new np(-1)}}async function pp(a){if(a.code!==y.FAILED_PRECONDITION||"The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab."!==a.message)throw a;r("LocalStore","Unexpectedly lost primary lease")}class qp{constructor(rp,sp){this.mapKeyFn=rp,this.equalsFn=sp,this.inner={}}get(tp){const up=this.mapKeyFn(tp),vp=this.inner[up];if(void 0!==vp){for(const[wp,xp]of vp)if(this.equalsFn(wp,tp))return xp}}has(yp){return void 0!==this.get(yp)}set(zp,Ap){const Bp=this.mapKeyFn(zp),Cp=this.inner[Bp];if(void 0!==Cp){for(let Dp=0;Dp<Cp.length;Dp++)if(this.equalsFn(Cp[Dp][0],zp))return void(Cp[Dp]=[zp,Ap]);Cp.push([zp,Ap])}else this.inner[Bp]=[[zp,Ap]]}delete(Ep){const Fp=this.mapKeyFn(Ep),Gp=this.inner[Fp];if(void 0===Gp)return!1;for(let Hp=0;Hp<Gp.length;Hp++)if(this.equalsFn(Gp[Hp][0],Ep))return 1===Gp.length?delete this.inner[Fp]:Gp.splice(Hp,1),!0;return!1}forEach(Ip){Ha(this.inner,(a,b)=>{for(const[c,d]of b)Ip(c,d)})}isEmpty(){return Ia(this.inner)}}class Jp{constructor(){this.changes=new qp(a=>a.toString(),(a,b)=>a.isEqual(b)),this.changesApplied=!1}getReadTime(Kp){const Lp=this.changes.get(Kp);return Lp?Lp.readTime:Ba.min()}addEntry(Mp,Np){this.assertNotApplied(),this.changes.set(Mp.key,{document:Mp,readTime:Np})}removeEntry(Op,Pp=null){this.assertNotApplied(),this.changes.set(Op,{document:Oc.newInvalidDocument(Op),readTime:Pp})}getEntry(Qp,Rp){this.assertNotApplied();const Sp=this.changes.get(Rp);return void 0!==Sp?nl.resolve(Sp.document):this.getFromCache(Qp,Rp)}getEntries(Tp,Up){return this.getAllFromCache(Tp,Up)}apply(Vp){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(Vp)}assertNotApplied(){}}class Wp{constructor(Xp,Yp,Zp){this.He=Xp,this.In=Yp,this.Ht=Zp}An($p,_p){return this.In.getAllMutationBatchesAffectingDocumentKey($p,_p).next(a=>this.Rn($p,_p,a))}Rn(aq,bq,cq){return this.He.getEntry(aq,bq).next(a=>{for(const b of cq)b.applyToLocalView(a);return a})}bn(dq,eq){dq.forEach((a,b)=>{for(const c of eq)c.applyToLocalView(b)})}Pn(fq,gq){return this.He.getEntries(fq,gq).next(a=>this.vn(fq,a).next(()=>a))}vn(hq,iq){return this.In.getAllMutationBatchesAffectingDocumentKeys(hq,iq).next(a=>this.bn(iq,a))}getDocumentsMatchingQuery(jq,kq,lq){var mq;return(mq=kq,Vb.isDocumentKey(mq.path)&&null===mq.collectionGroup&&0===mq.filters.length)?this.Vn(jq,kq.path):null!==kq.collectionGroup?this.Sn(jq,kq,lq):this.Dn(jq,kq,lq)}Vn(nq,oq){return this.An(nq,new Vb(oq)).next(a=>{let b=Uh();return a.isFoundDocument()&&(b=b.insert(a.key,a)),b})}Sn(pq,qq,rq){const sq=qq.collectionGroup;let tq=Uh();return this.Ht.getCollectionParents(pq,sq).next(a=>nl.forEach(a,a=>{var b,c;const d=(b=qq,c=a.child(sq),new we(c,null,b.explicitOrderBy.slice(),b.filters.slice(),b.limit,b.limitType,b.startAt,b.endAt));return this.Dn(pq,d,rq).next(a=>{a.forEach((a,b)=>{tq=tq.insert(a,b)})})}).next(()=>tq))}Dn(uq,vq,wq){let xq,yq;return this.He.getDocumentsMatchingQuery(uq,vq,wq).next(a=>(xq=a,this.In.getAllMutationBatchesAffectingQuery(uq,vq))).next(a=>(yq=a,this.Cn(uq,yq,xq).next(a=>{for(const b of(xq=a,yq))for(const c of b.mutations){const d=c.key;let e=xq.get(d);null==e&&(e=Oc.newInvalidDocument(d),xq=xq.insert(d,e)),wf(c,e,b.localWriteTime),e.isFoundDocument()||(xq=xq.remove(d))}}))).next(()=>(xq.forEach((a,b)=>{Ne(vq,b)||(xq=xq.remove(a))}),xq))}Cn(zq,Aq,Bq){let Cq=Yh();for(const Dq of Aq)for(const Eq of Dq.mutations)Eq instanceof Ff&&null===Bq.get(Eq.key)&&(Cq=Cq.add(Eq.key));let Fq=Bq;return this.He.getEntries(zq,Cq).next(a=>(a.forEach((a,b)=>{b.isFoundDocument()&&(Fq=Fq.insert(a,b))}),Fq))}}class Gq{constructor(Hq,Iq,Jq,Kq){this.targetId=Hq,this.fromCache=Iq,this.Nn=Jq,this.xn=Kq}static kn(Lq,Mq){let Nq=Yh(),Oq=Yh();for(const Pq of Mq.docChanges)switch(Pq.type){case 0:Nq=Nq.add(Pq.doc.key);break;case 1:Oq=Oq.add(Pq.doc.key)}return new Gq(Lq,Mq.fromCache,Nq,Oq)}}class Qq{$n(Rq){this.On=Rq}getDocumentsMatchingQuery(Sq,Tq,Uq,Vq){var Wq;return 0===(Wq=Tq).filters.length&&null===Wq.limit&&null==Wq.startAt&&null==Wq.endAt&&(0===Wq.explicitOrderBy.length||1===Wq.explicitOrderBy.length&&Wq.explicitOrderBy[0].field.isKeyField())||Uq.isEqual(Ba.min())?this.Fn(Sq,Tq):this.On.Pn(Sq,Vq).next(a=>{const b=this.Mn(Tq,a);return(Ge(Tq)||He(Tq))&&this.Ln(Tq.limitType,b,Vq,Uq)?this.Fn(Sq,Tq):(q()<=h.in.DEBUG&&r("QueryEngine","Re-using previous result from %s to execute query: %s",Uq.toString(),Me(Tq)),this.On.getDocumentsMatchingQuery(Sq,Tq,Uq).next(a=>(b.forEach(b=>{a=a.insert(b.key,b)}),a)))})}Mn(Xq,Yq){let Zq=new nh(Oe(Xq));return Yq.forEach((a,b)=>{Ne(Xq,b)&&(Zq=Zq.add(b))}),Zq}Ln($q,_q,ar,br){if(ar.size!==_q.size)return!0;const cr="F"===$q?_q.last():_q.first();return!!cr&&(cr.hasPendingWrites||cr.version.compareTo(br)>0)}Fn(dr,er){return q()<=h.in.DEBUG&&r("QueryEngine","Using full collection scan to execute query:",Me(er)),this.On.getDocumentsMatchingQuery(dr,er,Ba.min())}}class fr{constructor(gr,hr,ir,jr){this.persistence=gr,this.Bn=hr,this.N=jr,this.Un=new Xf(qa),this.qn=new qp(a=>od(a),pd),this.Kn=Ba.min(),this.In=gr.getMutationQueue(ir),this.jn=gr.getRemoteDocumentCache(),this.ze=gr.getTargetCache(),this.Qn=new Wp(this.jn,this.In,this.persistence.getIndexManager()),this.Je=gr.getBundleCache(),this.Bn.$n(this.Qn)}collectGarbage(kr){return this.persistence.runTransaction("Collect garbage","readwrite-primary",a=>kr.collect(a,this.Un))}}async function lr(a,b){const c=x(a);let d=c.In,e=c.Qn;const f=await c.persistence.runTransaction("Handle user change","readonly",a=>{let f;return c.In.getAllMutationBatches(a).next(g=>(f=g,d=c.persistence.getMutationQueue(b),e=new Wp(c.jn,d,c.persistence.getIndexManager()),d.getAllMutationBatches(a))).next(b=>{const c=[],d=[];let g=Yh();for(const h of f)for(const i of(c.push(h.batchId),h.mutations))g=g.add(i.key);for(const j of b)for(const k of(d.push(j.batchId),j.mutations))g=g.add(k.key);return e.Pn(a,g).next(a=>({Wn:a,removedBatchIds:c,addedBatchIds:d}))})});return c.In=d,c.Qn=e,c.Bn.$n(c.Qn),f}function mr(a){const b=x(a);return b.persistence.runTransaction("Get last remote snapshot version","readonly",a=>b.ze.getLastRemoteSnapshotVersion(a))}function nr(a,b){const c=x(a);return c.persistence.runTransaction("Get next mutation batch","readonly",a=>(void 0===b&&(b=-1),c.In.getNextMutationBatchAfterBatchId(a,b)))}async function or(a,b,c){const d=x(a),e=d.Un.get(b);try{c||await d.persistence.runTransaction("Release target",c?"readwrite":"readwrite-primary",a=>d.persistence.referenceDelegate.removeTarget(a,e))}catch(f){if(!Dm(f))throw f;r("LocalStore",`Failed to update sequence numbers for target ${b}: ${f}`)}d.Un=d.Un.remove(b),d.qn.delete(e.target)}function pr(a,b,c){const d=x(a);let e=Ba.min(),f=Yh();return d.persistence.runTransaction("Execute query","readonly",a=>(function(a,b,c){const d=x(a),e=d.qn.get(c);return void 0!==e?nl.resolve(d.Un.get(e)):d.ze.getTargetData(b,c)})(d,a,Je(b)).next(b=>{if(b)return e=b.lastLimboFreeSnapshotVersion,d.ze.getMatchingKeysForTargetId(a,b.targetId).next(a=>{f=a})}).next(()=>d.Bn.getDocumentsMatchingQuery(a,b,c?e:Ba.min(),c?f:Yh())).next(a=>({documents:a,Gn:f})))}class qr{constructor(){this.Zn=new nh(Or.ts),this.es=new nh(Or.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(rr,sr){const tr=new Or(rr,sr);this.Zn=this.Zn.add(tr),this.es=this.es.add(tr)}ss(ur,vr){ur.forEach(a=>this.addReference(a,vr))}removeReference(wr,xr){this.rs(new Or(wr,xr))}os(yr,zr){yr.forEach(a=>this.removeReference(a,zr))}cs(Ar){const Br=new Vb(new db([])),Cr=new Or(Br,Ar),Dr=new Or(Br,Ar+1),Er=[];return this.es.forEachInRange([Cr,Dr],a=>{this.rs(a),Er.push(a.key)}),Er}us(){this.Zn.forEach(a=>this.rs(a))}rs(Fr){this.Zn=this.Zn.delete(Fr),this.es=this.es.delete(Fr)}hs(Gr){const Hr=new Vb(new db([])),Ir=new Or(Hr,Gr),Jr=new Or(Hr,Gr+1);let Kr=Yh();return this.es.forEachInRange([Ir,Jr],a=>{Kr=Kr.add(a.key)}),Kr}containsKey(Lr){const Mr=new Or(Lr,0),Nr=this.Zn.firstAfterOrEqual(Mr);return null!==Nr&&Lr.isEqual(Nr.key)}}class Or{constructor(Pr,Qr){this.key=Pr,this.ls=Qr}static ts(Rr,Sr){return Vb.comparator(Rr.key,Sr.key)||qa(Rr.ls,Sr.ls)}static ns(Tr,Ur){return qa(Tr.ls,Ur.ls)||Vb.comparator(Tr.key,Ur.key)}}class Vr{constructor(Wr,Xr){this.Ht=Wr,this.referenceDelegate=Xr,this.In=[],this.fs=1,this.ds=new nh(Or.ts)}checkEmpty(Yr){return nl.resolve(0===this.In.length)}addMutationBatch(Zr,$r,_r,as){const bs=this.fs;this.fs++,this.In.length>0&&this.In[this.In.length-1];const cs=new mn(bs,$r,_r,as);for(const ds of(this.In.push(cs),as))this.ds=this.ds.add(new Or(ds.key,bs)),this.Ht.addToCollectionParentIndex(Zr,ds.key.path.popLast());return nl.resolve(cs)}lookupMutationBatch(es,fs){return nl.resolve(this.ws(fs))}getNextMutationBatchAfterBatchId(gs,hs){const is=this._s(hs+1),js=is<0?0:is;return nl.resolve(this.In.length>js?this.In[js]:null)}getHighestUnacknowledgedBatchId(){return nl.resolve(0===this.In.length?-1:this.fs-1)}getAllMutationBatches(ks){return nl.resolve(this.In.slice())}getAllMutationBatchesAffectingDocumentKey(ls,ms){const ns=new Or(ms,0),os=new Or(ms,Number.POSITIVE_INFINITY),ps=[];return this.ds.forEachInRange([ns,os],a=>{const b=this.ws(a.ls);ps.push(b)}),nl.resolve(ps)}getAllMutationBatchesAffectingDocumentKeys(qs,rs){let ss=new nh(qa);return rs.forEach(a=>{const b=new Or(a,0),c=new Or(a,Number.POSITIVE_INFINITY);this.ds.forEachInRange([b,c],a=>{ss=ss.add(a.ls)})}),nl.resolve(this.gs(ss))}getAllMutationBatchesAffectingQuery(ts,us){const vs=us.path,ws=vs.length+1;let xs=vs;Vb.isDocumentKey(xs)||(xs=xs.child(""));const ys=new Or(new Vb(xs),0);let zs=new nh(qa);return this.ds.forEachWhile(a=>{const b=a.key.path;return!!vs.isPrefixOf(b)&&(b.length===ws&&(zs=zs.add(a.ls)),!0)},ys),nl.resolve(this.gs(zs))}gs(As){const Bs=[];return As.forEach(a=>{const b=this.ws(a);null!==b&&Bs.push(b)}),Bs}removeMutationBatch(Cs,Ds){w(0===this.ys(Ds.batchId,"removed")),this.In.shift();let Es=this.ds;return nl.forEach(Ds.mutations,a=>{const b=new Or(a.key,Ds.batchId);return Es=Es.delete(b),this.referenceDelegate.markPotentiallyOrphaned(Cs,a.key)}).next(()=>{this.ds=Es})}te(Fs){}containsKey(Gs,Hs){const Is=new Or(Hs,0),Js=this.ds.firstAfterOrEqual(Is);return nl.resolve(Hs.isEqual(Js&&Js.key))}performConsistencyCheck(Ks){return this.In.length,nl.resolve()}ys(Ls,Ms){return this._s(Ls)}_s(Ns){return 0===this.In.length?0:Ns-this.In[0].batchId}ws(Os){const Ps=this._s(Os);return Ps<0||Ps>=this.In.length?null:this.In[Ps]}}class Qs{constructor(Rs,Ss){this.Ht=Rs,this.ps=Ss,this.docs=new Xf(Vb.comparator),this.size=0}addEntry(Ts,Us,Vs){const Ws=Us.key,Xs=this.docs.get(Ws),Ys=Xs?Xs.size:0,Zs=this.ps(Us);return this.docs=this.docs.insert(Ws,{document:Us.clone(),size:Zs,readTime:Vs}),this.size+=Zs-Ys,this.Ht.addToCollectionParentIndex(Ts,Ws.path.popLast())}removeEntry($s){const _s=this.docs.get($s);_s&&(this.docs=this.docs.remove($s),this.size-=_s.size)}getEntry(at,bt){const ct=this.docs.get(bt);return nl.resolve(ct?ct.document.clone():Oc.newInvalidDocument(bt))}getEntries(dt,et){let ft=Sh();return et.forEach(a=>{const b=this.docs.get(a);ft=ft.insert(a,b?b.document.clone():Oc.newInvalidDocument(a))}),nl.resolve(ft)}getDocumentsMatchingQuery(gt,ht,it){let jt=Sh();const kt=new Vb(ht.path.child("")),lt=this.docs.getIteratorFrom(kt);for(;lt.hasNext();){const{key:mt,value:{document:nt,readTime:ot}}=lt.getNext();if(!ht.path.isPrefixOf(mt.path))break;0>=ot.compareTo(it)||Ne(ht,nt)&&(jt=jt.insert(nt.key,nt.clone()))}return nl.resolve(jt)}Ts(pt,qt){return nl.forEach(this.docs,a=>qt(a))}newChangeBuffer(rt){return new tt(this)}getSize(st){return nl.resolve(this.size)}}class tt extends Jp{constructor(ut){super(),this.Se=ut}applyChanges(vt){const wt=[];return this.changes.forEach((a,b)=>{b.document.isValidDocument()?wt.push(this.Se.addEntry(vt,b.document,this.getReadTime(a))):this.Se.removeEntry(a)}),nl.waitFor(wt)}getFromCache(xt,yt){return this.Se.getEntry(xt,yt)}getAllFromCache(zt,At){return this.Se.getEntries(zt,At)}}class Bt{constructor(Ct,Dt){this.bs={},this.Le=new fa(0),this.Be=!1,this.Be=!0,this.referenceDelegate=Ct(this),this.ze=new class{constructor(Et){this.persistence=Et,this.Es=new qp(a=>od(a),pd),this.lastRemoteSnapshotVersion=Ba.min(),this.highestTargetId=0,this.Is=0,this.As=new qr,this.targetCount=0,this.Rs=np.se()}forEachTarget(Ft,Gt){return this.Es.forEach((a,b)=>Gt(b)),nl.resolve()}getLastRemoteSnapshotVersion(Ht){return nl.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(It){return nl.resolve(this.Is)}allocateTargetId(Jt){return this.highestTargetId=this.Rs.next(),nl.resolve(this.highestTargetId)}setTargetsMetadata(Kt,Lt,Mt){return Mt&&(this.lastRemoteSnapshotVersion=Mt),Lt>this.Is&&(this.Is=Lt),nl.resolve()}ce(Nt){this.Es.set(Nt.target,Nt);const Ot=Nt.targetId;Ot>this.highestTargetId&&(this.Rs=new np(Ot),this.highestTargetId=Ot),Nt.sequenceNumber>this.Is&&(this.Is=Nt.sequenceNumber)}addTargetData(Pt,Qt){return this.ce(Qt),this.targetCount+=1,nl.resolve()}updateTargetData(Rt,St){return this.ce(St),nl.resolve()}removeTargetData(Tt,Ut){return this.Es.delete(Ut.target),this.As.cs(Ut.targetId),this.targetCount-=1,nl.resolve()}removeTargets(Vt,Wt,Xt){let Yt=0;const Zt=[];return this.Es.forEach((a,b)=>{b.sequenceNumber<=Wt&&null===Xt.get(b.targetId)&&(this.Es.delete(a),Zt.push(this.removeMatchingKeysForTargetId(Vt,b.targetId)),Yt++)}),nl.waitFor(Zt).next(()=>Yt)}getTargetCount($t){return nl.resolve(this.targetCount)}getTargetData(_t,au){const bu=this.Es.get(au)||null;return nl.resolve(bu)}addMatchingKeys(cu,du,eu){return this.As.ss(du,eu),nl.resolve()}removeMatchingKeys(fu,gu,hu){this.As.os(gu,hu);const iu=this.persistence.referenceDelegate,ju=[];return iu&&gu.forEach(a=>{ju.push(iu.markPotentiallyOrphaned(fu,a))}),nl.waitFor(ju)}removeMatchingKeysForTargetId(ku,lu){return this.As.cs(lu),nl.resolve()}getMatchingKeysForTargetId(mu,nu){const ou=this.As.hs(nu);return nl.resolve(ou)}containsKey(pu,qu){return nl.resolve(this.As.containsKey(qu))}}(this),this.Ht=new class{constructor(){this.Gt=new class{constructor(){this.index={}}add(ru){const su=ru.lastSegment(),tu=ru.popLast(),uu=this.index[su]||new nh(db.comparator),vu=!uu.has(tu);return this.index[su]=uu.add(tu),vu}has(wu){const xu=wu.lastSegment(),yu=wu.popLast(),zu=this.index[xu];return zu&&zu.has(yu)}getEntries(Au){return(this.index[Au]||new nh(db.comparator)).toArray()}}}addToCollectionParentIndex(Bu,Cu){return this.Gt.add(Cu),nl.resolve()}getCollectionParents(Du,Eu){return nl.resolve(this.Gt.getEntries(Eu))}},this.He=(function(a,b){return new Qs(a,b)})(this.Ht,a=>this.referenceDelegate.Ps(a)),this.N=new class{constructor(Fu){this.Wt=Fu}}(Dt),this.Je=new class{constructor(Gu){this.N=Gu,this.Yn=new Map,this.Xn=new Map}getBundleMetadata(Hu,Iu){return nl.resolve(this.Yn.get(Iu))}saveBundleMetadata(Ju,Ku){var Lu;return this.Yn.set(Ku.id,{id:(Lu=Ku).id,version:Lu.version,createTime:Gj(Lu.createTime)}),nl.resolve()}getNamedQuery(Mu,Nu){return nl.resolve(this.Xn.get(Nu))}saveNamedQuery(Ou,Pu){var Qu;return this.Xn.set(Pu.name,{name:(Qu=Pu).name,query:function(a){var b,c;const d=function(a){var b,c,d,e,f,g,h,i;let j=function(a){const b=Ij(a);return 4===b.length?db.emptyPath():Nj(b)}(a.parent);const k=a.structuredQuery,l=k.from?k.from.length:0;let m=null;if(l>0){w(1===l);const n=k.from[0];n.allDescendants?m=n.collectionId:j=j.child(n.collectionId)}let o=[];k.where&&(o=Rj(k.where));let p=[];k.orderBy&&(p=k.orderBy.map(a=>{var b;return b=a,new qe(Vj(b.field),function(a){switch(a){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(b.direction))}));let q=null,r;k.limit&&(q=Sb(r="object"==typeof(b=k.limit)?b.value:b)?null:r);let s=null;k.startAt&&(s=Tj(k.startAt));let t=null;return k.endAt&&(t=Tj(k.endAt)),c=j,d=m,e=p,f=o,g=q,h=s,i=t,new we(c,d,e,f,g,"F",h,i)}({parent:a.parent,structuredQuery:a.structuredQuery});return"LAST"===a.limitType?(b=d,c=d.limit,new we(b.path,b.collectionGroup,b.explicitOrderBy.slice(),b.filters.slice(),c,"L",b.startAt,b.endAt)):d}(Qu.bundledQuery),readTime:Gj(Qu.readTime)}),nl.resolve()}}(this.N)}start(){return Promise.resolve()}shutdown(){return this.Be=!1,Promise.resolve()}get started(){return this.Be}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Ht}getMutationQueue(Ru){let Su=this.bs[Ru.toKey()];return Su||(Su=new Vr(this.Ht,this.referenceDelegate),this.bs[Ru.toKey()]=Su),Su}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getBundleCache(){return this.Je}runTransaction(Tu,Uu,Vu){r("MemoryPersistence","Starting transaction:",Tu);const Wu=new Zu(this.Le.next());return this.referenceDelegate.vs(),Vu(Wu).next(a=>this.referenceDelegate.Vs(Wu).next(()=>a)).toPromise().then(a=>(Wu.raiseOnCommittedEvent(),a))}Ss(Xu,Yu){return nl.or(Object.values(this.bs).map(a=>()=>a.containsKey(Xu,Yu)))}}class Zu extends ll{constructor($u){super(),this.currentSequenceNumber=$u}}class _u{constructor(av){this.persistence=av,this.Ds=new qr,this.Cs=null}static Ns(bv){return new _u(bv)}get xs(){if(this.Cs)return this.Cs;throw v()}addReference(cv,dv,ev){return this.Ds.addReference(ev,dv),this.xs.delete(ev.toString()),nl.resolve()}removeReference(fv,gv,hv){return this.Ds.removeReference(hv,gv),this.xs.add(hv.toString()),nl.resolve()}markPotentiallyOrphaned(iv,jv){return this.xs.add(jv.toString()),nl.resolve()}removeTarget(kv,lv){this.Ds.cs(lv.targetId).forEach(a=>this.xs.add(a.toString()));const mv=this.persistence.getTargetCache();return mv.getMatchingKeysForTargetId(kv,lv.targetId).next(a=>{a.forEach(a=>this.xs.add(a.toString()))}).next(()=>mv.removeTargetData(kv,lv))}vs(){this.Cs=new Set}Vs(nv){const ov=this.persistence.getRemoteDocumentCache().newChangeBuffer();return nl.forEach(this.xs,a=>{const b=Vb.fromPath(a);return this.ks(nv,b).next(a=>{a||ov.removeEntry(b)})}).next(()=>(this.Cs=null,ov.apply(nv)))}updateLimboDocument(pv,qv){return this.ks(pv,qv).next(a=>{a?this.xs.delete(qv.toString()):this.xs.add(qv.toString())})}Ps(rv){return 0}ks(sv,tv){return nl.or([()=>nl.resolve(this.Ds.containsKey(tv)),()=>this.persistence.getTargetCache().containsKey(sv,tv),()=>this.persistence.Ss(sv,tv)])}}class uv{constructor(vv,wv,xv,yv){this.user=vv,this.batchId=wv,this.state=xv,this.error=yv}static $s(zv,Av,Bv){const Cv=JSON.parse(Bv);let Dv,Ev="object"==typeof Cv&& -1!==["pending","acknowledged","rejected"].indexOf(Cv.state)&&(void 0===Cv.error||"object"==typeof Cv.error);return Ev&&Cv.error&&(Ev="string"==typeof Cv.error.message&&"string"==typeof Cv.error.code)&&(Dv=new z(Cv.error.code,Cv.error.message)),Ev?new uv(zv,Av,Cv.state,Dv):(s("SharedClientState",`Failed to parse mutation state for ID '${Av}': ${Bv}`),null)}Os(){const Fv={state:this.state,updateTimeMs:Date.now()};return this.error&&(Fv.error={code:this.error.code,message:this.error.message}),JSON.stringify(Fv)}}class Gv{constructor(Hv,Iv,Jv){this.targetId=Hv,this.state=Iv,this.error=Jv}static $s(Kv,Lv){const Mv=JSON.parse(Lv);let Nv,Ov="object"==typeof Mv&& -1!==["not-current","current","rejected"].indexOf(Mv.state)&&(void 0===Mv.error||"object"==typeof Mv.error);return Ov&&Mv.error&&(Ov="string"==typeof Mv.error.message&&"string"==typeof Mv.error.code)&&(Nv=new z(Mv.error.code,Mv.error.message)),Ov?new Gv(Kv,Mv.state,Nv):(s("SharedClientState",`Failed to parse target state for ID '${Kv}': ${Lv}`),null)}Os(){const Pv={state:this.state,updateTimeMs:Date.now()};return this.error&&(Pv.error={code:this.error.code,message:this.error.message}),JSON.stringify(Pv)}}class Qv{constructor(Rv,Sv){this.clientId=Rv,this.activeTargetIds=Sv}static $s(Tv,Uv){const Vv=JSON.parse(Uv);let Wv="object"==typeof Vv&&Vv.activeTargetIds instanceof Array,Xv=$h();for(let Yv=0;Wv&&Yv<Vv.activeTargetIds.length;++Yv)Wv=Ub(Vv.activeTargetIds[Yv]),Xv=Xv.add(Vv.activeTargetIds[Yv]);return Wv?new Qv(Tv,Xv):(s("SharedClientState",`Failed to parse client data for instance '${Tv}': ${Uv}`),null)}}class Zv{constructor($v,_v){this.clientId=$v,this.onlineState=_v}static $s(aw){const bw=JSON.parse(aw);return"object"==typeof bw&& -1!==["Unknown","Online","Offline"].indexOf(bw.onlineState)&&"string"==typeof bw.clientId?new Zv(bw.clientId,bw.onlineState):(s("SharedClientState",`Failed to parse online state: ${aw}`),null)}}class cw{constructor(){this.activeTargetIds=$h()}Fs(dw){this.activeTargetIds=this.activeTargetIds.add(dw)}Ms(ew){this.activeTargetIds=this.activeTargetIds.delete(ew)}Os(){const fw={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(fw)}}class gw{constructor(){this.yi=new cw,this.pi={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(hw){}updateMutationState(iw,jw,kw){}addLocalQueryTarget(lw){return this.yi.Fs(lw),this.pi[lw]||"not-current"}updateQueryState(mw,nw,ow){this.pi[mw]=nw}removeLocalQueryTarget(pw){this.yi.Ms(pw)}isLocalQueryTarget(qw){return this.yi.activeTargetIds.has(qw)}clearQueryState(rw){delete this.pi[rw]}getAllActiveQueryTargets(){return this.yi.activeTargetIds}isActiveQueryTarget(sw){return this.yi.activeTargetIds.has(sw)}start(){return this.yi=new cw,Promise.resolve()}handleUserChange(tw,uw,vw){}setOnlineState(ww){}shutdown(){}writeSequenceNumber(xw){}notifyBundleLoaded(){}}class yw{Ti(zw){}shutdown(){}}class Aw{constructor(){this.Ei=()=>this.Ii(),this.Ai=()=>this.Ri(),this.bi=[],this.Pi()}Ti(Bw){this.bi.push(Bw)}shutdown(){window.removeEventListener("online",this.Ei),window.removeEventListener("offline",this.Ai)}Pi(){window.addEventListener("online",this.Ei),window.addEventListener("offline",this.Ai)}Ii(){for(const Cw of(r("ConnectivityMonitor","Network connectivity changed: AVAILABLE"),this.bi))Cw(0)}Ri(){for(const Dw of(r("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE"),this.bi))Dw(1)}static bt(){return"undefined"!=typeof window&& void 0!==window.addEventListener&& void 0!==window.removeEventListener}}const Ew={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Fw{constructor(Gw){this.vi=Gw.vi,this.Vi=Gw.Vi}Si(Hw){this.Di=Hw}Ci(Iw){this.Ni=Iw}onMessage(Jw){this.xi=Jw}close(){this.Vi()}send(Kw){this.vi(Kw)}ki(){this.Di()}$i(Lw){this.Ni(Lw)}Oi(Mw){this.xi(Mw)}}class Nw extends class{constructor(dx){this.databaseInfo=dx,this.databaseId=dx.databaseId;const ex=dx.ssl?"https":"http";this.Fi=ex+"://"+dx.host,this.Mi="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Li(fx,gx,hx,ix){const jx=this.Bi(fx,gx);r("RestConnection","Sending: ",jx,hx);const kx={};return this.Ui(kx,ix),this.qi(fx,jx,kx,hx).then(a=>(r("RestConnection","Received: ",a),a),a=>{throw t("RestConnection",`${fx} failed with error: `,a,"url: ",jx,"request:",hx),a})}Ki(lx,mx,nx,ox){return this.Li(lx,mx,nx,ox)}Ui(px,qx){if(px["X-Goog-Api-Client"]="gl-js/ fire/"+o,px["Content-Type"]="text/plain",this.databaseInfo.appId&&(px["X-Firebase-GMPID"]=this.databaseInfo.appId),qx)for(const rx in qx.authHeaders)qx.authHeaders.hasOwnProperty(rx)&&(px[rx]=qx.authHeaders[rx])}Bi(sx,tx){const ux=Ew[sx];return`${this.Fi}/v1/${tx}:${ux}`}}{constructor(Ow){super(Ow),this.forceLongPolling=Ow.forceLongPolling,this.autoDetectLongPolling=Ow.autoDetectLongPolling,this.useFetchStreams=Ow.useFetchStreams}qi(Pw,Qw,Rw,Sw){return new Promise((a,b)=>{const c=new j.JJ;c.listenOnce(j.tw.COMPLETE,()=>{try{switch(c.getLastErrorCode()){case j.jK.NO_ERROR:const d=c.getResponseJson();r("Connection","XHR received:",JSON.stringify(d)),a(d);break;case j.jK.TIMEOUT:r("Connection","RPC \""+Pw+"\" timed out"),b(new z(y.DEADLINE_EXCEEDED,"Request time out"));break;case j.jK.HTTP_ERROR:const e=c.getStatus();if(r("Connection","RPC \""+Pw+"\" failed with status:",e,"response text:",c.getResponseText()),e>0){const f=c.getResponseJson().error;if(f&&f.status&&f.message){const g=function(a){const b=a.toLowerCase().replace(/_/g,"-");return Object.values(y).indexOf(b)>=0?b:y.UNKNOWN}(f.status);b(new z(g,f.message))}else b(new z(y.UNKNOWN,"Server responded with status "+c.getStatus()))}else b(new z(y.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{r("Connection","RPC \""+Pw+"\" completed.")}});const d=JSON.stringify(Sw);c.send(Qw,"POST",d,Rw,15)})}ji(Tw,Uw){const Vw=[this.Fi,"/","google.firestore.v1.Firestore","/",Tw,"/channel"],Ww=(0,j.UE)(),Xw=(0,j.FJ)(),Yw={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:60e4},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(Yw.xmlHttpFactory=new j.zI({})),this.Ui(Yw.initMessageHeaders,Uw),(0,i.uI)()||(0,i.b$)()||(0,i.d)()||(0,i.w1)()||(0,i.Mn)()||(0,i.ru)()||(Yw.httpHeadersOverwriteParam="$httpHeaders");const Zw=Vw.join("");r("Connection","Creating WebChannel: "+Zw,Yw);const $w=Ww.createWebChannel(Zw,Yw);let _w=!1,ax=!1;const bx=new Fw({vi:a=>{ax?r("Connection","Not sending because WebChannel is closed:",a):(_w||(r("Connection","Opening WebChannel transport."),$w.open(),_w=!0),r("Connection","WebChannel sending:",a),$w.send(a))},Vi:()=>$w.close()}),cx=(a,b,c)=>{a.listen(b,a=>{try{c(a)}catch(b){setTimeout(()=>{throw b},0)}})};return cx($w,j.ii.EventType.OPEN,()=>{ax||r("Connection","WebChannel transport opened.")}),cx($w,j.ii.EventType.CLOSE,()=>{ax||(ax=!0,r("Connection","WebChannel transport closed"),bx.$i())}),cx($w,j.ii.EventType.ERROR,a=>{ax||(ax=!0,t("Connection","WebChannel transport errored:",a),bx.$i(new z(y.UNAVAILABLE,"The operation could not be completed")))}),cx($w,j.ii.EventType.MESSAGE,a=>{var b;if(!ax){const c=a.data[0];w(!!c);const e=c,f=e.error||(null===(b=e[0])|| void 0===b?void 0:b.error);if(f){r("Connection","WebChannel received error:",f);const g=f.status;let h=function(a){const b=d[a];if(void 0!==b)return Wf(b)}(g),i=f.message;void 0===h&&(h=y.INTERNAL,i="Unknown error status: "+g+" with message "+f.message),ax=!0,bx.$i(new z(h,i)),$w.close()}else r("Connection","WebChannel received:",c),bx.Oi(c)}}),cx(Xw,j.ju.STAT_EVENT,a=>{a.stat===j.kN.PROXY?r("Connection","Detected buffering proxy"):a.stat===j.kN.NOPROXY&&r("Connection","Detected no buffering proxy")}),setTimeout(()=>{bx.ki()},0),bx}}function vx(){return"undefined"!=typeof document?document:null}function wx(a){return new Bj(a,!0)}class xx{constructor(yx,zx,Ax=1000,Bx=1.5,Cx=60e3){this.Oe=yx,this.timerId=zx,this.Qi=Ax,this.Wi=Bx,this.Gi=Cx,this.zi=0,this.Hi=null,this.Ji=Date.now(),this.reset()}reset(){this.zi=0}Yi(){this.zi=this.Gi}Xi(Dx){this.cancel();const Ex=Math.floor(this.zi+this.Zi()),Fx=Math.max(0,Date.now()-this.Ji),Gx=Math.max(0,Ex-Fx);Gx>0&&r("ExponentialBackoff",`Backing off for ${Gx} ms (base delay: ${this.zi} ms, delay with jitter: ${Ex} ms, last attempt: ${Fx} ms ago)`),this.Hi=this.Oe.enqueueAfterDelay(this.timerId,Gx,()=>(this.Ji=Date.now(),Dx())),this.zi*=this.Wi,this.zi<this.Qi&&(this.zi=this.Qi),this.zi>this.Gi&&(this.zi=this.Gi)}tr(){null!==this.Hi&&(this.Hi.skipDelay(),this.Hi=null)}cancel(){null!==this.Hi&&(this.Hi.cancel(),this.Hi=null)}Zi(){return(Math.random()-0.5)*this.zi}}class Hx{constructor(Ix,Jx,Kx,Lx,Mx,Nx,Ox){this.Oe=Ix,this.er=Kx,this.nr=Lx,this.sr=Mx,this.credentialsProvider=Nx,this.listener=Ox,this.state=0,this.ir=0,this.rr=null,this.cr=null,this.stream=null,this.ar=new xx(Ix,Jx)}ur(){return 1===this.state||5===this.state||this.hr()}hr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.lr()}async stop(){this.ur()&&await this.close(0)}dr(){this.state=0,this.ar.reset()}wr(){this.hr()&&null===this.rr&&(this.rr=this.Oe.enqueueAfterDelay(this.er,60e3,()=>this._r()))}mr(Px){this.gr(),this.stream.send(Px)}async _r(){if(this.hr())return this.close(0)}gr(){this.rr&&(this.rr.cancel(),this.rr=null)}yr(){this.cr&&(this.cr.cancel(),this.cr=null)}async close(Qx,Rx){this.gr(),this.yr(),this.ar.cancel(),this.ir++,4!==Qx?this.ar.reset():Rx&&Rx.code===y.RESOURCE_EXHAUSTED?(s(Rx.toString()),s("Using maximum backoff delay to prevent overloading the backend."),this.ar.Yi()):Rx&&Rx.code===y.UNAUTHENTICATED&&3!==this.state&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.pr(),this.stream.close(),this.stream=null),this.state=Qx,await this.listener.Ci(Rx)}pr(){}auth(){this.state=1;const Sx=this.Tr(this.ir),Tx=this.ir;this.credentialsProvider.getToken().then(a=>{this.ir===Tx&&this.Er(a)},a=>{Sx(()=>{const b=new z(y.UNKNOWN,"Fetching auth token failed: "+a.message);return this.Ir(b)})})}Er(Ux){const Vx=this.Tr(this.ir);this.stream=this.Ar(Ux),this.stream.Si(()=>{Vx(()=>(this.state=2,this.cr=this.Oe.enqueueAfterDelay(this.nr,10e3,()=>(this.hr()&&(this.state=3),Promise.resolve())),this.listener.Si()))}),this.stream.Ci(a=>{Vx(()=>this.Ir(a))}),this.stream.onMessage(a=>{Vx(()=>this.onMessage(a))})}lr(){this.state=5,this.ar.Xi(async()=>{this.state=0,this.start()})}Ir(Wx){return r("PersistentStream",`close with error: ${Wx}`),this.stream=null,this.close(4,Wx)}Tr(Xx){return a=>{this.Oe.enqueueAndForget(()=>this.ir===Xx?a():(r("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Yx extends Hx{constructor(Zx,$x,_x,ay,by){super(Zx,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",$x,_x,by),this.N=ay}Ar(cy){return this.sr.ji("Listen",cy)}onMessage(dy){this.ar.reset();const ey=function(a,b){let c;if("targetChange"in b){var d,e,f;b.targetChange;const g="NO_CHANGE"===(d=b.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===d?1:"REMOVE"===d?2:"CURRENT"===d?3:"RESET"===d?4:v(),h=b.targetChange.targetIds||[],i=(e=a,f=b.targetChange.resumeToken,e.D?(w(void 0===f||"string"==typeof f),Db.fromBase64String(f||"")):(w(void 0===f||f instanceof Uint8Array),Db.fromUint8Array(f||new Uint8Array))),j=b.targetChange.cause,k=j&&function(a){const b=void 0===a.code?y.UNKNOWN:Wf(a.code);return new z(b,a.message||"")}(j);c=new yi(g,h,i,k||null)}else if("documentChange"in b){b.documentChange;const l=b.documentChange;l.document,l.document.name,l.document.updateTime;const m=Kj(a,l.document.name),n=Gj(l.document.updateTime),o=new qc({mapValue:{fields:l.document.fields}}),p=Oc.newFoundDocument(m,n,o),q=l.targetIds||[],r=l.removedTargetIds||[];c=new qi(q,r,p.key,p)}else if("documentDelete"in b){b.documentDelete;const s=b.documentDelete;s.document;const t=Kj(a,s.document),u=s.readTime?Gj(s.readTime):Ba.min(),x=Oc.newNoDocument(t,u),A=s.removedTargetIds||[];c=new qi([],A,x.key,x)}else if("documentRemove"in b){b.documentRemove;const B=b.documentRemove;B.document;const C=Kj(a,B.document),D=B.removedTargetIds||[];c=new qi([],D,C,null)}else{if(!("filter"in b))return v();{b.filter;const E=b.filter;E.targetId;const F=E.count||0,G=new Uf(F),H=E.targetId;c=new vi(H,G)}}return c}(this.N,dy),fy=function(a){if(!("targetChange"in a))return Ba.min();const b=a.targetChange;return b.targetIds&&b.targetIds.length?Ba.min():b.readTime?Gj(b.readTime):Ba.min()}(dy);return this.listener.Rr(ey,fy)}br(gy){const hy={};hy.database=Mj(this.N),hy.addTarget=(function(a,b){let c;const d=b.target;return(c=qd(d)?{documents:{documents:[Lj(a,d.path)]}}:{query:(function(a,b){var c,d;const e={structuredQuery:{}},f=b.path;null!==b.collectionGroup?(e.parent=Lj(a,f),e.structuredQuery.from=[{collectionId:b.collectionGroup,allDescendants:!0}]):(e.parent=Lj(a,f.popLast()),e.structuredQuery.from=[{collectionId:f.lastSegment()}]);const g=function(a){if(0!==a.length){const b=a.map(a=>(function(a){if("=="===a.op){if(nc(a.value))return{unaryFilter:{field:Uj(a.field),op:"IS_NAN"}};if(mc(a.value))return{unaryFilter:{field:Uj(a.field),op:"IS_NULL"}}}else if("!="===a.op){if(nc(a.value))return{unaryFilter:{field:Uj(a.field),op:"IS_NOT_NAN"}};if(mc(a.value))return{unaryFilter:{field:Uj(a.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Uj(a.field),op:Aj[a.op],value:a.value}}})(a));return 1===b.length?b[0]:{compositeFilter:{op:"AND",filters:b}}}}(b.filters);g&&(e.structuredQuery.where=g);const h=function(a){if(0!==a.length)return a.map(a=>{var b;return{field:Uj((b=a).field),direction:zj[b.dir]}})}(b.orderBy);h&&(e.structuredQuery.orderBy=h);const i=(c=a,d=b.limit,c.D||Sb(d)?d:{value:d});return null!==i&&(e.structuredQuery.limit=i),b.startAt&&(e.structuredQuery.startAt=Sj(b.startAt)),b.endAt&&(e.structuredQuery.endAt=Sj(b.endAt)),e})(a,d)}).targetId=b.targetId,b.resumeToken.approximateByteSize()>0?c.resumeToken=Fj(a,b.resumeToken):b.snapshotVersion.compareTo(Ba.min())>0&&(c.readTime=Ej(a,b.snapshotVersion.toTimestamp())),c})(this.N,gy);const iy=function(a,b){const c=function(a,b){switch(b){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return v()}}(0,b.purpose);return null==c?null:{"goog-listen-tags":c}}(this.N,gy);iy&&(hy.labels=iy),this.mr(hy)}Pr(jy){const ky={};ky.database=Mj(this.N),ky.removeTarget=jy,this.mr(ky)}}class ly extends Hx{constructor(my,ny,oy,py,qy){super(my,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",ny,oy,qy),this.N=py,this.vr=!1}get Vr(){return this.vr}start(){this.vr=!1,this.lastStreamToken=void 0,super.start()}pr(){this.vr&&this.Sr([])}Ar(ry){return this.sr.ji("Write",ry)}onMessage(sy){if(w(!!sy.streamToken),this.lastStreamToken=sy.streamToken,this.vr){var ty,uy;this.ar.reset();const vy=(ty=sy.writeResults,uy=sy.commitTime,ty&&ty.length>0?(w(void 0!==uy),ty.map(a=>{var b,c;let d;return b=a,c=uy,(d=b.updateTime?Gj(b.updateTime):Gj(c)).isEqual(Ba.min())&&(d=Gj(c)),new kf(d,b.transformResults||[])})):[]),wy=Gj(sy.commitTime);return this.listener.Dr(wy,vy)}return w(!sy.writeResults||0===sy.writeResults.length),this.vr=!0,this.listener.Cr()}Nr(){const xy={};xy.database=Mj(this.N),this.mr(xy)}Sr(yy){const zy={streamToken:this.lastStreamToken,writes:yy.map(a=>Pj(this.N,a))};this.mr(zy)}}class Ay extends class{}{constructor(By,Cy,Dy){super(),this.credentials=By,this.sr=Cy,this.N=Dy,this.kr=!1}$r(){if(this.kr)throw new z(y.FAILED_PRECONDITION,"The client has already been terminated.")}Li(Ey,Fy,Gy){return this.$r(),this.credentials.getToken().then(a=>this.sr.Li(Ey,Fy,Gy,a)).catch(a=>{throw"FirebaseError"===a.name?(a.code===y.UNAUTHENTICATED&&this.credentials.invalidateToken(),a):new z(y.UNKNOWN,a.toString())})}Ki(Hy,Iy,Jy){return this.$r(),this.credentials.getToken().then(a=>this.sr.Ki(Hy,Iy,Jy,a)).catch(a=>{throw"FirebaseError"===a.name?(a.code===y.UNAUTHENTICATED&&this.credentials.invalidateToken(),a):new z(y.UNKNOWN,a.toString())})}terminate(){this.kr=!0}}class Ky{constructor(Ly,My,Ny,Oy,Py){this.localStore=Ly,this.datastore=My,this.asyncQueue=Ny,this.remoteSyncer={},this.jr=[],this.Qr=new Map,this.Wr=new Set,this.Gr=[],this.zr=Py,this.zr.Ti(a=>{Ny.enqueueAndForget(async()=>{dz(this)&&(r("RemoteStore","Restarting streams for network reachability change."),await async function(a){const b=x(a);b.Wr.add(4),await Yy(b),b.Hr.set("Unknown"),b.Wr.delete(4),await Xy(b)}(this))})}),this.Hr=new class{constructor(Qy,Ry){this.asyncQueue=Qy,this.onlineStateHandler=Ry,this.state="Unknown",this.Or=0,this.Fr=null,this.Mr=!0}Lr(){0===this.Or&&(this.Br("Unknown"),this.Fr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",10e3,()=>(this.Fr=null,this.Ur("Backend didn't respond within 10 seconds."),this.Br("Offline"),Promise.resolve())))}qr(Sy){"Online"===this.state?this.Br("Unknown"):(this.Or++,this.Or>=1&&(this.Kr(),this.Ur(`Connection failed 1 times. Most recent error: ${Sy.toString()}`),this.Br("Offline")))}set(Ty){this.Kr(),this.Or=0,"Online"===Ty&&(this.Mr=!1),this.Br(Ty)}Br(Uy){Uy!==this.state&&(this.state=Uy,this.onlineStateHandler(Uy))}Ur(Vy){const Wy=`Could not reach Cloud Firestore backend. ${Vy}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Mr?(s(Wy),this.Mr=!1):r("OnlineStateTracker",Wy)}Kr(){null!==this.Fr&&(this.Fr.cancel(),this.Fr=null)}}(Ny,Oy)}}async function Xy(a){if(dz(a))for(const b of a.Gr)await b(!0)}async function Yy(a){for(const b of a.Gr)await b(!1)}function Zy(a,b){const c=x(a);c.Qr.has(b.targetId)||(c.Qr.set(b.targetId,b),cz(c)?bz(c):uz(c).hr()&&_y(c,b))}function $y(a,b){const c=x(a),d=uz(c);c.Qr.delete(b),d.hr()&&az(c,b),0===c.Qr.size&&(d.hr()?d.wr():dz(c)&&c.Hr.set("Unknown"))}function _y(a,b){a.Jr.Y(b.targetId),uz(a).br(b)}function az(a,b){a.Jr.Y(b),uz(a).Pr(b)}function bz(a){a.Jr=new Li({getRemoteKeysForTarget:b=>a.remoteSyncer.getRemoteKeysForTarget(b),Tt:b=>a.Qr.get(b)||null}),uz(a).start(),a.Hr.Lr()}function cz(a){return dz(a)&&!uz(a).ur()&&a.Qr.size>0}function dz(a){return 0===x(a).Wr.size}function ez(a){a.Jr=void 0}async function fz(a){a.Qr.forEach((b,c)=>{_y(a,b)})}async function gz(a,b){ez(a),cz(a)?(a.Hr.qr(b),bz(a)):a.Hr.set("Unknown")}async function hz(a,b,c){if(a.Hr.set("Online"),b instanceof yi&&2===b.state&&b.cause)try{await async function(a,b){const c=b.cause;for(const d of b.targetIds)a.Qr.has(d)&&(await a.remoteSyncer.rejectListen(d,c),a.Qr.delete(d),a.Jr.removeTarget(d))}(a,b)}catch(d){r("RemoteStore","Failed to remove targets %s: %s ",b.targetIds.join(","),d),await iz(a,d)}else if(b instanceof qi?a.Jr.rt(b):b instanceof vi?a.Jr.ft(b):a.Jr.at(b),!c.isEqual(Ba.min()))try{const e=await mr(a.localStore);c.compareTo(e)>=0&&await function(a,b){const c=a.Jr._t(b);return c.targetChanges.forEach((c,d)=>{if(c.resumeToken.approximateByteSize()>0){const e=a.Qr.get(d);e&&a.Qr.set(d,e.withResumeToken(c.resumeToken,b))}}),c.targetMismatches.forEach(b=>{const c=a.Qr.get(b);if(c){a.Qr.set(b,c.withResumeToken(Db.EMPTY_BYTE_STRING,c.snapshotVersion)),az(a,b);const d=new Mn(c.target,b,1,c.sequenceNumber);_y(a,d)}}),a.remoteSyncer.applyRemoteEvent(c)}(a,c)}catch(f){r("RemoteStore","Failed to raise snapshot:",f),await iz(a,f)}}async function iz(a,b,c){if(!Dm(b))throw b;a.Wr.add(1),await Yy(a),a.Hr.set("Offline"),c||(c=()=>mr(a.localStore)),a.asyncQueue.enqueueRetryable(async()=>{r("RemoteStore","Retrying IndexedDB access"),await c(),a.Wr.delete(1),await Xy(a)})}function jz(a,b){return b().catch(c=>iz(a,c,b))}async function kz(a){const b=x(a),c=vz(b);let d=b.jr.length>0?b.jr[b.jr.length-1].batchId:-1;for(;lz(b);)try{const e=await nr(b.localStore,d);if(null===e){0===b.jr.length&&c.wr();break}d=e.batchId,mz(b,e)}catch(f){await iz(b,f)}nz(b)&&oz(b)}function lz(a){return dz(a)&&a.jr.length<10}function mz(a,b){a.jr.push(b);const c=vz(a);c.hr()&&c.Vr&&c.Sr(b.mutations)}function nz(a){return dz(a)&&!vz(a).ur()&&a.jr.length>0}function oz(a){vz(a).start()}async function pz(a){vz(a).Nr()}async function qz(a){const b=vz(a);for(const c of a.jr)b.Sr(c.mutations)}async function rz(a,b,c){const d=a.jr.shift(),e=Bn.from(d,b,c);await jz(a,()=>a.remoteSyncer.applySuccessfulWrite(e)),await kz(a)}async function sz(a,b){b&&vz(a).Vr&&await async function(a,b){var c;if((function(a){switch(a){default:return v();case y.CANCELLED:case y.UNKNOWN:case y.DEADLINE_EXCEEDED:case y.RESOURCE_EXHAUSTED:case y.INTERNAL:case y.UNAVAILABLE:case y.UNAUTHENTICATED:return!1;case y.INVALID_ARGUMENT:case y.NOT_FOUND:case y.ALREADY_EXISTS:case y.PERMISSION_DENIED:case y.FAILED_PRECONDITION:case y.ABORTED:case y.OUT_OF_RANGE:case y.UNIMPLEMENTED:case y.DATA_LOSS:return!0}})(c=b.code)&&c!==y.ABORTED){const d=a.jr.shift();vz(a).dr(),await jz(a,()=>a.remoteSyncer.rejectFailedWrite(d.batchId,b)),await kz(a)}}(a,b),nz(a)&&oz(a)}async function tz(a,b){const c=x(a);b?(c.Wr.delete(2),await Xy(c)):b||(c.Wr.add(2),await Yy(c),c.Hr.set("Unknown"))}function uz(a){return a.Yr||(a.Yr=(function(a,b,c){const d=x(a);return d.$r(),new Yx(b,d.sr,d.credentials,d.N,c)})(a.datastore,a.asyncQueue,{Si:fz.bind(null,a),Ci:gz.bind(null,a),Rr:hz.bind(null,a)}),a.Gr.push(async b=>{b?(a.Yr.dr(),cz(a)?bz(a):a.Hr.set("Unknown")):(await a.Yr.stop(),ez(a))})),a.Yr}function vz(a){return a.Xr||(a.Xr=(function(a,b,c){const d=x(a);return d.$r(),new ly(b,d.sr,d.credentials,d.N,c)})(a.datastore,a.asyncQueue,{Si:pz.bind(null,a),Ci:sz.bind(null,a),Cr:qz.bind(null,a),Dr:rz.bind(null,a)}),a.Gr.push(async b=>{b?(a.Xr.dr(),await kz(a)):(await a.Xr.stop(),a.jr.length>0&&(r("RemoteStore",`Stopping write stream with ${a.jr.length} pending writes`),a.jr=[]))})),a.Xr}class wz{constructor(xz,yz,zz,Az,Bz){this.asyncQueue=xz,this.timerId=yz,this.targetTimeMs=zz,this.op=Az,this.removalCallback=Bz,this.deferred=new C,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(a=>{})}static createAndSchedule(Cz,Dz,Ez,Fz,Gz){const Hz=Date.now()+Ez,Iz=new wz(Cz,Dz,Hz,Fz,Gz);return Iz.start(Ez),Iz}start(Jz){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),Jz)}skipDelay(){return this.handleDelayElapsed()}cancel(Kz){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new z(y.CANCELLED,"Operation cancelled"+(Kz?": "+Kz:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(a=>this.deferred.resolve(a))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Lz(a,b){if(s("AsyncQueue",`${b}: ${a}`),Dm(a))return new z(y.UNAVAILABLE,`${b}: ${a}`);throw a}class Mz{constructor(Nz){this.comparator=Nz?(a,b)=>Nz(a,b)||Vb.comparator(a.key,b.key):(a,b)=>Vb.comparator(a.key,b.key),this.keyedMap=Uh(),this.sortedSet=new Xf(this.comparator)}static emptySet(Oz){return new Mz(Oz.comparator)}has(Pz){return null!=this.keyedMap.get(Pz)}get(Qz){return this.keyedMap.get(Qz)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(Rz){const Sz=this.keyedMap.get(Rz);return Sz?this.sortedSet.indexOf(Sz):-1}get size(){return this.sortedSet.size}forEach(Tz){this.sortedSet.inorderTraversal((a,b)=>(Tz(a),!1))}add(Uz){const Vz=this.delete(Uz.key);return Vz.copy(Vz.keyedMap.insert(Uz.key,Uz),Vz.sortedSet.insert(Uz,null))}delete(Wz){const Xz=this.get(Wz);return Xz?this.copy(this.keyedMap.remove(Wz),this.sortedSet.remove(Xz)):this}isEqual(Yz){if(!(Yz instanceof Mz))return!1;if(this.size!==Yz.size)return!1;const Zz=this.sortedSet.getIterator(),$z=Yz.sortedSet.getIterator();for(;Zz.hasNext();){const _z=Zz.getNext().key,aA=$z.getNext().key;if(!_z.isEqual(aA))return!1}return!0}toString(){const bA=[];return this.forEach(a=>{bA.push(a.toString())}),0===bA.length?"DocumentSet ()":"DocumentSet (\n  "+bA.join("  \n")+"\n)"}copy(cA,dA){const eA=new Mz;return eA.comparator=this.comparator,eA.keyedMap=cA,eA.sortedSet=dA,eA}}class fA{constructor(){this.Zr=new Xf(Vb.comparator)}track(gA){const hA=gA.doc.key,iA=this.Zr.get(hA);iA?0!==gA.type&&3===iA.type?this.Zr=this.Zr.insert(hA,gA):3===gA.type&&1!==iA.type?this.Zr=this.Zr.insert(hA,{type:iA.type,doc:gA.doc}):2===gA.type&&2===iA.type?this.Zr=this.Zr.insert(hA,{type:2,doc:gA.doc}):2===gA.type&&0===iA.type?this.Zr=this.Zr.insert(hA,{type:0,doc:gA.doc}):1===gA.type&&0===iA.type?this.Zr=this.Zr.remove(hA):1===gA.type&&2===iA.type?this.Zr=this.Zr.insert(hA,{type:1,doc:iA.doc}):0===gA.type&&1===iA.type?this.Zr=this.Zr.insert(hA,{type:2,doc:gA.doc}):v():this.Zr=this.Zr.insert(hA,gA)}eo(){const jA=[];return this.Zr.inorderTraversal((a,b)=>{jA.push(b)}),jA}}class kA{constructor(lA,mA,nA,oA,pA,qA,rA,sA){this.query=lA,this.docs=mA,this.oldDocs=nA,this.docChanges=oA,this.mutatedKeys=pA,this.fromCache=qA,this.syncStateChanged=rA,this.excludesMetadataChanges=sA}static fromInitialDocuments(tA,uA,vA,wA){const xA=[];return uA.forEach(a=>{xA.push({type:0,doc:a})}),new kA(tA,uA,Mz.emptySet(uA),xA,vA,wA,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(yA){if(!(this.fromCache===yA.fromCache&&this.syncStateChanged===yA.syncStateChanged&&this.mutatedKeys.isEqual(yA.mutatedKeys)&&Ke(this.query,yA.query)&&this.docs.isEqual(yA.docs)&&this.oldDocs.isEqual(yA.oldDocs)))return!1;const zA=this.docChanges,AA=yA.docChanges;if(zA.length!==AA.length)return!1;for(let BA=0;BA<zA.length;BA++)if(zA[BA].type!==AA[BA].type||!zA[BA].doc.isEqual(AA[BA].doc))return!1;return!0}}class CA{constructor(){this.no=void 0,this.listeners=[]}}class DA{constructor(){this.queries=new qp(a=>Le(a),Ke),this.onlineState="Unknown",this.so=new Set}}async function EA(a,b){const c=x(a),d=b.query;let e=!1,f=c.queries.get(d);if(f||(e=!0,f=new CA),e)try{f.no=await c.onListen(d)}catch(g){const h=Lz(g,`Initialization of query '${Me(b.query)}' failed`);return void b.onError(h)}c.queries.set(d,f),f.listeners.push(b),b.io(c.onlineState),f.no&&b.ro(f.no)&&IA(c)}async function FA(a,b){const c=x(a),d=b.query;let e=!1;const f=c.queries.get(d);if(f){const g=f.listeners.indexOf(b);g>=0&&(f.listeners.splice(g,1),e=0===f.listeners.length)}if(e)return c.queries.delete(d),c.onUnlisten(d)}function GA(a,b){const c=x(a);let d=!1;for(const e of b){const f=e.query,g=c.queries.get(f);if(g){for(const h of g.listeners)h.ro(e)&&(d=!0);g.no=e}}d&&IA(c)}function HA(a,b,c){const d=x(a),e=d.queries.get(b);if(e)for(const f of e.listeners)f.onError(c);d.queries.delete(b)}function IA(a){a.so.forEach(a=>{a.next()})}class JA{constructor(KA,LA,MA){this.query=KA,this.oo=LA,this.co=!1,this.ao=null,this.onlineState="Unknown",this.options=MA||{}}ro(NA){if(!this.options.includeMetadataChanges){const OA=[];for(const PA of NA.docChanges)3!==PA.type&&OA.push(PA);NA=new kA(NA.query,NA.docs,NA.oldDocs,OA,NA.mutatedKeys,NA.fromCache,NA.syncStateChanged,!0)}let QA=!1;return this.co?this.uo(NA)&&(this.oo.next(NA),QA=!0):this.ho(NA,this.onlineState)&&(this.lo(NA),QA=!0),this.ao=NA,QA}onError(RA){this.oo.error(RA)}io(SA){this.onlineState=SA;let TA=!1;return this.ao&&!this.co&&this.ho(this.ao,SA)&&(this.lo(this.ao),TA=!0),TA}ho(UA,VA){if(!UA.fromCache)return!0;const WA="Offline"!==VA;return(!this.options.fo||!WA)&&(!UA.docs.isEmpty()||"Offline"===VA)}uo(XA){if(XA.docChanges.length>0)return!0;const YA=this.ao&&this.ao.hasPendingWrites!==XA.hasPendingWrites;return!(!XA.syncStateChanged&&!YA)&& !0===this.options.includeMetadataChanges}lo(ZA){ZA=kA.fromInitialDocuments(ZA.query,ZA.docs,ZA.mutatedKeys,ZA.fromCache),this.co=!0,this.oo.next(ZA)}}class $A{constructor(_A){this.key=_A}}class aB{constructor(bB){this.key=bB}}class cB{constructor(dB,eB){this.query=dB,this.po=eB,this.To=null,this.current=!1,this.Eo=Yh(),this.mutatedKeys=Yh(),this.Io=Oe(dB),this.Ao=new Mz(this.Io)}get Ro(){return this.po}bo(fB,gB){const hB=gB?gB.Po:new fA,iB=gB?gB.Ao:this.Ao;let jB=gB?gB.mutatedKeys:this.mutatedKeys,kB=iB,lB=!1;const mB=Ge(this.query)&&iB.size===this.query.limit?iB.last():null,nB=He(this.query)&&iB.size===this.query.limit?iB.first():null;if(fB.inorderTraversal((a,b)=>{const c=iB.get(a),d=Ne(this.query,b)?b:null,e=!!c&&this.mutatedKeys.has(c.key),f=!!d&&(d.hasLocalMutations||this.mutatedKeys.has(d.key)&&d.hasCommittedMutations);let g=!1;c&&d?c.data.isEqual(d.data)?e!==f&&(hB.track({type:3,doc:d}),g=!0):this.vo(c,d)||(hB.track({type:2,doc:d}),g=!0,(mB&&this.Io(d,mB)>0||nB&&0>this.Io(d,nB))&&(lB=!0)):!c&&d?(hB.track({type:0,doc:d}),g=!0):c&&!d&&(hB.track({type:1,doc:c}),g=!0,(mB||nB)&&(lB=!0)),g&&(d?(kB=kB.add(d),jB=f?jB.add(a):jB.delete(a)):(kB=kB.delete(a),jB=jB.delete(a)))}),Ge(this.query)||He(this.query))for(;kB.size>this.query.limit;){const oB=Ge(this.query)?kB.last():kB.first();kB=kB.delete(oB.key),jB=jB.delete(oB.key),hB.track({type:1,doc:oB})}return{Ao:kB,Po:hB,Ln:lB,mutatedKeys:jB}}vo(pB,qB){return pB.hasLocalMutations&&qB.hasCommittedMutations&&!qB.hasLocalMutations}applyChanges(rB,sB,tB){const uB=this.Ao;this.Ao=rB.Ao,this.mutatedKeys=rB.mutatedKeys;const vB=rB.Po.eo();vB.sort((a,b)=>(function(a,b){const c=a=>{switch(a){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return c(a)-c(b)})(a.type,b.type)||this.Io(a.doc,b.doc)),this.Vo(tB);const wB=sB?this.So():[],xB=0===this.Eo.size&&this.current?1:0,yB=xB!==this.To;return(this.To=xB,0!==vB.length||yB)?{snapshot:new kA(this.query,rB.Ao,uB,vB,rB.mutatedKeys,0===xB,yB,!1),Do:wB}:{Do:wB}}io(zB){return this.current&&"Offline"===zB?(this.current=!1,this.applyChanges({Ao:this.Ao,Po:new fA,mutatedKeys:this.mutatedKeys,Ln:!1},!1)):{Do:[]}}Co(AB){return!this.po.has(AB)&& !!this.Ao.has(AB)&&!this.Ao.get(AB).hasLocalMutations}Vo(BB){BB&&(BB.addedDocuments.forEach(a=>this.po=this.po.add(a)),BB.modifiedDocuments.forEach(a=>{}),BB.removedDocuments.forEach(a=>this.po=this.po.delete(a)),this.current=BB.current)}So(){if(!this.current)return[];const CB=this.Eo;this.Eo=Yh(),this.Ao.forEach(a=>{this.Co(a.key)&&(this.Eo=this.Eo.add(a.key))});const DB=[];return CB.forEach(a=>{this.Eo.has(a)||DB.push(new aB(a))}),this.Eo.forEach(a=>{CB.has(a)||DB.push(new $A(a))}),DB}No(EB){this.po=EB.Gn,this.Eo=Yh();const FB=this.bo(EB.documents);return this.applyChanges(FB,!0)}xo(){return kA.fromInitialDocuments(this.query,this.Ao,this.mutatedKeys,0===this.To)}}class GB{constructor(HB,IB,JB){this.query=HB,this.targetId=IB,this.view=JB}}class KB{constructor(LB){this.key=LB,this.ko=!1}}class MB{constructor(NB,OB,PB,QB,RB,SB){this.localStore=NB,this.remoteStore=OB,this.eventManager=PB,this.sharedClientState=QB,this.currentUser=RB,this.maxConcurrentLimboResolutions=SB,this.$o={},this.Oo=new qp(a=>Le(a),Ke),this.Fo=new Map,this.Mo=new Set,this.Lo=new Xf(Vb.comparator),this.Bo=new Map,this.Uo=new qr,this.qo={},this.Ko=new Map,this.jo=np.ie(),this.onlineState="Unknown",this.Qo=void 0}get isPrimaryClient(){return!0===this.Qo}}async function TB(a,b){const c=kC(a);let d,e;const f=c.Oo.get(b);if(f)d=f.targetId,c.sharedClientState.addLocalQueryTarget(d),e=f.view.xo();else{const g=await function(a,b){const c=x(a);return c.persistence.runTransaction("Allocate target","readwrite",a=>{let d;return c.ze.getTargetData(a,b).next(e=>e?(d=e,nl.resolve(d)):c.ze.allocateTargetId(a).next(e=>(d=new Mn(b,e,0,a.currentSequenceNumber),c.ze.addTargetData(a,d).next(()=>d))))}).then(a=>{const d=c.Un.get(a.targetId);return(null===d||a.snapshotVersion.compareTo(d.snapshotVersion)>0)&&(c.Un=c.Un.insert(a.targetId,a),c.qn.set(b,a.targetId)),a})}(c.localStore,Je(b)),h=c.sharedClientState.addLocalQueryTarget(g.targetId);e=await UB(c,b,d=g.targetId,"current"===h),c.isPrimaryClient&&Zy(c.remoteStore,g)}return e}async function UB(a,b,c,d){a.Wo=(b,c,d)=>(async function(a,b,c,d){let e=b.view.bo(c);e.Ln&&(e=await pr(a.localStore,b.query,!1).then(({documents:a})=>b.view.bo(a,e)));const f=d&&d.targetChanges.get(b.targetId),g=b.view.applyChanges(e,a.isPrimaryClient,f);return eC(a,b.targetId,g.Do),g.snapshot})(a,b,c,d);const e=await pr(a.localStore,b,!0),f=new cB(b,e.Gn),g=f.bo(e.documents),h=ii.createSynthesizedTargetChangeForCurrentChange(c,d&&"Offline"!==a.onlineState),i=f.applyChanges(g,a.isPrimaryClient,h);eC(a,c,i.Do);const j=new GB(b,c,f);return a.Oo.set(b,j),a.Fo.has(c)?a.Fo.get(c).push(b):a.Fo.set(c,[b]),i.snapshot}async function VB(a,b){const c=x(a),d=c.Oo.get(b),e=c.Fo.get(d.targetId);if(e.length>1)return c.Fo.set(d.targetId,e.filter(a=>!Ke(a,b))),void c.Oo.delete(b);c.isPrimaryClient?(c.sharedClientState.removeLocalQueryTarget(d.targetId),c.sharedClientState.isActiveQueryTarget(d.targetId)||await or(c.localStore,d.targetId,!1).then(()=>{c.sharedClientState.clearQueryState(d.targetId),$y(c.remoteStore,d.targetId),cC(c,d.targetId)}).catch(pp)):(cC(c,d.targetId),await or(c.localStore,d.targetId,!0))}async function WB(a,b,c){const d=lC(a);try{var e,f,g;const h=await function(a,b){const c=x(a),d=sa.now(),e=b.reduce((a,b)=>a.add(b.key),Yh());let f;return c.persistence.runTransaction("Locally write mutations","readwrite",a=>c.Qn.Pn(a,e).next(e=>{f=e;const g=[];for(const h of b){const i=xf(h,f.get(h.key));null!=i&&g.push(new Ff(h.key,i,Nc(i.value.mapValue),nf.exists(!0)))}return c.In.addMutationBatch(a,d,g,b)})).then(a=>(a.applyToLocalDocumentSet(f),{batchId:a.batchId,changes:f}))}(d.localStore,b);let i;d.sharedClientState.addPendingMutation(h.batchId),e=d,f=h.batchId,g=c,(i=e.qo[e.currentUser.toKey()])||(i=new Xf(qa)),i=i.insert(f,g),e.qo[e.currentUser.toKey()]=i,await hC(d,h.changes),await kz(d.remoteStore)}catch(j){const k=Lz(j,"Failed to persist write");c.reject(k)}}async function XB(a,b){const c=x(a);try{const d=await function(a,b){const c=x(a),d=b.snapshotVersion;let e=c.Un;return c.persistence.runTransaction("Apply remote event","readwrite-primary",a=>{var f,g,h,i,j;const k=c.jn.newChangeBuffer({trackRemovals:!0});e=c.Un;const l=[];b.targetChanges.forEach((b,f)=>{const g=e.get(f);if(g){l.push(c.ze.removeMatchingKeys(a,b.removedDocuments,f).next(()=>c.ze.addMatchingKeys(a,b.addedDocuments,f)));const h=b.resumeToken;if(h.approximateByteSize()>0){var i,j,k;const m=g.withResumeToken(h,d).withSequenceNumber(a.currentSequenceNumber);e=e.insert(f,m),i=g,j=m,k=b,((w(j.resumeToken.approximateByteSize()>0),0===i.resumeToken.approximateByteSize())?0:j.snapshotVersion.toMicroseconds()-i.snapshotVersion.toMicroseconds()>=30e7?0:!(k.addedDocuments.size+k.modifiedDocuments.size+k.removedDocuments.size>0))||l.push(c.ze.updateTargetData(a,m))}}});let m=Sh(),n;if(b.documentUpdates.forEach((d,e)=>{b.resolvedLimboDocuments.has(d)&&l.push(c.persistence.referenceDelegate.updateLimboDocument(a,d))}),l.push((f=a,g=k,h=b.documentUpdates,i=d,j=void 0,n=Yh(),h.forEach(a=>n=n.add(a)),g.getEntries(f,n).next(a=>{let b=Sh();return h.forEach((c,d)=>{const e=a.get(c),f=(null==j?void 0:j.get(c))||i;d.isNoDocument()&&d.version.isEqual(Ba.min())?(g.removeEntry(c,f),b=b.insert(c,d)):!e.isValidDocument()||d.version.compareTo(e.version)>0||0===d.version.compareTo(e.version)&&e.hasPendingWrites?(g.addEntry(d,f),b=b.insert(c,d)):r("LocalStore","Ignoring outdated watch update for ",c,". Current version:",e.version," Watch version:",d.version)}),b})).next(a=>{m=a})),!d.isEqual(Ba.min())){const o=c.ze.getLastRemoteSnapshotVersion(a).next(b=>c.ze.setTargetsMetadata(a,a.currentSequenceNumber,d));l.push(o)}return nl.waitFor(l).next(()=>k.apply(a)).next(()=>c.Qn.vn(a,m)).next(()=>m)}).then(a=>(c.Un=e,a))}(c.localStore,b);b.targetChanges.forEach((a,b)=>{const d=c.Bo.get(b);d&&(w(a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size<=1),a.addedDocuments.size>0?d.ko=!0:a.modifiedDocuments.size>0?w(d.ko):a.removedDocuments.size>0&&(w(d.ko),d.ko=!1))}),await hC(c,d,b)}catch(e){await pp(e)}}function YB(a,b,c){const d=x(a);if(d.isPrimaryClient&&0===c|| !d.isPrimaryClient&&1===c){const e=[];d.Oo.forEach((a,c)=>{const d=c.view.io(b);d.snapshot&&e.push(d.snapshot)}),(function(a,b){const c=x(a);c.onlineState=b;let d=!1;c.queries.forEach((a,c)=>{for(const e of c.listeners)e.io(b)&&(d=!0)}),d&&IA(c)})(d.eventManager,b),e.length&&d.$o.Rr(e),d.onlineState=b,d.isPrimaryClient&&d.sharedClientState.setOnlineState(b)}}async function ZB(a,b,c){const d=x(a);d.sharedClientState.updateQueryState(b,"rejected",c);const e=d.Bo.get(b),f=e&&e.key;if(f){let g=new Xf(Vb.comparator);g=g.insert(f,Oc.newNoDocument(f,Ba.min()));const h=Yh().add(f),i=new _h(Ba.min(),new Map,new nh(qa),g,h);await XB(d,i),d.Lo=d.Lo.remove(f),d.Bo.delete(b),gC(d)}else await or(d.localStore,b,!1).then(()=>cC(d,b,c)).catch(pp)}async function $B(a,b){const c=x(a),d=b.batch.batchId;try{const e=await function(a,b){const c=x(a);return c.persistence.runTransaction("Acknowledge batch","readwrite-primary",a=>{const d=b.batch.keys(),e=c.jn.newChangeBuffer({trackRemovals:!0});return(function(a,b,c,d){const e=c.batch,f=e.keys();let g=nl.resolve();return f.forEach(a=>{g=g.next(()=>d.getEntry(b,a)).next(b=>{const f=c.docVersions.get(a);w(null!==f),0>b.version.compareTo(f)&&(e.applyToRemoteDocument(b,c),b.isValidDocument()&&d.addEntry(b,c.commitVersion))})}),g.next(()=>a.In.removeMutationBatch(b,e))})(c,a,b,e).next(()=>e.apply(a)).next(()=>c.In.performConsistencyCheck(a)).next(()=>c.Qn.Pn(a,d))})}(c.localStore,b);bC(c,d,null),aC(c,d),c.sharedClientState.updateMutationState(d,"acknowledged"),await hC(c,e)}catch(f){await pp(f)}}async function _B(a,b,c){const d=x(a);try{const e=await function(a,b){const c=x(a);return c.persistence.runTransaction("Reject batch","readwrite-primary",a=>{let d;return c.In.lookupMutationBatch(a,b).next(b=>(w(null!==b),d=b.keys(),c.In.removeMutationBatch(a,b))).next(()=>c.In.performConsistencyCheck(a)).next(()=>c.Qn.Pn(a,d))})}(d.localStore,b);bC(d,b,c),aC(d,b),d.sharedClientState.updateMutationState(b,"rejected",c),await hC(d,e)}catch(f){await pp(f)}}function aC(a,b){(a.Ko.get(b)||[]).forEach(a=>{a.resolve()}),a.Ko.delete(b)}function bC(a,b,c){const d=x(a);let e=d.qo[d.currentUser.toKey()];if(e){const f=e.get(b);f&&(c?f.reject(c):f.resolve(),e=e.remove(b)),d.qo[d.currentUser.toKey()]=e}}function cC(a,b,c=null){for(const d of(a.sharedClientState.removeLocalQueryTarget(b),a.Fo.get(b)))a.Oo.delete(d),c&&a.$o.Go(d,c);a.Fo.delete(b),a.isPrimaryClient&&a.Uo.cs(b).forEach(b=>{a.Uo.containsKey(b)||dC(a,b)})}function dC(a,b){a.Mo.delete(b.path.canonicalString());const c=a.Lo.get(b);null!==c&&($y(a.remoteStore,c),a.Lo=a.Lo.remove(b),a.Bo.delete(c),gC(a))}function eC(a,b,c){for(const d of c)d instanceof $A?(a.Uo.addReference(d.key,b),fC(a,d)):d instanceof aB?(r("SyncEngine","Document no longer in limbo: "+d.key),a.Uo.removeReference(d.key,b),a.Uo.containsKey(d.key)||dC(a,d.key)):v()}function fC(a,b){const c=b.key,d=c.path.canonicalString();a.Lo.get(c)||a.Mo.has(d)||(r("SyncEngine","New document in limbo: "+c),a.Mo.add(d),gC(a))}function gC(a){for(;a.Mo.size>0&&a.Lo.size<a.maxConcurrentLimboResolutions;){const b=a.Mo.values().next().value;a.Mo.delete(b);const c=new Vb(db.fromString(b)),d=a.jo.next();a.Bo.set(d,new KB(c)),a.Lo=a.Lo.insert(c,d),Zy(a.remoteStore,new Mn(Je(Fe(c.path)),d,2,fa.T))}}async function hC(a,b,c){const d=x(a),e=[],f=[],g=[];d.Oo.isEmpty()||(d.Oo.forEach((a,h)=>{g.push(d.Wo(h,b,c).then(a=>{if(a){d.isPrimaryClient&&d.sharedClientState.updateQueryState(h.targetId,a.fromCache?"not-current":"current"),e.push(a);const b=Gq.kn(h.targetId,a);f.push(b)}}))}),await Promise.all(g),d.$o.Rr(e),await async function(a,b){const c=x(a);try{await c.persistence.runTransaction("notifyLocalViewChanges","readwrite",a=>nl.forEach(b,b=>nl.forEach(b.Nn,d=>c.persistence.referenceDelegate.addReference(a,b.targetId,d)).next(()=>nl.forEach(b.xn,d=>c.persistence.referenceDelegate.removeReference(a,b.targetId,d)))))}catch(d){if(!Dm(d))throw d;r("LocalStore","Failed to update sequence numbers: "+d)}for(const e of b){const f=e.targetId;if(!e.fromCache){const g=c.Un.get(f),h=g.snapshotVersion,i=g.withLastLimboFreeSnapshotVersion(h);c.Un=c.Un.insert(f,i)}}}(d.localStore,f))}async function iC(a,b){const c=x(a);if(!c.currentUser.isEqual(b)){var d;r("SyncEngine","User change. New user:",b.toKey());const e=await lr(c.localStore,b);c.currentUser=b,(d=c).Ko.forEach(a=>{a.forEach(a=>{a.reject(new z(y.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),d.Ko.clear(),c.sharedClientState.handleUserChange(b,e.removedBatchIds,e.addedBatchIds),await hC(c,e.Wn)}}function jC(a,b){const c=x(a),d=c.Bo.get(b);if(d&&d.ko)return Yh().add(d.key);{let e=Yh();const f=c.Fo.get(b);if(!f)return e;for(const g of f){const h=c.Oo.get(g);e=e.unionWith(h.view.Ro)}return e}}function kC(a){const b=x(a);return b.remoteStore.remoteSyncer.applyRemoteEvent=XB.bind(null,b),b.remoteStore.remoteSyncer.getRemoteKeysForTarget=jC.bind(null,b),b.remoteStore.remoteSyncer.rejectListen=ZB.bind(null,b),b.$o.Rr=GA.bind(null,b.eventManager),b.$o.Go=HA.bind(null,b.eventManager),b}function lC(a){const b=x(a);return b.remoteStore.remoteSyncer.applySuccessfulWrite=$B.bind(null,b),b.remoteStore.remoteSyncer.rejectFailedWrite=_B.bind(null,b),b}class mC{constructor(){this.synchronizeTabs=!1}async initialize(nC){this.N=wx(nC.databaseInfo.databaseId),this.sharedClientState=this.Ho(nC),this.persistence=this.Jo(nC),await this.persistence.start(),this.gcScheduler=this.Yo(nC),this.localStore=this.Xo(nC)}Yo(oC){return null}Xo(pC){var qC;return this.persistence,qC=new Qq,pC.initialUser,this.N,new fr(this.persistence,qC,pC.initialUser,this.N)}Jo(rC){return new Bt(_u.Ns,this.N)}Ho(sC){return new gw}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class tC{async initialize(uC,vC){this.localStore||(this.localStore=uC.localStore,this.sharedClientState=uC.sharedClientState,this.datastore=this.createDatastore(vC),this.remoteStore=this.createRemoteStore(vC),this.eventManager=this.createEventManager(vC),this.syncEngine=this.createSyncEngine(vC,!uC.synchronizeTabs),this.sharedClientState.onlineStateHandler=a=>YB(this.syncEngine,a,1),this.remoteStore.remoteSyncer.handleCredentialChange=iC.bind(null,this.syncEngine),await tz(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(wC){return new DA}createDatastore(xC){var yC,zC;const AC=wx(xC.databaseInfo.databaseId),BC=(xC.databaseInfo,new Nw(xC.databaseInfo));return xC.credentials,yC=BC,zC=AC,new Ay(xC.credentials,yC,zC)}createRemoteStore(CC){var DC,EC;return this.localStore,this.datastore,CC.asyncQueue,DC=a=>YB(this.syncEngine,a,0),EC=Aw.bt()?new Aw:new yw,new Ky(this.localStore,this.datastore,CC.asyncQueue,DC,EC)}createSyncEngine(FC,GC){return(function(a,b,c,d,e,f,g){const h=new MB(a,b,c,d,e,f);return g&&(h.Qo=!0),h})(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,FC.initialUser,FC.maxConcurrentLimboResolutions,GC)}terminate(){return(async function(a){const b=x(a);r("RemoteStore","RemoteStore shutting down."),b.Wr.add(5),await Yy(b),b.zr.shutdown(),b.Hr.set("Unknown")})(this.remoteStore)}}class HC{constructor(IC){this.observer=IC,this.muted=!1}next(JC){this.observer.next&&this.tc(this.observer.next,JC)}error(KC){this.observer.error?this.tc(this.observer.error,KC):console.error("Uncaught Error in snapshot listener:",KC)}ec(){this.muted=!0}tc(LC,MC){this.muted||setTimeout(()=>{this.muted||LC(MC)},0)}}class NC{constructor(OC,PC,QC){this.credentials=OC,this.asyncQueue=PC,this.databaseInfo=QC,this.user=l.UNAUTHENTICATED,this.clientId=la.I(),this.credentialListener=()=>Promise.resolve(),this.credentials.start(PC,async a=>{r("FirestoreClient","Received user=",a.uid),await this.credentialListener(a),this.user=a})}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(RC){this.credentialListener=RC}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new z(y.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const SC=new C;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.credentials.shutdown(),SC.resolve()}catch(a){const b=Lz(a,"Failed to shutdown persistence");SC.reject(b)}}),SC.promise}}async function TC(a,b){a.asyncQueue.verifyOperationInProgress(),r("FirestoreClient","Initializing OfflineComponentProvider");const c=await a.getConfiguration();await b.initialize(c);let d=c.initialUser;a.setCredentialChangeListener(async a=>{d.isEqual(a)||(await lr(b.localStore,a),d=a)}),b.persistence.setDatabaseDeletedListener(()=>a.terminate()),a.offlineComponents=b}async function UC(a,b){a.asyncQueue.verifyOperationInProgress();const c=await VC(a);r("FirestoreClient","Initializing OnlineComponentProvider");const d=await a.getConfiguration();await b.initialize(c,d),a.setCredentialChangeListener(a=>(async function(a,b){const c=x(a);c.asyncQueue.verifyOperationInProgress(),r("RemoteStore","RemoteStore received new credentials");const d=dz(c);c.Wr.add(3),await Yy(c),d&&c.Hr.set("Unknown"),await c.remoteSyncer.handleCredentialChange(b),c.Wr.delete(3),await Xy(c)})(b.remoteStore,a)),a.onlineComponents=b}async function VC(a){return a.offlineComponents||(r("FirestoreClient","Using default OfflineComponentProvider"),await TC(a,new mC)),a.offlineComponents}async function WC(a){return a.onlineComponents||(r("FirestoreClient","Using default OnlineComponentProvider"),await UC(a,new tC)),a.onlineComponents}async function XC(a){const b=await WC(a),c=b.eventManager;return c.onListen=TB.bind(null,b.syncEngine),c.onUnlisten=VB.bind(null,b.syncEngine),c}class YC{constructor(ZC,$C,_C,aD,bD,cD,dD,eD){this.databaseId=ZC,this.appId=$C,this.persistenceKey=_C,this.host=aD,this.ssl=bD,this.forceLongPolling=cD,this.autoDetectLongPolling=dD,this.useFetchStreams=eD}}class fD{constructor(gD,hD){this.projectId=gD,this.database=hD||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(iD){return iD instanceof fD&&iD.projectId===this.projectId&&iD.database===this.database}}const jD=new Map;function kD(a){if(!Vb.isDocumentKey(a))throw new z(y.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${a} has ${a.length}.`)}function lD(a){if(void 0===a)return"undefined";if(null===a)return"null";if("string"==typeof a)return a.length>20&&(a=`${a.substring(0,20)}...`),JSON.stringify(a);if("number"==typeof a||"boolean"==typeof a)return""+a;if("object"==typeof a){if(a instanceof Array)return"an array";{var b;const c=(b=a).constructor?b.constructor.name:null;return c?`a custom ${c} object`:"an object"}}return"function"==typeof a?"a function":v()}function mD(a,b){if("_delegate"in a&&(a=a._delegate),!(a instanceof b)){if(b.name===a.constructor.name)throw new z(y.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const c=lD(a);throw new z(y.INVALID_ARGUMENT,`Expected type '${b.name}', but it was: ${c}`)}}return a}class nD{constructor(oD){var pD;if(void 0===oD.host){if(void 0!==oD.ssl)throw new z(y.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=oD.host,this.ssl=null===(pD=oD.ssl)|| void 0===pD||pD;if(this.credentials=oD.credentials,this.ignoreUndefinedProperties=!!oD.ignoreUndefinedProperties,void 0===oD.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==oD.cacheSizeBytes&&oD.cacheSizeBytes<1048576)throw new z(y.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=oD.cacheSizeBytes}this.experimentalForceLongPolling=!!oD.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!oD.experimentalAutoDetectLongPolling,this.useFetchStreams=!!oD.useFetchStreams,(function(a,b,c,d){if(!0===b&& !0===d)throw new z(y.INVALID_ARGUMENT,"experimentalForceLongPolling and experimentalAutoDetectLongPolling cannot be used together.")})("experimentalForceLongPolling",oD.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",oD.experimentalAutoDetectLongPolling)}isEqual(qD){return this.host===qD.host&&this.ssl===qD.ssl&&this.credentials===qD.credentials&&this.cacheSizeBytes===qD.cacheSizeBytes&&this.experimentalForceLongPolling===qD.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===qD.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===qD.ignoreUndefinedProperties&&this.useFetchStreams===qD.useFetchStreams}}class rD{constructor(sD,tD){this._credentials=tD,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new nD({}),this._settingsFrozen=!1,sD instanceof fD?this._databaseId=sD:(this._app=sD,this._databaseId=(function(a){if(!Object.prototype.hasOwnProperty.apply(a.options,["projectId"]))throw new z(y.INVALID_ARGUMENT,"\"projectId\" not provided in firebase.initializeApp.");return new fD(a.options.projectId)})(sD))}get app(){if(!this._app)throw new z(y.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(uD){if(this._settingsFrozen)throw new z(y.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new nD(uD),void 0!==uD.credentials&&(this._credentials=(function(a){if(!a)return new G;switch(a.type){case"gapi":const b=a.client;return w(!("object"!=typeof b||null===b||!b.auth||!b.auth.getAuthHeaderValueForFirstParty)),new _(b,a.sessionIndex||"0",a.iamToken||null);case"provider":return a.client;default:throw new z(y.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}})(uD.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return(function(a){const b=jD.get(a);b&&(r("ComponentProvider","Removing Datastore"),jD.delete(a),b.terminate())})(this),Promise.resolve()}}class vD{constructor(wD,xD,yD){this.converter=xD,this._key=yD,this.type="document",this.firestore=wD}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new FD(this.firestore,this.converter,this._key.path.popLast())}withConverter(zD){return new vD(this.firestore,zD,this._key)}}class AD{constructor(BD,CD,DD){this.converter=CD,this._query=DD,this.type="query",this.firestore=BD}withConverter(ED){return new AD(this.firestore,ED,this._query)}}class FD extends AD{constructor(GD,HD,ID){super(GD,HD,Fe(ID)),this._path=ID,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const JD=this._path.popLast();return JD.isEmpty()?null:new vD(this.firestore,null,new Vb(JD))}withConverter(KD){return new FD(this.firestore,KD,this._path)}}function LD(a,b,...c){if(a=(0,i.m9)(a),1===arguments.length&&(b=la.I()),(function(a,b,c){if(!c)throw new z(y.INVALID_ARGUMENT,"Function doc() cannot be called with an empty path.")})("doc","path",b),a instanceof rD){const d=db.fromString(b,...c);return kD(d),new vD(a,null,new Vb(d))}{if(!(a instanceof vD||a instanceof FD))throw new z(y.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const e=a._path.child(db.fromString(b,...c));return kD(e),new vD(a.firestore,a instanceof FD?a.converter:null,new Vb(e))}}class MD extends rD{constructor(ND,OD){super(ND,OD),this.type="firestore",this._queue=new class{constructor(){this._c=Promise.resolve(),this.mc=[],this.gc=!1,this.yc=[],this.Tc=null,this.Ec=!1,this.Ic=!1,this.Ac=[],this.ar=new xx(this,"async_queue_retry"),this.Rc=()=>{const a=vx();a&&r("AsyncQueue","Visibility state changed to "+a.visibilityState),this.ar.tr()};const PD=vx();PD&&"function"==typeof PD.addEventListener&&PD.addEventListener("visibilitychange",this.Rc)}get isShuttingDown(){return this.gc}enqueueAndForget(QD){this.enqueue(QD)}enqueueAndForgetEvenWhileRestricted(RD){this.bc(),this.Pc(RD)}enterRestrictedMode(SD){if(!this.gc){this.gc=!0,this.Ic=SD||!1;const TD=vx();TD&&"function"==typeof TD.removeEventListener&&TD.removeEventListener("visibilitychange",this.Rc)}}enqueue(UD){if(this.bc(),this.gc)return new Promise(()=>{});const VD=new C;return this.Pc(()=>this.gc&&this.Ic?Promise.resolve():(UD().then(VD.resolve,VD.reject),VD.promise)).then(()=>VD.promise)}enqueueRetryable(WD){this.enqueueAndForget(()=>(this.mc.push(WD),this.vc()))}async vc(){if(0!==this.mc.length){try{await this.mc[0](),this.mc.shift(),this.ar.reset()}catch(XD){if(!Dm(XD))throw XD;r("AsyncQueue","Operation failed with retryable error: "+XD)}this.mc.length>0&&this.ar.Xi(()=>this.vc())}}Pc(YD){const ZD=this._c.then(()=>(this.Ec=!0,YD().catch(a=>{var b;this.Tc=a,this.Ec=!1;let c;const d=(c=(b=a).message||"",b.stack&&(c=b.stack.includes(b.message)?b.stack:b.message+"\n"+b.stack),c);throw s("INTERNAL UNHANDLED ERROR: ",d),a}).then(a=>(this.Ec=!1,a))));return this._c=ZD,ZD}enqueueAfterDelay($D,_D,aE){this.bc(),this.Ac.indexOf($D)> -1&&(_D=0);const bE=wz.createAndSchedule(this,$D,_D,aE,a=>this.Vc(a));return this.yc.push(bE),bE}bc(){this.Tc&&v()}verifyOperationInProgress(){}async Sc(){let cE;do await (cE=this._c);while(cE!==this._c)}Dc(dE){for(const eE of this.yc)if(eE.timerId===dE)return!0;return!1}Cc(fE){return this.Sc().then(()=>{for(const a of(this.yc.sort((a,b)=>a.targetTimeMs-b.targetTimeMs),this.yc))if(a.skipDelay(),"all"!==fE&&a.timerId===fE)break;return this.Sc()})}Nc(gE){this.Ac.push(gE)}Vc(hE){const iE=this.yc.indexOf(hE);this.yc.splice(iE,1)}},this._persistenceKey="name"in ND?ND.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||lE(this),this._firestoreClient.terminate()}}function jE(a=(0,f.getApp)()){return(0,f._getProvider)(a,"firestore").getImmediate()}function kE(a){return a._firestoreClient||lE(a),a._firestoreClient.verifyNotTerminated(),a._firestoreClient}function lE(a){var b,c,d;const e=a._freezeSettings(),f=(a._databaseId,c=(null===(b=a._app)|| void 0===b?void 0:b.options.appId)||"",a._persistenceKey,d=e,new YC(a._databaseId,c,a._persistenceKey,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,d.useFetchStreams));a._firestoreClient=new NC(a._credentials,a._queue,f)}class mE{constructor(...nE){for(let oE=0;oE<nE.length;++oE)if(0===nE[oE].length)throw new z(y.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new lb(nE)}isEqual(pE){return this._internalPath.isEqual(pE._internalPath)}}class qE{constructor(rE){this._byteString=rE}static fromBase64String(sE){try{return new qE(Db.fromBase64String(sE))}catch(tE){throw new z(y.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+tE)}}static fromUint8Array(uE){return new qE(Db.fromUint8Array(uE))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(vE){return this._byteString.isEqual(vE._byteString)}}class wE{constructor(xE){this._methodName=xE}}class yE{constructor(zE,AE){if(!isFinite(zE)||zE< -90||zE>90)throw new z(y.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+zE);if(!isFinite(AE)||AE< -180||AE>180)throw new z(y.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+AE);this._lat=zE,this._long=AE}get latitude(){return this._lat}get longitude(){return this._long}isEqual(BE){return this._lat===BE._lat&&this._long===BE._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(CE){return qa(this._lat,CE._lat)||qa(this._long,CE._long)}}const DE=/^__.*__$/;class EE{constructor(FE,GE,HE){this.data=FE,this.fieldMask=GE,this.fieldTransforms=HE}toMutation(IE,JE){return null!==this.fieldMask?new Ff(IE,this.data,this.fieldMask,JE,this.fieldTransforms):new Af(IE,this.data,JE,this.fieldTransforms)}}function KE(a){switch(a){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class LE{constructor(ME,NE,OE,PE,QE,RE){this.settings=ME,this.databaseId=NE,this.N=OE,this.ignoreUndefinedProperties=PE,void 0===QE&&this.xc(),this.fieldTransforms=QE||[],this.fieldMask=RE||[]}get path(){return this.settings.path}get kc(){return this.settings.kc}$c(SE){return new LE(Object.assign(Object.assign({},this.settings),SE),this.databaseId,this.N,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Oc(TE){var UE;const VE=null===(UE=this.path)|| void 0===UE?void 0:UE.child(TE),WE=this.$c({path:VE,Fc:!1});return WE.Mc(TE),WE}Lc(XE){var YE;const ZE=null===(YE=this.path)|| void 0===YE?void 0:YE.child(XE),$E=this.$c({path:ZE,Fc:!1});return $E.xc(),$E}Bc(_E){return this.$c({path:void 0,Fc:!0})}Uc(aF){return zF(aF,this.settings.methodName,this.settings.qc||!1,this.path,this.settings.Kc)}contains(bF){return void 0!==this.fieldMask.find(a=>bF.isPrefixOf(a))|| void 0!==this.fieldTransforms.find(a=>bF.isPrefixOf(a.field))}xc(){if(this.path)for(let cF=0;cF<this.path.length;cF++)this.Mc(this.path.get(cF))}Mc(dF){if(0===dF.length)throw this.Uc("Document fields must not be empty");if(KE(this.kc)&&DE.test(dF))throw this.Uc("Document fields cannot begin and end with \"__\"")}}class eF{constructor(fF,gF,hF){this.databaseId=fF,this.ignoreUndefinedProperties=gF,this.N=hF||wx(fF)}jc(iF,jF,kF,lF=!1){return new LE({kc:iF,methodName:jF,Kc:kF,path:lb.emptyPath(),Fc:!1,qc:lF},this.databaseId,this.N,this.ignoreUndefinedProperties)}}class mF extends null{_toFieldTransform(nF){if(2!==nF.kc)throw 1===nF.kc?nF.Uc(`${this._methodName}() can only appear at the top level of your update data`):nF.Uc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return nF.fieldMask.push(nF.path),null}isEqual(oF){return oF instanceof mF}}class pF extends null{_toFieldTransform(qF){return new gf(qF.path,new We)}isEqual(rF){return rF instanceof pF}}function sF(a,b){if(uF(a=(0,i.m9)(a)))return vF("Unsupported field value:",b,a),tF(a,b);if(a instanceof wE)return(function(a,b){if(!KE(b.kc))throw b.Uc(`${a._methodName}() can only be used with update() and set()`);if(!b.path)throw b.Uc(`${a._methodName}() is not currently supported inside arrays`);const c=a._toFieldTransform(b);c&&b.fieldTransforms.push(c)})(a,b),null;if(void 0===a&&b.ignoreUndefinedProperties)return null;if(b.path&&b.fieldMask.push(b.path),a instanceof Array){if(b.settings.Fc&&4!==b.kc)throw b.Uc("Nested arrays are not supported");return(function(a,b){const c=[];let d=0;for(const e of a){let f=sF(e,b.Bc(d));null==f&&(f={nullValue:"NULL_VALUE"}),c.push(f),d++}return{arrayValue:{values:c}}})(a,b)}return(function(a,b){var c,d;if(null===(a=(0,i.m9)(a)))return{nullValue:"NULL_VALUE"};if("number"==typeof a)return c=b.N,Ub(d=a)?Re(d):Qe(c,d);if("boolean"==typeof a)return{booleanValue:a};if("string"==typeof a)return{stringValue:a};if(a instanceof Date){const e=sa.fromDate(a);return{timestampValue:Ej(b.N,e)}}if(a instanceof sa){const f=new sa(a.seconds,1000*Math.floor(a.nanoseconds/1000));return{timestampValue:Ej(b.N,f)}}if(a instanceof yE)return{geoPointValue:{latitude:a.latitude,longitude:a.longitude}};if(a instanceof qE)return{bytesValue:Fj(b.N,a._byteString)};if(a instanceof vD){const g=b.databaseId,h=a.firestore._databaseId;if(!h.isEqual(g))throw b.Uc(`Document reference is for database ${h.projectId}/${h.database} but should be for database ${g.projectId}/${g.database}`);return{referenceValue:Hj(a.firestore._databaseId||b.databaseId,a._key.path)}}throw b.Uc(`Unsupported field value: ${lD(a)}`)})(a,b)}function tF(a,b){const c={};return Ia(a)?b.path&&b.path.length>0&&b.fieldMask.push(b.path):Ha(a,(a,d)=>{const e=sF(d,b.Oc(a));null!=e&&(c[a]=e)}),{mapValue:{fields:c}}}function uF(a){return!("object"!=typeof a||null===a||a instanceof Array||a instanceof Date||a instanceof sa||a instanceof yE||a instanceof qE||a instanceof vD||a instanceof wE)}function vF(a,b,c){var d;if(!uF(c)||"object"!=typeof(d=c)||null===d||Object.getPrototypeOf(d)!==Object.prototype&&null!==Object.getPrototypeOf(d)){const e=lD(c);throw"an object"===e?b.Uc(a+" a custom object"):b.Uc(a+" "+e)}}function wF(a,b,c){if((b=(0,i.m9)(b))instanceof mE)return b._internalPath;if("string"==typeof b)return yF(a,b);throw zF("Field path arguments must be of type string or FieldPath.",a,!1,void 0,c)}const xF=new RegExp("[~\\*/\\[\\]]");function yF(a,b,c){if(b.search(xF)>=0)throw zF(`Invalid field path (${b}). Paths must not contain '~', '*', '/', '[', or ']'`,a,!1,void 0,c);try{return new mE(...b.split("."))._internalPath}catch(d){throw zF(`Invalid field path (${b}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,a,!1,void 0,c)}}function zF(a,b,c,d,e){const f=d&&!d.isEmpty(),g=void 0!==e;let h=`Function ${b}() called with invalid data`;c&&(h+=" (via `toFirestore()`)"),h+=". ";let i="";return(f||g)&&(i+=" (found",f&&(i+=` in field ${d}`),g&&(i+=` in document ${e}`),i+=")"),new z(y.INVALID_ARGUMENT,h+a+i)}function AF(a,b){return a.some(a=>a.isEqual(b))}class BF{constructor(CF,DF,EF,FF,GF){this._firestore=CF,this._userDataWriter=DF,this._key=EF,this._document=FF,this._converter=GF}get id(){return this._key.path.lastSegment()}get ref(){return new vD(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const HF=new KF(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(HF)}return this._userDataWriter.convertValue(this._document.data.value)}}get(IF){if(this._document){const JF=this._document.data.field(LF("DocumentSnapshot.get",IF));if(null!==JF)return this._userDataWriter.convertValue(JF)}}}class KF extends BF{data(){return super.data()}}function LF(a,b){return"string"==typeof b?yF(a,b):b instanceof mE?b._internalPath:b._delegate._internalPath}class MF{constructor(NF,OF){this.hasPendingWrites=NF,this.fromCache=OF}isEqual(PF){return this.hasPendingWrites===PF.hasPendingWrites&&this.fromCache===PF.fromCache}}class QF extends BF{constructor(RF,SF,TF,UF,VF,WF){super(RF,SF,TF,UF,WF),this._firestore=RF,this._firestoreImpl=RF,this.metadata=VF}exists(){return super.exists()}data(XF={}){if(this._document){if(this._converter){const YF=new aG(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(YF,XF)}return this._userDataWriter.convertValue(this._document.data.value,XF.serverTimestamps)}}get(ZF,$F={}){if(this._document){const _F=this._document.data.field(LF("DocumentSnapshot.get",ZF));if(null!==_F)return this._userDataWriter.convertValue(_F,$F.serverTimestamps)}}}class aG extends QF{data(bG={}){return super.data(bG)}}class cG{convertValue(dG,eG="none"){switch(dc(dG)){case 0:return null;case 1:return dG.booleanValue;case 2:return Nb(dG.integerValue||dG.doubleValue);case 3:return this.convertTimestamp(dG.timestampValue);case 4:return this.convertServerTimestamp(dG,eG);case 5:return dG.stringValue;case 6:return this.convertBytes(Ob(dG.bytesValue));case 7:return this.convertReference(dG.referenceValue);case 8:return this.convertGeoPoint(dG.geoPointValue);case 9:return this.convertArray(dG.arrayValue,eG);case 10:return this.convertObject(dG.mapValue,eG);default:throw v()}}convertObject(fG,gG){const hG={};return Ha(fG.fields,(a,b)=>{hG[a]=this.convertValue(b,gG)}),hG}convertGeoPoint(iG){return new yE(Nb(iG.latitude),Nb(iG.longitude))}convertArray(jG,kG){return(jG.values||[]).map(a=>this.convertValue(a,kG))}convertServerTimestamp(lG,mG){switch(mG){case"previous":const nG=Qb(lG);return null==nG?null:this.convertValue(nG,mG);case"estimate":return this.convertTimestamp(Rb(lG));default:return null}}convertTimestamp(oG){const pG=Mb(oG);return new sa(pG.seconds,pG.nanos)}convertDocumentKey(qG,rG){const sG=db.fromString(qG);w(Zj(sG));const tG=new fD(sG.get(1),sG.get(3)),uG=new Vb(sG.popFirst(5));return tG.isEqual(rG)||s(`Document ${uG} contains a document reference within a different database (${tG.projectId}/${tG.database}) which is not supported. It will be treated as a reference in the current database (${rG.projectId}/${rG.database}) instead.`),uG}}function vG(a){a=mD(a,vD);const b=mD(a.firestore,MD);return(function(a,b,c={}){const d=new C;return a.asyncQueue.enqueueAndForget(async()=>(function(a,b,c,d,e){const f=new HC({next:f=>{b.enqueueAndForget(()=>FA(a,g));const h=f.docs.has(c);!h&&f.fromCache?e.reject(new z(y.UNAVAILABLE,"Failed to get document because the client is offline.")):h&&f.fromCache&&d&&"server"===d.source?e.reject(new z(y.UNAVAILABLE,"Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to \"server\" to retrieve the cached document.)")):e.resolve(f)},error:a=>e.reject(a)}),g=new JA(Fe(c.path),f,{includeMetadataChanges:!0,fo:!0});return EA(a,g)})(await XC(a),a.asyncQueue,b,c,d)),d.promise})(kE(b),a._key).then(c=>DG(b,a,c))}class wG extends cG{constructor(xG){super(),this.firestore=xG}convertBytes(yG){return new qE(yG)}convertReference(zG){const AG=this.convertDocumentKey(zG,this.firestore._databaseId);return new vD(this.firestore,null,AG)}}function BG(a,b,c){var d,e,f;a=mD(a,vD);const g=mD(a.firestore,MD),h=(d=a.converter,e=b,f=c,d?f&&(f.merge||f.mergeFields)?d.toFirestore(e,f):d.toFirestore(e):e);return CG(g,[(function(a,b,c,d,e,f={}){const g=a.jc(f.merge||f.mergeFields?2:0,b,c,e);vF("Data must be an object, but it was:",g,d);const h=tF(d,g);let i,j;if(f.merge)i=new yb(g.fieldMask),j=g.fieldTransforms;else if(f.mergeFields){const k=[];for(const l of f.mergeFields){const m=wF(b,l,c);if(!g.contains(m))throw new z(y.INVALID_ARGUMENT,`Field '${m}' is specified in your field mask but missing from your input data.`);AF(k,m)||k.push(m)}i=new yb(k),j=g.fieldTransforms.filter(a=>i.covers(a.field))}else i=null,j=g.fieldTransforms;return new EE(new qc(h),i,j)})(function(a){const b=a._freezeSettings(),c=wx(a._databaseId);return new eF(a._databaseId,!!b.ignoreUndefinedProperties,c)}(g),"setDoc",a._key,h,null!==a.converter,c).toMutation(a._key,nf.none())])}function CG(a,b){return(function(a,b){const c=new C;return a.asyncQueue.enqueueAndForget(async()=>WB(await WC(a).then(a=>a.syncEngine),b,c)),c.promise})(kE(a),b)}function DG(a,b,c){const d=c.docs.get(b._key),e=new wG(a);return new QF(a,e,b._key,d,new MF(c.hasPendingWrites,c.fromCache),b.converter)}!function(a,b=!0){o=f.SDK_VERSION,(0,f._registerComponent)(new g.wA("firestore",(a,{options:c})=>{const d=a.getProvider("app").getImmediate(),e=new MD(d,new J(a.getProvider("auth-internal")));return c=Object.assign({useFetchStreams:b},c),e._setSettings(c),e},"PUBLIC")),(0,f.registerVersion)("@firebase/firestore","3.3.0",void 0),(0,f.registerVersion)("@firebase/firestore","3.3.0","esm2017")}()}}])